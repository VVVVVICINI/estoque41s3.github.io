<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Estoque - SUPER BRUNO ATACADO</title>
    <meta name="theme-color" content="#a00b08">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-red: #a00b08;
            --primary-yellow: #f4cf08;
            --primary-beige: #d8cfc4;
            --primary-dark-red: #4d0505;
            --primary-purple: #9c7c84;
        }
        
        .brand-gradient {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-dark-red) 100%);
        }
        
        .btn-primary {
            background-color: var(--primary-red);
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark-red);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-secondary {
            background-color: var(--primary-yellow);
            color: var(--primary-dark-red);
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #e0c000;
            transform: translateY(-1px);
        }
        
        .status-tag {
            display: inline-block !important;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 2px;
            line-height: 1.2;
            white-space: nowrap;
            border: 1px solid;
            transition: all 0.2s;
        }
        .status-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-mostruario {
            background-color: #fef9e7 !important;
            color: #7d6608 !important;
            border-color: #f4cf08 !important;
        }
        
        .status-embalado {
            background-color: #e8f8ef !important;
            color: #186a3b !important;
            border-color: #2ecc71 !important;
        }
        
        .status-frentedeloja {
            background-color: #e8f4fd !important;
            color: #1a5276 !important;
            border-color: #3498db !important;
        }
        
        .status-separadocd {
            background-color: #f4ecf7 !important;
            color: #6c3483 !important;
            border-color: #9b59b6 !important;
        }
        
        .status-montagem {
            background-color: #ebedef !important;
            color: #2c3e50 !important;
            border-color: #34495e !important;
        }
        
        .status-assistencia {
            background-color: #fdedec !important;
            color: #943126 !important;
            border-color: #e74c3c !important;
        }
        
        .status-default {
            background-color: #f8f9fa !important;
            color: #495057 !important;
            border-color: #dee2e6 !important;
        }

        .history-added {
            background-color: #e8f6f3 !important;
            color: #0d6251 !important;
            border-left: 4px solid #2ecc71 !important;
        }
        
        .history-removed {
            background-color: #fde8e8 !important;
            color: #9b2c2c !important;
            border-left: 4px solid #e53e3e !important;
        }
        
        .history-modified {
            background-color: #fef3e2 !important;
            color: #b45309 !important;
            border-left: 4px solid #ed8936 !important;
        }
        
        .history-stock-up {
            background-color: #e6fffa !important;
            color: #234e52 !important;
            border-left: 4px solid #38b2ac !important;
        }
        
        .history-stock-down {
            background-color: #fff5f5 !important;
            color: #9b2c2c !important;
            border-left: 4px solid #fc8181 !important;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .search-input {
            font-size: 16px !important;
        }

        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        .sortable:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .stat-card {
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .mobile-hidden {
                display: none;
            }
            .mobile-text-sm {
                font-size: 0.875rem;
            }
            .search-input {
                height: 52px;
                padding: 14px 16px;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }
            .print-full-width {
                width: 100% !important;
            }
        }

        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background-color: #e0e0e0;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-badge:hover {
            background-color: #d0d0d0;
        }
        .filter-badge.active {
            background-color: var(--primary-red);
            color: white;
        }

        .tab-button {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button.active {
            background: white;
            color: var(--primary-red);
            font-weight: 600;
            border-color: #dee2e6;
            position: relative;
            z-index: 10;
        }
        .tab-button:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 0 8px 8px 8px;
            background: white;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .history-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }
        .badge-added { background: #d1f7c4; color: #0d6251; }
        .badge-removed { background: #ffe0e0; color: #9b2c2c; }
        .badge-modified { background: #fff4d9; color: #b45309; }
        .badge-stock-up { background: #d1f7f7; color: #234e52; }
        .badge-stock-down { background: #ffe0e0; color: #9b2c2c; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading-spinner w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Conectando com a planilha ao vivo...</p>
                <p class="text-gray-400 text-sm mt-2">Aguarde enquanto carregamos os dados</p>
            </div>
        </div>
    </div>

    <script>
        // üîß CONFIGURA√á√ÉO DA PLANILHA
        const GOOGLE_SHEET_ID = '1zN6WXg-7mkb0mYOV8Hf3stQLD9wAdnyDKSPF5PfYK_M';
        const PUBLISHED_ID = '2PACX-1vTXIBXGqrCkz3-Fg07OBUq5Xv4jrXhpAvIXWrk9GiNoeD_so8qTHaxdPXBRTTOvkN1EUujUtVOPDU8f'; // ID da vers√£o publicada
        const SHEET_NAME = 'P√°gina1'; // ‚ö†Ô∏è AJUSTE O NOME DA ABA AQUI SE NECESS√ÅRIO
        const AUTO_REFRESH_INTERVAL = 30000; // 30 segundos
        const BACKUP_KEY = 'estoque_live_backup';
        const HISTORY_KEY = 'estoque_history';
        const DEBUG_MODE = true; // Ativa logs detalhados
        const USE_PUBLISHED_VERSION = true; // Usar vers√£o publicada (mais est√°vel)
        
        let state = {
            items: [],
            previousItems: [],
            loading: true,
            searchTerm: '',
            filteredItems: [],
            lastUpdate: null,
            connectionError: false,
            sortField: 'codigo',
            sortDirection: 'asc',
            autoRefresh: true,
            syncInterval: null,
            locationFilter: 'all',
            stockFilter: 'all',
            currentTab: 'estoque', // 'estoque' ou 'historico'
            historyFilter: 'all', // 'all', 'added', 'removed', 'modified', 'stock-up', 'stock-down'
            stats: {
                total: 0,
                inStock: 0,
                outOfStock: 0,
                lowStock: 0
            },
            history: [],
            historyStats: {
                today: 0,
                added: 0,
                removed: 0,
                modified: 0
            }
        };

        let searchDebounceTimer = null;

        // üìä BUSCAR DADOS AO VIVO DA PLANILHA
        async function fetchLiveData() {
            try {
                if (DEBUG_MODE) console.log('üîÑ Buscando dados ao vivo...');
                
                // Salvar os itens anteriores para compara√ß√£o
                state.previousItems = [...state.items];
                
                // Escolher entre vers√£o publicada ou vers√£o direta
                let url;
                if (USE_PUBLISHED_VERSION) {
                    url = `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?output=csv&gid=0&t=${Date.now()}`;
                    if (DEBUG_MODE) console.log('üìò Usando vers√£o PUBLICADA');
                } else {
                    url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
                    if (DEBUG_MODE) console.log('üìó Usando vers√£o DIRETA (requer compartilhamento p√∫blico)');
                }
                
                if (DEBUG_MODE) console.log('üîó URL:', url);
                
                const response = await fetch(url, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                
                if (DEBUG_MODE) console.log('üì° Status HTTP:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const csvData = await response.text();
                
                if (DEBUG_MODE) {
                    console.log('üìÑ Dados recebidos:', csvData.length, 'caracteres');
                    console.log('üìù Primeiros 300 caracteres:', csvData.substring(0, 300));
                }
                
                // Verificar erros comuns
                if (!csvData || csvData.trim().length === 0) {
                    throw new Error('‚ùå Planilha vazia ou inacess√≠vel');
                }
                
                if (csvData.includes('autocrat demo job')) {
                    throw new Error('‚ùå ERRO: Planilha n√£o est√° compartilhada publicamente! Mude USE_PUBLISHED_VERSION para true ou compartilhe a planilha.');
                }
                
                if (csvData.includes('Error') || csvData.includes('error')) {
                    throw new Error('‚ùå Erro retornado pela planilha: ' + csvData.substring(0, 100));
                }
                
                if (csvData.length < 20) {
                    throw new Error('‚ùå Dados muito curtos. Verifique se h√° dados na planilha');
                }
                
                const items = parseCSVData(csvData);
                
                if (items.length > 0) {
                    state.items = items;
                    state.connectionError = false;
                    state.lastUpdate = new Date();
                    console.log('‚úÖ Dados ao vivo carregados:', items.length, 'produtos');
                    
                    // Salvar backup local
                    try {
                        localStorage.setItem(BACKUP_KEY, JSON.stringify({
                            items: items,
                            timestamp: Date.now()
                        }));
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao salvar backup:', e);
                    }
                    
                    // Analisar mudan√ßas e registrar no hist√≥rico
                    if (state.previousItems.length > 0) {
                        analyzeChanges(state.previousItems, items);
                    }
                    
                    updateStats();
                    loadHistory();
                    return true;
                } else {
                    throw new Error('Nenhum produto encontrado');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados ao vivo:', error);
                
                // Tentar carregar do backup
                const backupLoaded = loadBackup();
                if (backupLoaded) {
                    state.connectionError = true;
                    updateStats();
                    return true;
                }
                
                return false;
            }
        }

        // üìà ANALISAR MUDAN√áAS ENTRE ATUALIZA√á√ïES
        function analyzeChanges(oldItems, newItems) {
            console.log('üìä Analisando mudan√ßas...');
            
            const changes = [];
            const now = new Date();
            
            // Mapear itens antigos por c√≥digo
            const oldMap = {};
            oldItems.forEach(item => {
                oldMap[item.codigo] = item;
            });
            
            // Mapear itens novos por c√≥digo
            const newMap = {};
            newItems.forEach(item => {
                newMap[item.codigo] = item;
            });
            
            // Encontrar produtos novos (adicionados)
            newItems.forEach(newItem => {
                if (!oldMap[newItem.codigo]) {
                    changes.push({
                        type: 'added',
                        timestamp: now,
                        product: newItem.codigo,
                        name: newItem.nome,
                        details: `Produto adicionado ao estoque`,
                        quantity: newItem.quantidade,
                        platform: newItem.plataforma,
                        notes: newItem.observacoes
                    });
                }
            });
            
            // Encontrar produtos removidos
            oldItems.forEach(oldItem => {
                if (!newMap[oldItem.codigo]) {
                    changes.push({
                        type: 'removed',
                        timestamp: now,
                        product: oldItem.codigo,
                        name: oldItem.nome,
                        details: `Produto removido do estoque`,
                        quantity: 0,
                        platform: oldItem.plataforma,
                        notes: oldItem.observacoes
                    });
                }
            });
            
            // Comparar produtos existentes
            newItems.forEach(newItem => {
                const oldItem = oldMap[newItem.codigo];
                if (oldItem) {
                    // Verificar mudan√ßa na quantidade
                    if (oldItem.quantidade !== newItem.quantidade) {
                        const diff = newItem.quantidade - oldItem.quantidade;
                        changes.push({
                            type: diff > 0 ? 'stock-up' : 'stock-down',
                            timestamp: now,
                            product: newItem.codigo,
                            name: newItem.nome,
                            details: `Estoque alterado: ${oldItem.quantidade} ‚Üí ${newItem.quantidade}`,
                            quantity: newItem.quantidade,
                            oldQuantity: oldItem.quantidade,
                            difference: Math.abs(diff),
                            platform: newItem.plataforma,
                            notes: newItem.observacoes
                        });
                    }
                    
                    // Verificar mudan√ßas em outros campos
                    const fieldsChanged = [];
                    if (oldItem.nome !== newItem.nome) fieldsChanged.push('nome');
                    if (oldItem.plataforma !== newItem.plataforma) fieldsChanged.push('plataforma');
                    if (oldItem.observacoes !== newItem.observacoes) fieldsChanged.push('observa√ß√µes');
                    
                    if (fieldsChanged.length > 0) {
                        changes.push({
                            type: 'modified',
                            timestamp: now,
                            product: newItem.codigo,
                            name: newItem.nome,
                            details: `Campos modificados: ${fieldsChanged.join(', ')}`,
                            quantity: newItem.quantidade,
                            platform: newItem.plataforma,
                            notes: newItem.observacoes,
                            fieldsChanged: fieldsChanged
                        });
                    }
                }
            });
            
            // Adicionar mudan√ßas ao hist√≥rico
            if (changes.length > 0) {
                console.log(`üìù Encontradas ${changes.length} mudan√ßas`);
                changes.forEach(change => {
                    addToHistory(change);
                });
                
                // Mostrar notifica√ß√£o se houver mudan√ßas significativas
                if (changes.length <= 5) {
                    changes.forEach(change => {
                        let emoji = 'üìù';
                        if (change.type === 'added') emoji = 'üÜï';
                        if (change.type === 'removed') emoji = 'üóëÔ∏è';
                        if (change.type === 'stock-up') emoji = 'üìà';
                        if (change.type === 'stock-down') emoji = 'üìâ';
                        
                        showNotification(`${emoji} ${change.details}`, 'info');
                    });
                } else {
                    showNotification(`üìä ${changes.length} mudan√ßas detectadas no estoque`, 'info');
                }
            }
            
            return changes;
        }

        // üìù ADICIONAR ENTRADA AO HIST√ìRICO
        function addToHistory(entry) {
            try {
                // Carregar hist√≥rico existente
                let history = [];
                const savedHistory = localStorage.getItem(HISTORY_KEY);
                if (savedHistory) {
                    history = JSON.parse(savedHistory);
                }
                
                // Adicionar nova entrada
                entry.id = `hist_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                history.unshift(entry); // Adicionar no in√≠cio
                
                // Manter apenas os √∫ltimos 500 registros
                if (history.length > 500) {
                    history = history.slice(0, 500);
                }
                
                // Salvar no localStorage
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                
                // Atualizar hist√≥rico no state
                state.history = history;
                updateHistoryStats();
                
                console.log(`üìù Hist√≥rico atualizado: ${entry.type} - ${entry.product}`);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar no hist√≥rico:', error);
            }
        }

        // üìö CARREGAR HIST√ìRICO
        function loadHistory() {
            try {
                const savedHistory = localStorage.getItem(HISTORY_KEY);
                if (savedHistory) {
                    state.history = JSON.parse(savedHistory);
                    console.log(`üìö Hist√≥rico carregado: ${state.history.length} registros`);
                    updateHistoryStats();
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar hist√≥rico:', error);
            }
            return false;
        }

        // üìä ATUALIZAR ESTAT√çSTICAS DO HIST√ìRICO
        function updateHistoryStats() {
            const today = new Date().toDateString();
            const todayEntries = state.history.filter(entry => 
                new Date(entry.timestamp).toDateString() === today
            );
            
            state.historyStats = {
                today: todayEntries.length,
                added: state.history.filter(entry => entry.type === 'added').length,
                removed: state.history.filter(entry => entry.type === 'removed').length,
                modified: state.history.filter(entry => entry.type === 'modified').length,
                stockUp: state.history.filter(entry => entry.type === 'stock-up').length,
                stockDown: state.history.filter(entry => entry.type === 'stock-down').length
            };
        }

        // üíæ CARREGAR BACKUP
        function loadBackup() {
            try {
                const backup = localStorage.getItem(BACKUP_KEY);
                if (backup) {
                    const data = JSON.parse(backup);
                    const backupAge = Date.now() - data.timestamp;
                    const hoursOld = Math.floor(backupAge / (1000 * 60 * 60));
                    
                    state.items = data.items;
                    state.lastUpdate = new Date(data.timestamp);
                    console.log(`üíæ Backup carregado: ${state.items.length} produtos (${hoursOld}h atr√°s)`);
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar backup:', error);
            }
            return false;
        }

        // üîç ANALISAR DADOS CSV - VERS√ÉO MELHORADA
        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const items = [];
            
            console.log('üìã Total de linhas:', lines.length);
            
            // Pular cabe√ßalho e processar dados
            for (let i = 1; i < lines.length; i++) {
                try {
                    const cells = parseCSVLine(lines[i]);
                    
                    if (cells.length < 3) continue;
                    
                    const codigo = cells[0]?.trim() || '';
                    const nome = cells[1]?.trim() || '';
                    const quantidade = parseInt(cells[2]) || 0;
                    const plataforma = cells[3]?.trim() || 'N√£o informado';
                    const observacoes = cells[4]?.trim() || '';
                    
                    if (codigo && nome) {
                        items.push({
                            id: `item_${i}_${Date.now()}`,
                            codigo,
                            nome,
                            quantidade,
                            plataforma,
                            observacoes,
                            data_entrada: new Date().toISOString().split('T')[0],
                            updated_at: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro na linha ${i}:`, error);
                }
            }
            
            console.log('üéØ Produtos processados:', items.length);
            return items;
        }

        // üìù PARSER CSV ROBUSTO
        function parseCSVLine(line) {
            const cells = [];
            let current = '';
            let inQuotes = false;
            let quoteChar = null;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if ((char === '"' || char === "'") && !inQuotes) {
                    inQuotes = true;
                    quoteChar = char;
                } else if (char === quoteChar && inQuotes) {
                    if (nextChar === quoteChar) {
                        current += char;
                        i++;
                    } else {
                        inQuotes = false;
                        quoteChar = null;
                    }
                } else if (char === ',' && !inQuotes) {
                    cells.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            cells.push(current.trim());
            return cells.map(cell => cell.replace(/^["']|["']$/g, ''));
        }

        // üìä ATUALIZAR ESTAT√çSTICAS
        function updateStats() {
            const total = state.items.length;
            const inStock = state.items.filter(i => i.quantidade > 0).length;
            const outOfStock = state.items.filter(i => i.quantidade === 0).length;
            const lowStock = state.items.filter(i => i.quantidade > 0 && i.quantidade <= 3).length;
            
            state.stats = { total, inStock, outOfStock, lowStock };
        }

        // üîÑ SINCRONIZA√á√ÉO AUTOM√ÅTICA - VERS√ÉO CORRIGIDA
        async function syncWithSheet(silent = false) {
            const wasLoading = state.loading;
            
            // Se for atualiza√ß√£o silenciosa (autom√°tica), n√£o mostra loading na interface completa
            if (!silent) {
                state.loading = true;
                render(); // S√≥ renderiza completamente se N√ÉO for silencioso
            }
            
            const success = await fetchLiveData();
            
            state.loading = false;
            
            if (!success) {
                if (!silent) {
                    showNotification('‚ùå Erro ao conectar. Usando dados salvos.', 'error');
                }
            } else if (!wasLoading && !silent) {
                showNotification('‚úÖ Dados atualizados!', 'success');
            }
            
            applySortingAndFiltering();
            
            // Se for atualiza√ß√£o silenciosa, atualiza apenas os componentes que mudam
            if (silent) {
                updateDynamicComponents();
            } else {
                render(); // Renderiza√ß√£o completa apenas para atualiza√ß√µes manuais
            }
        }

        // üîÑ ATUALIZAR APENAS OS COMPONENTES DIN√ÇMICOS
        function updateDynamicComponents() {
            // Atualizar estat√≠sticas do estoque
            updateStatsDisplay();
            
            // Atualizar contador de produtos
            updateProductCount();
            
            // Atualizar tabela de produtos
            updateProductTable();
            
            // Atualizar tempo da √∫ltima atualiza√ß√£o
            updateLastUpdateTime();
            
            // Atualizar status do sistema
            updateSystemStatus();
            
            // Se estiver na aba de hist√≥rico, atualizar tamb√©m
            if (state.currentTab === 'historico') {
                updateHistoryDisplay();
            }
        }

        // üìä ATUALIZAR EXIBI√á√ÉO DAS ESTAT√çSTICAS
        function updateStatsDisplay() {
            const statsContainer = document.querySelector('.grid.grid-cols-2.md\\:grid-cols-4.gap-4.mb-6');
            if (statsContainer && state.currentTab === 'estoque') {
                statsContainer.innerHTML = `
                    <div class="stat-card bg-white rounded-lg p-4 shadow">
                        <div class="text-gray-500 text-sm font-medium">Total</div>
                        <div class="text-2xl font-bold text-red-600">${state.stats.total}</div>
                        <div class="text-xs text-gray-400">produtos</div>
                    </div>
                    <div class="stat-card bg-white rounded-lg p-4 shadow">
                        <div class="text-gray-500 text-sm font-medium">Em Estoque</div>
                        <div class="text-2xl font-bold text-green-600">${state.stats.inStock}</div>
                        <div class="text-xs text-gray-400">dispon√≠veis</div>
                    </div>
                    <div class="stat-card bg-white rounded-lg p-4 shadow">
                        <div class="text-gray-500 text-sm font-medium">Esgotados</div>
                        <div class="text-2xl font-bold text-orange-600">${state.stats.outOfStock}</div>
                        <div class="text-xs text-gray-400">sem estoque</div>
                    </div>
                    <div class="stat-card bg-white rounded-lg p-4 shadow">
                        <div class="text-gray-500 text-sm font-medium">Estoque Baixo</div>
                        <div class="text-2xl font-bold text-yellow-600">${state.stats.lowStock}</div>
                        <div class="text-xs text-gray-400">‚â§ 3 unidades</div>
                    </div>
                `;
            }
        }

        // üî¢ ATUALIZAR CONTADOR DE PRODUTOS
        function updateProductCount() {
            const countElement = document.querySelector('.mt-4.pt-4.border-t.border-gray-200 .text-gray-600');
            if (countElement && state.currentTab === 'estoque') {
                countElement.innerHTML = `üìä Mostrando <span class="font-bold text-red-600">${state.filteredItems.length}</span> de <span class="font-bold">${state.items.length}</span> produtos`;
            }
        }

        // üìã ATUALIZAR TABELA DE PRODUTOS
        function updateProductTable() {
            if (state.currentTab !== 'estoque') return;
            
            const tbody = document.querySelector('tbody');
            if (!tbody) return;
            
            if (state.filteredItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-12 text-center">
                            <div class="text-gray-400 text-4xl mb-3">üì¶</div>
                            <div class="text-gray-600 font-medium mb-1">
                                ${state.searchTerm || state.locationFilter !== 'all' || state.stockFilter !== 'all' ? 
                                    'Nenhum produto encontrado com os filtros aplicados' : 
                                    'Nenhum produto cadastrado'}
                            </div>
                            <div class="text-gray-400 text-sm">
                                ${state.searchTerm || state.locationFilter !== 'all' || state.stockFilter !== 'all' ? 
                                    'Tente ajustar os filtros ou buscar por outros termos' : 
                                    'Aguardando sincroniza√ß√£o com a planilha'}
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = state.filteredItems.map((item, index) => `
                    <tr class="hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                        <td class="px-3 py-3 md:px-4 md:py-4">
                            <div class="font-mono font-bold text-red-700 text-sm md:text-base">
                                ${item.codigo}
                            </div>
                        </td>
                        <td class="px-3 py-3 md:px-4 md:py-4">
                            <div class="font-medium text-gray-900 text-sm md:text-base">
                                ${item.nome}
                            </div>
                        </td>
                        <td class="px-3 py-3 md:px-4 md:py-4 text-center">
                            <span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-sm font-bold
                                ${item.quantidade === 0 ? 'bg-red-100 text-red-700' : 
                                  item.quantidade <= 3 ? 'bg-yellow-100 text-yellow-700' : 
                                  'bg-green-100 text-green-700'}">
                                ${item.quantidade}
                            </span>
                        </td>
                        <td class="px-3 py-3 md:px-4 md:py-4 mobile-hidden">
                            <span class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">
                                ${item.plataforma}
                            </span>
                        </td>
                        <td class="px-3 py-3 md:px-4 md:py-4">
                            <div class="flex flex-wrap gap-1">
                                ${formatObservacoes(item.observacoes)}
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // üïí ATUALIZAR TEMPO DA √öLTIMA ATUALIZA√á√ÉO
        function updateLastUpdateTime() {
            const timeElements = document.querySelectorAll('.text-gray-500');
            timeElements.forEach(element => {
                if (element.textContent.includes('üïí')) {
                    element.innerHTML = `üïí ${getTimeSinceUpdate()}`;
                }
            });
        }

        // üîÑ ATUALIZAR STATUS DO SISTEMA
        function updateSystemStatus() {
            const footerStatus = document.querySelector('footer .flex.items-center.gap-2');
            if (footerStatus) {
                footerStatus.innerHTML = `
                    <div class="flex items-center gap-2">
                        ${state.connectionError ? 
                            '<span class="text-orange-600">‚ö†Ô∏è Modo Offline - Usando backup local</span>' :
                            '<span class="text-green-600">‚úÖ Sistema Online</span>'}
                    </div>
                    <div class="hidden md:block text-gray-300">|</div>
                    <div>
                        üîÑ Atualiza√ß√£o: ${state.autoRefresh ? 'Autom√°tica (30s)' : 'Manual'}
                    </div>
                    <div class="hidden md:block text-gray-300">|</div>
                    <div>
                        üìä ${state.items.length} produtos cadastrados
                    </div>
                    ${state.historyStats.today > 0 ? `
                        <div class="hidden md:block text-gray-300">|</div>
                        <div class="text-blue-600">
                            üìù ${state.historyStats.today} mudan√ßas hoje
                        </div>
                    ` : ''}
                `;
            }
            
            // Atualizar tamb√©m a data da √∫ltima sincroniza√ß√£o
            const lastSyncElement = document.querySelector('footer .mt-2.text-xs.text-gray-400');
            if (lastSyncElement && state.lastUpdate) {
                lastSyncElement.textContent = `√öltima sincroniza√ß√£o: ${state.lastUpdate.toLocaleString('pt-BR')}`;
            }
        }

        // üìù ATUALIZAR EXIBI√á√ÉO DO HIST√ìRICO
        function updateHistoryDisplay() {
            const historyContent = document.getElementById('historyContent');
            if (!historyContent) return;
            
            // Filtrar hist√≥rico
            let filteredHistory = [...state.history];
            if (state.historyFilter !== 'all') {
                filteredHistory = state.history.filter(entry => entry.type === state.historyFilter);
            }
            
            if (filteredHistory.length === 0) {
                historyContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-gray-400 text-4xl mb-3">üìù</div>
                        <div class="text-gray-600 font-medium mb-1">
                            ${state.historyFilter !== 'all' ? 
                                'Nenhum registro encontrado com este filtro' : 
                                'Nenhum hist√≥rico dispon√≠vel'}
                        </div>
                        <div class="text-gray-400 text-sm">
                            ${state.historyFilter !== 'all' ? 
                                'Tente ajustar os filtros' : 
                                'As mudan√ßas no estoque aparecer√£o aqui automaticamente'}
                        </div>
                    </div>
                `;
            } else {
                historyContent.innerHTML = filteredHistory.map(entry => `
                    <div class="history-item p-4 mb-3 rounded-lg ${getHistoryItemClass(entry.type)}">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="history-badge ${getHistoryBadgeClass(entry.type)}">
                                        ${getHistoryTypeLabel(entry.type)}
                                    </span>
                                    <span class="font-mono font-bold text-gray-800">${entry.product}</span>
                                    <span class="font-medium text-gray-700">${entry.name}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-1">${entry.details}</div>
                                <div class="flex flex-wrap gap-2 text-xs text-gray-500">
                                    ${entry.platform ? `<span>üì± ${entry.platform}</span>` : ''}
                                    ${entry.quantity !== undefined ? `<span>üì¶ Estoque: ${entry.quantity}</span>` : ''}
                                    ${entry.oldQuantity !== undefined ? `<span>üîÅ De: ${entry.oldQuantity}</span>` : ''}
                                    ${entry.difference !== undefined ? `<span>${entry.type === 'stock-up' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'} ${entry.difference} unidades</span>` : ''}
                                </div>
                            </div>
                            <div class="text-xs text-gray-400 whitespace-nowrap">
                                ${formatHistoryDate(entry.timestamp)}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // üé® OBTER CLASSE CSS PARA ITEM DO HIST√ìRICO
        function getHistoryItemClass(type) {
            switch(type) {
                case 'added': return 'history-added';
                case 'removed': return 'history-removed';
                case 'modified': return 'history-modified';
                case 'stock-up': return 'history-stock-up';
                case 'stock-down': return 'history-stock-down';
                default: return 'bg-gray-50';
            }
        }

        // üè∑Ô∏è OBTER CLASSE CSS PARA BADGE DO HIST√ìRICO
        function getHistoryBadgeClass(type) {
            switch(type) {
                case 'added': return 'badge-added';
                case 'removed': return 'badge-removed';
                case 'modified': return 'badge-modified';
                case 'stock-up': return 'badge-stock-up';
                case 'stock-down': return 'badge-stock-down';
                default: return 'bg-gray-200';
            }
        }

        // üè∑Ô∏è OBTER LABEL PARA TIPO DE HIST√ìRICO
        function getHistoryTypeLabel(type) {
            switch(type) {
                case 'added': return 'ADICIONADO';
                case 'removed': return 'REM OVIDO';
                case 'modified': return 'MODIFICADO';
                case 'stock-up': return 'ESTOQUE +';
                case 'stock-down': return 'ESTOQUE -';
                default: return 'ALTERA√á√ÉO';
            }
        }

        // üìÖ FORMATAR DATA DO HIST√ìRICO
        function formatHistoryDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `h√° ${diffMins} min`;
            } else if (diffHours < 24) {
                return `h√° ${diffHours}h`;
            } else if (diffDays === 1) {
                return 'ontem';
            } else if (diffDays < 7) {
                return `h√° ${diffDays} dias`;
            } else {
                return date.toLocaleDateString('pt-BR');
            }
        }

        // üé® FORMATAR OBSERVA√á√ïES
        function formatObservacoes(observacoes) {
            if (!observacoes || observacoes.trim() === '') {
                return '<span class="status-tag status-default">Sem informa√ß√µes</span>';
            }

            const textoLimpo = observacoes.trim();
            const partes = textoLimpo.split(/[,\.]| e |\//).filter(p => p.trim());
            
            if (partes.length === 0) partes.push(textoLimpo);
            
            return partes.map(parte => {
                const texto = parte.trim().toLowerCase();
                let statusClass = 'status-default';
                
                const statusMap = {
                    'status-mostruario': ['mostruario', 'mostru√°rio', 'amostra', 'vitrine'],
                    'status-embalado': ['embalado', 'caixa', 'box', 'lacrado'],
                    'status-frentedeloja': ['frente', 'loja', 'vitrine', 'exposi', 'prateleira'],
                    'status-separadocd': ['separado', 'cd', 'centro', 'distribui', 'deposito', 'dep√≥sito'],
                    'status-montagem': ['montar', 'montagem', 'montado', 'armar', 'desmontado'],
                    'status-assistencia': ['assistencia', 'assist√™ncia', 'conserto', 'reparo', 'manuten', 'defeito']
                };
                
                for (const [className, keywords] of Object.entries(statusMap)) {
                    if (keywords.some(keyword => texto.includes(keyword))) {
                        statusClass = className;
                        break;
                    }
                }

                return `<span class="status-tag ${statusClass}">${parte.trim()}</span>`;
            }).join(' ');
        }

        // üîç BUSCA COM DEBOUNCE
        function handleSearchInput(event) {
            const value = event.target.value;
            
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                state.searchTerm = value;
                applySortingAndFiltering();
                render();
            }, 300);
        }

        function clearSearch() {
            state.searchTerm = '';
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = '';
            applySortingAndFiltering();
            render();
        }

        // üîÑ ORDENA√á√ÉO
        function sortBy(field) {
            if (state.sortField === field) {
                state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                state.sortField = field;
                state.sortDirection = 'asc';
            }
            applySortingAndFiltering();
            render();
        }

        function getSortIcon(field) {
            if (state.sortField !== field) return '‚ÜïÔ∏è';
            return state.sortDirection === 'asc' ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
        }

        // üéØ FILTROS AVAN√áADOS
        function setLocationFilter(filter) {
            state.locationFilter = filter;
            applySortingAndFiltering();
            render();
        }

        function setStockFilter(filter) {
            state.stockFilter = filter;
            applySortingAndFiltering();
            render();
        }

        // üìä FILTROS DE HIST√ìRICO
        function setHistoryFilter(filter) {
            state.historyFilter = filter;
            updateHistoryDisplay();
        }

        // üîç APLICAR FILTROS E ORDENA√á√ÉO
        function applySortingAndFiltering() {
            const term = state.searchTerm.toLowerCase().trim();
            
            // Filtrar por busca
            let filtered = term ? 
                state.items.filter(item => 
                    item.codigo.toLowerCase().includes(term) ||
                    item.nome.toLowerCase().includes(term) ||
                    item.plataforma.toLowerCase().includes(term) ||
                    (item.observacoes && item.observacoes.toLowerCase().includes(term))
                ) : [...state.items];
            
            // Filtrar por localiza√ß√£o
            if (state.locationFilter !== 'all') {
                filtered = filtered.filter(item => {
                    const obs = item.observacoes.toLowerCase();
                    switch(state.locationFilter) {
                        case 'mostruario': return obs.includes('mostruario') || obs.includes('mostru√°rio');
                        case 'embalado': return obs.includes('embalado') || obs.includes('caixa');
                        case 'frente': return obs.includes('frente') || obs.includes('loja');
                        case 'cd': return obs.includes('separado') || obs.includes('cd');
                        case 'montagem': return obs.includes('montagem') || obs.includes('montar');
                        case 'assistencia': return obs.includes('assistencia') || obs.includes('assist√™ncia');
                        default: return true;
                    }
                });
            }
            
            // Filtrar por estoque
            if (state.stockFilter !== 'all') {
                filtered = filtered.filter(item => {
                    switch(state.stockFilter) {
                        case 'in': return item.quantidade > 0;
                        case 'out': return item.quantidade === 0;
                        case 'low': return item.quantidade > 0 && item.quantidade <= 3;
                        default: return true;
                    }
                });
            }
            
            // Ordenar
            filtered.sort((a, b) => {
                let valueA, valueB;
                
                switch (state.sortField) {
                    case 'codigo':
                        valueA = a.codigo.toLowerCase();
                        valueB = b.codigo.toLowerCase();
                        break;
                    case 'nome':
                        valueA = a.nome.toLowerCase();
                        valueB = b.nome.toLowerCase();
                        break;
                    case 'quantidade':
                        valueA = a.quantidade;
                        valueB = b.quantidade;
                        break;
                    case 'plataforma':
                        valueA = a.plataforma.toLowerCase();
                        valueB = b.plataforma.toLowerCase();
                        break;
                    default:
                        valueA = a.codigo.toLowerCase();
                        valueB = b.codigo.toLowerCase();
                }
                
                if (state.sortDirection === 'asc') {
                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
                } else {
                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
                }
            });
            
            state.filteredItems = filtered;
        }

        // üì¢ NOTIFICA√á√ÉO MELHORADA
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-orange-500',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification-enter fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="text-white hover:text-gray-200 font-bold text-xl leading-none">√ó</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }

        // üïí TEMPO DESDE ATUALIZA√á√ÉO
        function getTimeSinceUpdate() {
            if (!state.lastUpdate) return 'Nunca';
            
            const diff = Date.now() - state.lastUpdate.getTime();
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (seconds < 60) return 'Agora mesmo';
            if (minutes < 60) return `${minutes}min atr√°s`;
            if (hours < 24) return `${hours}h atr√°s`;
            return state.lastUpdate.toLocaleDateString('pt-BR');
        }

        // üîÑ MUDAR ABA
        function switchTab(tabName) {
            state.currentTab = tabName;
            render();
        }

        // ‚öôÔ∏è AUTO REFRESH
        function toggleAutoRefresh() {
            state.autoRefresh = !state.autoRefresh;
            
            if (state.autoRefresh) {
                state.syncInterval = setInterval(() => {
                    syncWithSheet(true); // Silencioso para atualiza√ß√µes autom√°ticas
                }, AUTO_REFRESH_INTERVAL);
                showNotification('üîÑ Atualiza√ß√£o autom√°tica ativada (30s)', 'success');
                
                // Fazer uma atualiza√ß√£o silenciosa imediata
                setTimeout(() => syncWithSheet(true), 100);
            } else {
                if (state.syncInterval) {
                    clearInterval(state.syncInterval);
                    state.syncInterval = null;
                }
                showNotification('‚è∏Ô∏è Atualiza√ß√£o autom√°tica pausada', 'warning');
            }
            
            // Atualizar apenas o bot√£o de auto-refresh
            updateAutoRefreshButton();
            updateSystemStatus();
        }

        // üîÑ ATUALIZAR BOT√ÉO DE AUTO-REFRESH
        function updateAutoRefreshButton() {
            const autoRefreshBtn = document.querySelector('button[onclick="toggleAutoRefresh()"]');
            if (autoRefreshBtn) {
                autoRefreshBtn.className = state.autoRefresh ? 
                    'btn-secondary px-4 py-2 rounded-lg font-medium' : 
                    'bg-gray-500 text-white px-4 py-2 rounded-lg font-medium';
                autoRefreshBtn.innerHTML = state.autoRefresh ? 'üîÑ Auto' : '‚è∏Ô∏è Manual';
            }
        }

        // üì§ EXPORTAR DADOS
        function exportToCSV() {
            const headers = ['C√≥digo', 'Nome', 'Quantidade', 'Plataforma', 'Observa√ß√µes'];
            const rows = state.filteredItems.map(item => [
                item.codigo,
                item.nome,
                item.quantidade,
                item.plataforma,
                item.observacoes
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `estoque_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('üì• Arquivo CSV exportado!', 'success');
        }

        // üì§ EXPORTAR HIST√ìRICO
        function exportHistory() {
            const headers = ['Data/Hora', 'Tipo', 'C√≥digo', 'Nome', 'Detalhes', 'Quantidade', 'Plataforma'];
            const rows = state.history.map(entry => [
                new Date(entry.timestamp).toLocaleString('pt-BR'),
                getHistoryTypeLabel(entry.type),
                entry.product,
                entry.name,
                entry.details,
                entry.quantity || '',
                entry.platform || ''
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `historico_estoque_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('üì• Hist√≥rico exportado!', 'success');
        }

        // üóëÔ∏è LIMPAR HIST√ìRICO
        function clearHistory() {
            if (confirm('Tem certeza que deseja limpar todo o hist√≥rico? Esta a√ß√£o n√£o pode ser desfeita.')) {
                localStorage.removeItem(HISTORY_KEY);
                state.history = [];
                updateHistoryStats();
                updateHistoryDisplay();
                showNotification('üóëÔ∏è Hist√≥rico limpo com sucesso', 'success');
            }
        }

        // üñ®Ô∏è IMPRIMIR
        function printTable() {
            window.print();
        }

        // üéØ INICIALIZA√á√ÉO
        async function initApp() {
            console.log('üöÄ Iniciando sistema ao vivo...');
            
            // Carregar hist√≥rico primeiro
            loadHistory();
            
            await syncWithSheet();
            
            if (state.autoRefresh) {
                state.syncInterval = setInterval(() => {
                    syncWithSheet(true); // Usar modo silencioso para atualiza√ß√µes autom√°ticas
                }, AUTO_REFRESH_INTERVAL);
            }
            
            if (!state.connectionError) {
                showNotification('‚úÖ Sistema online! Atualizando a cada 30s', 'success');
            }
        }

        // üé® RENDERIZA√á√ÉO PRINCIPAL
        function render() {
            if (state.loading && state.items.length === 0) return;
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- HEADER -->
                <header class="brand-gradient shadow-lg no-print">
                    <div class="container mx-auto px-4 py-4">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                                <div class="brand-gradient rounded-xl p-3 text-white font-bold text-xl shadow-md">
                                    <span class="text-white">SUPER</span>
                                    <span class="text-yellow-300 ml-1">BRUNO</span>
                                </div>
                                <div>
                                    <h1 class="text-white text-xl md:text-2xl font-bold">Mapa de Estoque</h1>
                                    <p class="text-yellow-200 text-sm flex items-center gap-2">
                                        ${state.connectionError ? 
                                            '<span class="pulse">‚ö†Ô∏è Modo Offline</span>' : 
                                            '<span>‚úÖ Ao Vivo</span>'}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <button onclick="toggleAutoRefresh()" 
                                        class="${state.autoRefresh ? 'btn-secondary' : 'bg-gray-500 text-white'} px-4 py-2 rounded-lg font-medium">
                                    ${state.autoRefresh ? 'üîÑ Auto' : '‚è∏Ô∏è Manual'}
                                </button>
                                <button onclick="syncWithSheet()" 
                                        class="btn-primary px-4 py-2 rounded-lg font-medium"
                                        ${state.loading ? 'disabled' : ''}>
                                    ${state.loading ? '‚è≥' : 'üîÑ'} Atualizar
                                </button>
                                <button onclick="exportToCSV()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- MAIN CONTENT -->
                <main class="container mx-auto px-2 md:px-4 py-4 md:py-6">
                    <!-- ABAS -->
                    <div class="flex mb-6 border-b border-gray-200 no-print">
                        <button class="tab-button ${state.currentTab === 'estoque' ? 'active' : ''}" 
                                onclick="switchTab('estoque')">
                            üì¶ Estoque (${state.stats.total})
                        </button>
                        <button class="tab-button ${state.currentTab === 'historico' ? 'active' : ''}" 
                                onclick="switchTab('historico')">
                            üìù Hist√≥rico ${state.historyStats.today > 0 ? `(${state.historyStats.today} hoje)` : ''}
                        </button>
                    </div>

                    <!-- CONTE√öDO DA ABA DE ESTOQUE -->
                    <div class="tab-content ${state.currentTab === 'estoque' ? 'active' : ''}" id="estoqueContent">
                        <!-- ESTAT√çSTICAS -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Total</div>
                                <div class="text-2xl font-bold text-red-600">${state.stats.total}</div>
                                <div class="text-xs text-gray-400">produtos</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Em Estoque</div>
                                <div class="text-2xl font-bold text-green-600">${state.stats.inStock}</div>
                                <div class="text-xs text-gray-400">dispon√≠veis</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Esgotados</div>
                                <div class="text-2xl font-bold text-orange-600">${state.stats.outOfStock}</div>
                                <div class="text-xs text-gray-400">sem estoque</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Estoque Baixo</div>
                                <div class="text-2xl font-bold text-yellow-600">${state.stats.lowStock}</div>
                                <div class="text-xs text-gray-400">‚â§ 3 unidades</div>
                            </div>
                        </div>

                        <!-- BUSCA E FILTROS -->
                        <div class="bg-white rounded-lg p-4 mb-6 shadow">
                            <div class="relative mb-4">
                                <input type="text" 
                                       id="searchInput"
                                       placeholder="üîç Buscar por c√≥digo, nome, plataforma ou localiza√ß√£o..."
                                       value="${state.searchTerm}"
                                       oninput="handleSearchInput(event)"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent search-input">
                                
                                ${state.searchTerm ? `
                                    <button onclick="clearSearch()" 
                                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center">
                                        √ó
                                    </button>
                                ` : ''}
                            </div>

                            <!-- FILTROS R√ÅPIDOS -->
                            <div class="space-y-3">
                                <div>
                                    <div class="text-sm font-medium text-gray-700 mb-2">üìç Localiza√ß√£o:</div>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="setLocationFilter('all')" 
                                                class="filter-badge ${state.locationFilter === 'all' ? 'active' : ''}">
                                            Todas
                                        </button>
                                        <button onclick="setLocationFilter('mostruario')" 
                                                class="filter-badge ${state.locationFilter === 'mostruario' ? 'active' : ''}">
                                            üé® Mostru√°rio
                                        </button>
                                        <button onclick="setLocationFilter('embalado')" 
                                                class="filter-badge ${state.locationFilter === 'embalado' ? 'active' : ''}">
                                            üì¶ Embalado
                                        </button>
                                        <button onclick="setLocationFilter('frente')" 
                                                class="filter-badge ${state.locationFilter === 'frente' ? 'active' : ''}">
                                            üè™ Frente de Loja
                                        </button>
                                        <button onclick="setLocationFilter('cd')" 
                                                class="filter-badge ${state.locationFilter === 'cd' ? 'active' : ''}">
                                            üè≠ CD
                                        </button>
                                        <button onclick="setLocationFilter('montagem')" 
                                                class="filter-badge ${state.locationFilter === 'montagem' ? 'active' : ''}">
                                            üîß Montagem
                                        </button>
                                        <button onclick="setLocationFilter('assistencia')" 
                                                class="filter-badge ${state.locationFilter === 'assistencia' ? 'active' : ''}">
                                            üî® Assist√™ncia
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <div class="text-sm font-medium text-gray-700 mb-2">üìä Estoque:</div>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="setStockFilter('all')" 
                                                class="filter-badge ${state.stockFilter === 'all' ? 'active' : ''}">
                                            Todos
                                        </button>
                                        <button onclick="setStockFilter('in')" 
                                                class="filter-badge ${state.stockFilter === 'in' ? 'active' : ''}">
                                            ‚úÖ Dispon√≠vel
                                        </button>
                                        <button onclick="setStockFilter('low')" 
                                                class="filter-badge ${state.stockFilter === 'low' ? 'active' : ''}">
                                            ‚ö†Ô∏è Baixo (‚â§3)
                                        </button>
                                        <button onclick="setStockFilter('out')" 
                                                class="filter-badge ${state.stockFilter === 'out' ? 'active' : ''}">
                                            ‚ùå Esgotado
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-sm">
                                <div class="text-gray-600">
                                    üìä Mostrando <span class="font-bold text-red-600">${state.filteredItems.length}</span> de <span class="font-bold">${state.items.length}</span> produtos
                                </div>
                                <div class="text-gray-500">
                                    üïí ${getTimeSinceUpdate()}
                                </div>
                            </div>
                        </div>

                        <!-- TABELA DE PRODUTOS -->
                        <div class="bg-white rounded-lg shadow overflow-hidden fade-in">
                            <div class="overflow-x-auto">
                                <table class="w-full print-full-width">
                                    <thead>
                                        <tr class="bg-gradient-to-r from-red-700 to-red-900 text-white">
                                            <th class="px-3 py-3 md:px-4 md:py-3 text-left sortable" onclick="sortBy('codigo')">
                                                <div class="flex items-center gap-1">
                                                    <span>C√≥digo</span>
                                                    <span class="text-xs">${getSortIcon('codigo')}</span>
                                                </div>
                                            </th>
                                            <th class="px-3 py-3 md:px-4 md:py-3 text-left sortable" onclick="sortBy('nome')">
                                                <div class="flex items-center gap-1">
                                                    <span>Nome do Produto</span>
                                                    <span class="text-xs">${getSortIcon('nome')}</span>
                                                </div>
                                            </th>
                                            <th class="px-3 py-3 md:px-4 md:py-3 text-center sortable" onclick="sortBy('quantidade')">
                                                <div class="flex items-center justify-center gap-1">
                                                    <span>Qtd</span>
                                                    <span class="text-xs">${getSortIcon('quantidade')}</span>
                                                </div>
                                            </th>
                                            <th class="px-3 py-3 md:px-4 md:py-3 text-left sortable mobile-hidden" onclick="sortBy('plataforma')">
                                                <div class="flex items-center gap-1">
                                                    <span>Plataforma</span>
                                                    <span class="text-xs">${getSortIcon('plataforma')}</span>
                                                </div>
                                            </th>
                                            <th class="px-3 py-3 md:px-4 md:py-3 text-left">
                                                Localiza√ß√£o
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200">
                                        ${state.filteredItems.length === 0 ? `
                                            <tr>
                                                <td colspan="5" class="px-4 py-12 text-center">
                                                    <div class="text-gray-400 text-4xl mb-3">üì¶</div>
                                                    <div class="text-gray-600 font-medium mb-1">
                                                        ${state.searchTerm || state.locationFilter !== 'all' || state.stockFilter !== 'all' ? 
                                                            'Nenhum produto encontrado com os filtros aplicados' : 
                                                            'Nenhum produto cadastrado'}
                                                    </div>
                                                    <div class="text-gray-400 text-sm">
                                                        ${state.searchTerm || state.locationFilter !== 'all' || state.stockFilter !== 'all' ? 
                                                            'Tente ajustar os filtros ou buscar por outros termos' : 
                                                            'Aguardando sincroniza√ß√£o com a planilha'}
                                                    </div>
                                                </td>
                                            </tr>
                                        ` : ''}
                                        
                                        ${state.filteredItems.map((item, index) => `
                                            <tr class="hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                                <td class="px-3 py-3 md:px-4 md:py-4">
                                                    <div class="font-mono font-bold text-red-700 text-sm md:text-base">
                                                        ${item.codigo}
                                                    </div>
                                                </td>
                                                <td class="px-3 py-3 md:px-4 md:py-4">
                                                    <div class="font-medium text-gray-900 text-sm md:text-base">
                                                        ${item.nome}
                                                    </div>
                                                </td>
                                                <td class="px-3 py-3 md:px-4 md:py-4 text-center">
                                                    <span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-sm font-bold
                                                        ${item.quantidade === 0 ? 'bg-red-100 text-red-700' : 
                                                          item.quantidade <= 3 ? 'bg-yellow-100 text-yellow-700' : 
                                                          'bg-green-100 text-green-700'}">
                                                        ${item.quantidade}
                                                    </span>
                                                </td>
                                                <td class="px-3 py-3 md:px-4 md:py-4 mobile-hidden">
                                                    <span class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">
                                                        ${item.plataforma}
                                                    </span>
                                                </td>
                                                <td class="px-3 py-3 md:px-4 md:py-4">
                                                    <div class="flex flex-wrap gap-1">
                                                        ${formatObservacoes(item.observacoes)}
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- CONTE√öDO DA ABA DE HIST√ìRICO -->
                    <div class="tab-content ${state.currentTab === 'historico' ? 'active' : ''}" id="historicoContent">
                        <!-- ESTAT√çSTICAS DO HIST√ìRICO -->
                        <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Hoje</div>
                                <div class="text-2xl font-bold text-blue-600">${state.historyStats.today}</div>
                                <div class="text-xs text-gray-400">mudan√ßas</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Adicionados</div>
                                <div class="text-2xl font-bold text-green-600">${state.historyStats.added}</div>
                                <div class="text-xs text-gray-400">produtos</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Removidos</div>
                                <div class="text-2xl font-bold text-red-600">${state.historyStats.removed}</div>
                                <div class="text-xs text-gray-400">produtos</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Modificados</div>
                                <div class="text-2xl font-bold text-orange-600">${state.historyStats.modified}</div>
                                <div class="text-xs text-gray-400">produtos</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Estoque +</div>
                                <div class="text-2xl font-bold text-teal-600">${state.historyStats.stockUp || 0}</div>
                                <div class="text-xs text-gray-400">aumentos</div>
                            </div>
                            <div class="stat-card bg-white rounded-lg p-4 shadow">
                                <div class="text-gray-500 text-sm font-medium">Estoque -</div>
                                <div class="text-2xl font-bold text-pink-600">${state.historyStats.stockDown || 0}</div>
                                <div class="text-xs text-gray-400">redu√ß√µes</div>
                            </div>
                        </div>

                        <!-- CONTROLES DO HIST√ìRICO -->
                        <div class="bg-white rounded-lg p-4 mb-6 shadow">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                                <div>
                                    <h3 class="font-bold text-gray-800 mb-2">üìù Filtros do Hist√≥rico</h3>
                                    <div class="flex flex-wrap gap-2">
                                        <button onclick="setHistoryFilter('all')" 
                                                class="filter-badge ${state.historyFilter === 'all' ? 'active' : ''}">
                                            Todos
                                        </button>
                                        <button onclick="setHistoryFilter('added')" 
                                                class="filter-badge ${state.historyFilter === 'added' ? 'active' : ''}">
                                            üÜï Adicionados
                                        </button>
                                        <button onclick="setHistoryFilter('removed')" 
                                                class="filter-badge ${state.historyFilter === 'removed' ? 'active' : ''}">
                                            üóëÔ∏è Removidos
                                        </button>
                                        <button onclick="setHistoryFilter('modified')" 
                                                class="filter-badge ${state.historyFilter === 'modified' ? 'active' : ''}">
                                            üîß Modificados
                                        </button>
                                        <button onclick="setHistoryFilter('stock-up')" 
                                                class="filter-badge ${state.historyFilter === 'stock-up' ? 'active' : ''}">
                                            üìà Estoque +
                                        </button>
                                        <button onclick="setHistoryFilter('stock-down')" 
                                                class="filter-badge ${state.historyFilter === 'stock-down' ? 'active' : ''}">
                                            üìâ Estoque -
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="exportHistory()" 
                                            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                        üì• Exportar
                                    </button>
                                    <button onclick="clearHistory()" 
                                            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
                                        üóëÔ∏è Limpar
                                    </button>
                                </div>
                            </div>
                            
                            <div class="text-sm text-gray-600">
                                üìö Mostrando ${state.history.length} registros no total
                            </div>
                        </div>

                        <!-- LISTA DO HIST√ìRICO -->
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div id="historyContent" class="max-h-[500px] overflow-y-auto p-4">
                                <!-- O conte√∫do do hist√≥rico ser√° carregado aqui -->
                            </div>
                        </div>
                        
                        <!-- LEGENDA DO HIST√ìRICO -->
                        <div class="mt-6 bg-gray-50 rounded-lg p-4">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                üé® Legenda do Hist√≥rico
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="badge-added px-3 py-1 rounded-full text-xs">ADICIONADO</span>
                                    <span class="text-sm text-gray-600">Produto novo</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="badge-removed px-3 py-1 rounded-full text-xs">REM OVIDO</span>
                                    <span class="text-sm text-gray-600">Produto exclu√≠do</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="badge-modified px-3 py-1 rounded-full text-xs">MODIFICADO</span>
                                    <span class="text-sm text-gray-600">Dados alterados</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="badge-stock-up px-3 py-1 rounded-full text-xs">ESTOQUE +</span>
                                    <span class="text-sm text-gray-600">Estoque aumentou</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="badge-stock-down px-3 py-1 rounded-full text-xs">ESTOQUE -</span>
                                    <span class="text-sm text-gray-600">Estoque diminuiu</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- LEGENDA DE LOCALIZA√á√ÉO (s√≥ aparece na aba de estoque) -->
                    ${state.currentTab === 'estoque' ? `
                        <div class="mt-6 bg-white rounded-lg p-5 shadow no-print">
                            <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                üé® Legenda de Localiza√ß√£o
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div class="flex items-center gap-2">
                                    <span class="status-tag status-mostruario">Mostru√°rio</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="status-tag status-embalado">Embalado</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="status-tag status-frentedeloja">Frente de Loja</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="status-tag status-separadocd">Separado p/CD</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="status-tag status-montagem">Montagem</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="status-tag status-assistencia">Assist√™ncia</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- INFORMA√á√ïES DO SISTEMA -->
                    <div class="mt-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 shadow-sm no-print">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl">üí°</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800 mb-2">Sobre este sistema</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li>‚úÖ Conectado em tempo real com Google Sheets</li>
                                    <li>üîÑ Atualiza√ß√£o autom√°tica a cada 30 segundos</li>
                                    <li>üìù Sistema de hist√≥rico completo de mudan√ßas</li>
                                    <li>üíæ Backup local para funcionamento offline</li>
                                    <li>üîç Busca inteligente por c√≥digo, nome ou localiza√ß√£o</li>
                                    <li>üìä Filtros avan√ßados por localiza√ß√£o e quantidade</li>
                                    <li>üì• Exporta√ß√£o de dados em CSV</li>
                                    <li>üì± 100% responsivo para mobile</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- FOOTER -->
                <footer class="mt-8 pb-6 text-center text-gray-500 text-sm no-print">
                    <div class="container mx-auto px-4">
                        <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                            <div class="flex items-center gap-2">
                                ${state.connectionError ? 
                                    '<span class="text-orange-600">‚ö†Ô∏è Modo Offline - Usando backup local</span>' :
                                    '<span class="text-green-600">‚úÖ Sistema Online</span>'}
                            </div>
                            <div class="hidden md:block text-gray-300">|</div>
                            <div>
                                üîÑ Atualiza√ß√£o: ${state.autoRefresh ? 'Autom√°tica (30s)' : 'Manual'}
                            </div>
                            <div class="hidden md:block text-gray-300">|</div>
                            <div>
                                üìä ${state.items.length} produtos cadastrados
                            </div>
                            ${state.historyStats.today > 0 ? `
                                <div class="hidden md:block text-gray-300">|</div>
                                <div class="text-blue-600">
                                    üìù ${state.historyStats.today} mudan√ßas hoje
                                </div>
                            ` : ''}
                        </div>
                        ${state.lastUpdate ? `
                            <div class="mt-2 text-xs text-gray-400">
                                √öltima sincroniza√ß√£o: ${state.lastUpdate.toLocaleString('pt-BR')}
                            </div>
                        ` : ''}
                    </div>
                </footer>
            `;

            // Atualizar o conte√∫do do hist√≥rico se estiver na aba certa
            if (state.currentTab === 'historico') {
                updateHistoryDisplay();
            }

            // Focar no campo de busca ap√≥s renderizar (se estiver na aba de estoque)
            setTimeout(() => {
                if (state.currentTab === 'estoque') {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput && !state.searchTerm) {
                        searchInput.focus();
                    }
                }
            }, 100);
        }

        // üöÄ INICIALIZAR APLICA√á√ÉO
        initApp();

        // üîÑ RECARREGAR AO VOLTAR PARA A ABA
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && state.autoRefresh) {
                // Usar modo silencioso ao voltar para a aba
                syncWithSheet(true);
            }
        });

        // ‚å®Ô∏è ATALHOS DE TECLADO
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + F para focar na busca
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                if (state.currentTab === 'estoque') {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) searchInput.focus();
                }
            }
            
            // Ctrl/Cmd + R para atualizar
            if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                e.preventDefault();
                syncWithSheet();
            }
            
            // ESC para limpar busca
            if (e.key === 'Escape' && state.searchTerm) {
                clearSearch();
            }
            
            // Ctrl + 1 para aba Estoque
            if (e.ctrlKey && e.key === '1') {
                e.preventDefault();
                switchTab('estoque');
            }
            
            // Ctrl + 2 para aba Hist√≥rico
            if (e.ctrlKey && e.key === '2') {
                e.preventDefault();
                switchTab('historico');
            }
        });
    </script>
</body>
</html>
