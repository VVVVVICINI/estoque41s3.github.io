<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Estoque - Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // üîß CONFIGURA√á√ÉO - SUBSTITUA COM SEUS DADOS!
        const SUPABASE_URL = 'https://seu-projeto.supabase.co';
        const SUPABASE_ANON_KEY = 'sua-chave-anon-aqui';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let state = {
            user: null,
            items: [],
            loading: true,
            showLogin: true,
            showModal: false,
            loginForm: { email: '', password: '' },
            registerForm: { email: '', password: '', confirmPassword: '', nome: '' },
            formData: {
                codigo: '', nome: '', descricao: '', quantidade: '', status: 'venda',
                localizacao: '', observacoes: '', categoria: '', preco: ''
            }
        };

        // üîê AUTENTICA√á√ÉO
        async function initAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            state.user = session?.user || null;
            state.loading = false;
            render();
            
            supabase.auth.onAuthStateChange((event, session) => {
                state.user = session?.user || null;
                if (event === 'SIGNED_IN') {
                    loadItems();
                    showNotification('‚úÖ Login realizado!', 'success');
                } else if (event === 'SIGNED_OUT') {
                    state.items = [];
                    state.showLogin = true;
                }
                render();
            });
        }

        // üìß LOGIN
        async function handleLogin() {
            if (!state.loginForm.email || !state.loginForm.password) {
                showNotification('‚ùå Preencha email e senha', 'error');
                return;
            }
            try {
                state.loading = true;
                render();
                const { error } = await supabase.auth.signInWithPassword(state.loginForm);
                if (error) throw error;
                state.loginForm = { email: '', password: '' };
            } catch (error) {
                state.loading = false;
                render();
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // üìù CADASTRO
        async function handleRegister() {
            if (!state.registerForm.email || !state.registerForm.password) {
                showNotification('‚ùå Preencha todos os campos', 'error');
                return;
            }
            if (state.registerForm.password !== state.registerForm.confirmPassword) {
                showNotification('‚ùå Senhas n√£o coincidem', 'error');
                return;
            }
            try {
                state.loading = true;
                render();
                const { error } = await supabase.auth.signUp({
                    email: state.registerForm.email,
                    password: state.registerForm.password,
                    options: {
                        data: {
                            nome: state.registerForm.nome
                        }
                    }
                });
                if (error) throw error;
                state.registerForm = { email: '', password: '', confirmPassword: '', nome: '' };
                showNotification('‚úÖ Cadastro realizado! Verifique seu email.', 'success');
            } catch (error) {
                state.loading = false;
                render();
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // üö™ LOGOUT
        async function handleLogout() {
            await supabase.auth.signOut();
            showNotification('üëã Logout realizado', 'info');
        }

        // üì¶ CARREGAR ITENS
        async function loadItems() {
            try {
                const { data, error } = await supabase
                    .from('items')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                state.items = data || [];
                render();
            } catch (error) {
                showNotification('‚ùå Erro ao carregar itens: ' + error.message, 'error');
            }
        }

        // üíæ SALVAR ITEM
        async function saveItem() {
            if (!state.formData.codigo || !state.formData.nome || !state.formData.quantidade) {
                showNotification('‚ùå Preencha c√≥digo, nome e quantidade', 'error');
                return;
            }

            try {
                const { error } = await supabase
                    .from('items')
                    .insert([{
                        ...state.formData,
                        user_id: state.user.id,
                        user_email: state.user.email
                    }]);
                
                if (error) throw error;
                
                closeModal();
                loadItems();
                showNotification('‚úÖ Item adicionado!', 'success');
            } catch (error) {
                showNotification('‚ùå Erro ao salvar: ' + error.message, 'error');
            }
        }

        // üóëÔ∏è EXCLUIR ITEM
        async function deleteItem(itemId) {
            if (!confirm('Tem certeza que deseja excluir este item?')) return;
            
            try {
                const { error } = await supabase
                    .from('items')
                    .delete()
                    .eq('id', itemId);
                
                if (error) throw error;
                
                loadItems();
                showNotification('‚úÖ Item exclu√≠do!', 'success');
            } catch (error) {
                showNotification('‚ùå Erro ao excluir: ' + error.message, 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Criar notifica√ß√£o simples
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${
                type === 'error' ? 'bg-red-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <span>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function openModal() {
            if (!state.user) {
                showNotification('‚ùå Fa√ßa login para adicionar itens', 'error');
                return;
            }
            state.showModal = true;
            render();
        }

        function closeModal() {
            state.showModal = false;
            state.formData = {
                codigo: '', nome: '', descricao: '', quantidade: '', status: 'venda',
                localizacao: '', observacoes: '', categoria: '', preco: ''
            };
            render();
        }

        // üéØ RENDERIZA√á√ÉO
        function render() {
            if (state.loading) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4 animate-spin"></div>
                            <p class="text-gray-600">Carregando...</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (!state.user) {
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-50 to-purple-50">
                        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div class="text-center mb-8">
                                <div class="w-16 h-16 bg-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <span class="text-white text-2xl">üì¶</span>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-2">Controle de Estoque</h1>
                                <p class="text-gray-600">Sistema em nuvem gratuito</p>
                            </div>

                            ${state.showLogin ? `
                                <!-- LOGIN -->
                                <div class="space-y-4">
                                    <div>
                                        <input type="email" placeholder="Email" value="${state.loginForm.email}"
                                            oninput="state.loginForm.email = this.value"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <input type="password" placeholder="Senha" value="${state.loginForm.password}"
                                            oninput="state.loginForm.password = this.value"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <button onclick="handleLogin()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                        Entrar
                                    </button>
                                    <div class="text-center">
                                        <button onclick="state.showLogin = false; render()" class="text-purple-600 hover:text-purple-700 text-sm">
                                            N√£o tem conta? Cadastre-se
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <!-- CADASTRO -->
                                <div class="space-y-4">
                                    <div>
                                        <input type="text" placeholder="Nome completo" value="${state.registerForm.nome}"
                                            oninput="state.registerForm.nome = this.value"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <input type="email" placeholder="Email" value="${state.registerForm.email}"
                                            oninput="state.registerForm.email = this.value"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <input type="password" placeholder="Senha (m√≠n. 6 caracteres)" value="${state.registerForm.password}"
                                            oninput="state.registerForm.password = this.value"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <input type="password" placeholder="Confirmar senha" value="${state.registerForm.confirmPassword}"
                                            oninput="state.registerForm.confirmPassword = this.value"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>
                                    <button onclick="handleRegister()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-colors">
                                        Cadastrar
                                    </button>
                                    <div class="text-center">
                                        <button onclick="state.showLogin = true; render()" class="text-purple-600 hover:text-purple-700 text-sm">
                                            J√° tem conta? Fa√ßa login
                                        </button>
                                    </div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
                return;
            }

            // USU√ÅRIO LOGADO
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen p-4 bg-gray-50">
                    <div class="max-w-6xl mx-auto">
                        <!-- HEADER -->
                        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
                            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                                        <span class="text-white text-xl">üì¶</span>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-800">Controle de Estoque</h1>
                                        <p class="text-gray-600">${state.user.email}</p>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                        ${state.items.length} itens
                                    </span>
                                    <button onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                                        Sair
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- BOT√ÉO ADICIONAR -->
                        <div class="mb-6">
                            <button onclick="openModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                                + Adicionar Produto
                            </button>
                        </div>

                        <!-- LISTA DE ITENS -->
                        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                            ${state.items.length === 0 ? `
                                <div class="text-center py-12">
                                    <div class="text-6xl mb-4">üì¶</div>
                                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhum item cadastrado</h3>
                                    <p class="text-gray-500">Comece adicionando seu primeiro produto!</p>
                                </div>
                            ` : `
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pre√ßo</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            ${state.items.map(item => `
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm font-medium text-gray-900">${item.codigo}</div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm font-medium text-gray-900">${item.nome}</div>
                                                        <div class="text-sm text-gray-500">${item.categoria || 'Sem categoria'}</div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                                                            ${item.quantidade}
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <div class="text-sm text-gray-900">${item.preco ? 'R$ ' + item.preco : '-'}</div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <button onclick="deleteItem('${item.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">
                                                            Excluir
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                </div>

                <!-- MODAL -->
                ${state.showModal ? `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
                            <div class="bg-purple-600 text-white px-6 py-4 rounded-t-2xl">
                                <h2 class="text-xl font-bold">Adicionar Produto</h2>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">C√≥digo *</label>
                                    <input type="text" value="${state.formData.codigo}" 
                                        oninput="state.formData.codigo = this.value"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                                    <input type="text" value="${state.formData.nome}"
                                        oninput="state.formData.nome = this.value"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantidade *</label>
                                    <input type="number" value="${state.formData.quantidade}"
                                        oninput="state.formData.quantidade = this.value"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="flex gap-3 justify-end pt-4">
                                    <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                                        Cancelar
                                    </button>
                                    <button onclick="saveItem()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                                        Salvar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // üöÄ INICIAR
        initAuth();
    </script>
</body>
</html>
