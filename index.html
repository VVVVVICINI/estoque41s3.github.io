<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Estoque - SUPER BRUNO ATACADO</title>
    <meta name="theme-color" content="#a00b08">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Bibliotecas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <style>
        :root {
            --primary-red: #a00b08;
            --primary-yellow: #f4cf08;
            --primary-beige: #d8cfc4;
            --primary-dark-red: #4d0505;
            --primary-purple: #9c7c84;
        }
        
        .brand-gradient {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-dark-red) 100%);
        }
        
        .btn-primary {
            background-color: var(--primary-red);
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark-red);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Status tags (mantido do c√≥digo original) */
        .status-tag {
            display: inline-block !important;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 2px;
            line-height: 1.2;
            white-space: nowrap;
            border: 1px solid;
            transition: all 0.2s;
        }
        .status-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-mostruario {
            background-color: #fef9e7 !important;
            color: #7d6608 !important;
            border-color: #f4cf08 !important;
        }
        
        .status-embalado {
            background-color: #e8f8ef !important;
            color: #186a3b !important;
            border-color: #2ecc71 !important;
        }
        
        /* ... outros status tags ... */
        
        /* Kanban Styles */
        .kanban-column {
            min-height: 500px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
        }
        
        .kanban-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s;
        }
        
        .kanban-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .kanban-column-header {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
        }
        
        /* QR Code Modal */
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }
        
        .qr-modal-content {
            background: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Scanner Styles */
        .scanner-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            background: #1a1a1a;
        }
        
        #qr-reader {
            width: 100% !important;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 2px solid #00ff00;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7);
            border-radius: 12px;
        }
        
        /* Calendar Styles */
        .fc {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }
        
        .fc-toolbar {
            padding: 15px;
        }
        
        .fc-event {
            border-radius: 6px !important;
            padding: 5px !important;
        }
        
        /* Dashboard Charts */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .kanban-column {
                min-height: 300px;
                margin-bottom: 20px;
            }
            
            .qr-modal-content {
                margin: 10% 5%;
                width: 90%;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading-spinner w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Carregando sistema...</p>
                <p class="text-gray-400 text-sm mt-2">Preparando todas as funcionalidades</p>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">üì± QR Code do Produto</h3>
                <button onclick="closeQRModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <div id="qrCodeContainer" class="flex justify-center my-6">
                <!-- QR Code ser√° gerado aqui -->
            </div>
            <div id="qrProductInfo" class="text-center mb-4">
                <!-- Informa√ß√µes do produto -->
            </div>
            <div class="flex gap-2">
                <button onclick="printQRCode()" class="btn-primary flex-1 py-3 rounded-lg">
                    üñ®Ô∏è Imprimir QR Code
                </button>
                <button onclick="shareViaWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white flex-1 py-3 rounded-lg">
                    üì± Compartilhar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Scanner -->
    <div id="scannerModal" class="qr-modal">
        <div class="qr-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">üîç Scanner de QR Code</h3>
                <button onclick="closeScanner()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <div class="scanner-container relative">
                <div id="qr-reader"></div>
                <div class="scanner-overlay"></div>
            </div>
            <div id="scannerResult" class="mt-4 p-4 bg-gray-100 rounded-lg hidden">
                <!-- Resultado do scan aparecer√° aqui -->
            </div>
            <div class="mt-4 text-center text-sm text-gray-500">
                Aponte a c√¢mera para o QR Code do produto
            </div>
        </div>
    </div>

    <!-- Modal Lembrete -->
    <div id="reminderModal" class="qr-modal">
        <div class="qr-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">üìÖ Novo Lembrete</h3>
                <button onclick="closeReminderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            <form id="reminderForm" onsubmit="saveReminder(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Produto relacionado</label>
                        <select id="reminderProduct" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">Selecionar produto...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo do lembrete</label>
                        <input type="text" id="reminderTitle" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                        <textarea id="reminderDescription" rows="3"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="reminderDate" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select id="reminderStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="pendente">Pendente</option>
                            <option value="andamento">Em andamento</option>
                            <option value="concluido">Conclu√≠do</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <input type="checkbox" id="reminderAlert" class="mr-2">
                            Enviar alerta por WhatsApp
                        </label>
                    </div>
                </div>
                <div class="mt-6 flex gap-2">
                    <button type="submit" class="btn-primary flex-1 py-3 rounded-lg">
                        üíæ Salvar Lembrete
                    </button>
                    <button type="button" onclick="closeReminderModal()" 
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 flex-1 py-3 rounded-lg">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // üîß CONFIGURA√á√ÉO PRINCIPAL
        const CONFIG = {
            GOOGLE_SHEET_ID: '1zN6WXg-7mkb0mYOV8Hf3stQLD9wAdnyDKSPF5PfYK_M',
            PUBLISHED_ID: '2PACX-1vTXIBXGqrCkz3-Fg07OBUq5Xv4jrXhpAvIXWrk9GiNoeD_so8qTHaxdPXBRTTOvkN1EUujUtVOPDU8f',
            SHEET_NAME: 'P√°gina1',
            AUTO_REFRESH_INTERVAL: 30000,
            
            // Keys para localStorage
            BACKUP_KEY: 'estoque_live_backup',
            HISTORY_KEY: 'estoque_history',
            REMINDERS_KEY: 'estoque_reminders',
            KANBAN_KEY: 'estoque_kanban',
            SCAN_HISTORY_KEY: 'estoque_scan_history',
            
            // WhatsApp config
            WHATSAPP_NUMBER: '5511999999999',
            
            DEBUG_MODE: true,
            USE_PUBLISHED_VERSION: true
        };

        // üóÉÔ∏è ESTADO GLOBAL
        let state = {
            items: [],
            filteredItems: [],
            loading: true,
            searchTerm: '',
            sortField: 'codigo',
            sortDirection: 'asc',
            currentTab: 'estoque',
            historyFilter: 'all',
            locationFilter: 'all',
            stockFilter: 'all',
            
            // Configura√ß√µes
            autoRefresh: true,
            syncInterval: null,
            connectionError: false,
            lastUpdate: null,
            
            // Estat√≠sticas
            stats: {
                total: 0,
                inStock: 0,
                outOfStock: 0,
                lowStock: 0
            },
            
            // Hist√≥rico
            history: [],
            historyStats: {
                today: 0,
                added: 0,
                removed: 0,
                modified: 0,
                stockUp: 0,
                stockDown: 0
            },
            
            // Novos m√≥dulos
            reminders: [],
            kanbanTasks: {
                pendente: [],
                andamento: [],
                concluido: []
            },
            scanHistory: [],
            charts: null
        };

        // üéØ UTILIDADES GERAIS
        let searchDebounceTimer = null;
        let lastFocusedElementId = null;
        let html5QrCode = null;

        // üìä M√ìDULO: DASHBOARD COM GR√ÅFICOS
        function initDashboard() {
            if (state.charts) {
                // Destruir gr√°ficos existentes
                Object.values(state.charts).forEach(chart => chart.destroy());
            }
            
            state.charts = {
                locationChart: null,
                stockChart: null,
                movementChart: null
            };
            
            updateDashboardCharts();
        }

        function updateDashboardCharts() {
            // Gr√°fico 1: Distribui√ß√£o por localiza√ß√£o
            const locationData = analyzeLocationDistribution();
            renderLocationChart(locationData);
            
            // Gr√°fico 2: N√≠veis de estoque
            renderStockChart();
            
            // Gr√°fico 3: Movimenta√ß√µes recentes
            renderMovementChart();
        }

        function analyzeLocationDistribution() {
            const locations = {
                mostruario: 0,
                embalado: 0,
                frente: 0,
                cd: 0,
                montagem: 0,
                assistencia: 0,
                outros: 0
            };
            
            state.items.forEach(item => {
                const obs = (item.observacoes || '').toLowerCase();
                let found = false;
                
                if (obs.includes('mostruario') || obs.includes('mostru√°rio')) {
                    locations.mostruario++;
                    found = true;
                }
                if (obs.includes('embalado') || obs.includes('caixa')) {
                    locations.embalado++;
                    found = true;
                }
                if (obs.includes('frente') || obs.includes('loja')) {
                    locations.frente++;
                    found = true;
                }
                if (obs.includes('separado') || obs.includes('cd')) {
                    locations.cd++;
                    found = true;
                }
                if (obs.includes('montagem') || obs.includes('montar')) {
                    locations.montagem++;
                    found = true;
                }
                if (obs.includes('assistencia') || obs.includes('assist√™ncia')) {
                    locations.assistencia++;
                    found = true;
                }
                
                if (!found) locations.outros++;
            });
            
            return locations;
        }

        function renderLocationChart(data) {
            const ctx = document.getElementById('locationChart');
            if (!ctx) return;
            
            state.charts.locationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Mostru√°rio', 'Embalado', 'Frente Loja', 'CD', 'Montagem', 'Assist√™ncia', 'Outros'],
                    datasets: [{
                        data: [
                            data.mostruario,
                            data.embalado,
                            data.frente,
                            data.cd,
                            data.montagem,
                            data.assistencia,
                            data.outros
                        ],
                        backgroundColor: [
                            '#f4cf08', '#2ecc71', '#3498db',
                            '#9b59b6', '#34495e', '#e74c3c',
                            '#95a5a6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderStockChart() {
            const ctx = document.getElementById('stockChart');
            if (!ctx) return;
            
            state.charts.stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Em estoque', 'Baixo estoque', 'Esgotado'],
                    datasets: [{
                        label: 'Quantidade de Produtos',
                        data: [
                            state.stats.inStock,
                            state.stats.lowStock,
                            state.stats.outOfStock
                        ],
                        backgroundColor: [
                            '#2ecc71',
                            '#f4cf08',
                            '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderMovementChart() {
            const ctx = document.getElementById('movementChart');
            if (!ctx) return;
            
            // Agrupar movimenta√ß√µes por dia (√∫ltimos 7 dias)
            const last7Days = [...Array(7)].map((_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();
            
            const dailyMovements = last7Days.map(date => {
                return state.history.filter(entry => {
                    const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                    return entryDate === date;
                }).length;
            });
            
            state.charts.movementChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => formatDateShort(date)),
                    datasets: [{
                        label: 'Movimenta√ß√µes',
                        data: dailyMovements,
                        borderColor: '#a00b08',
                        backgroundColor: 'rgba(160, 11, 8, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // üìÖ M√ìDULO: LEMBRETES E CALEND√ÅRIO
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listMonth'
                },
                events: state.reminders.map(reminder => ({
                    id: reminder.id,
                    title: reminder.title,
                    start: reminder.date,
                    backgroundColor: getReminderColor(reminder.status),
                    borderColor: getReminderColor(reminder.status),
                    extendedProps: reminder
                })),
                dateClick: function(info) {
                    openReminderModal(info.dateStr);
                },
                eventClick: function(info) {
                    showReminderDetails(info.event);
                }
            });
            
            calendar.render();
            
            // Salvar refer√™ncia do calend√°rio
            state.calendar = calendar;
        }

        function loadReminders() {
            try {
                const saved = localStorage.getItem(CONFIG.REMINDERS_KEY);
                if (saved) {
                    state.reminders = JSON.parse(saved);
                    
                    // Verificar lembretes atrasados
                    checkOverdueReminders();
                    
                    console.log(`üìÖ Lembretes carregados: ${state.reminders.length}`);
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar lembretes:', error);
            }
            return false;
        }

        function saveReminder(e) {
            e.preventDefault();
            
            const reminder = {
                id: `rem_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                productId: document.getElementById('reminderProduct').value,
                productCode: document.getElementById('reminderProduct').selectedOptions[0]?.dataset.code || '',
                productName: document.getElementById('reminderProduct').selectedOptions[0]?.dataset.name || '',
                title: document.getElementById('reminderTitle').value,
                description: document.getElementById('reminderDescription').value,
                date: document.getElementById('reminderDate').value,
                status: document.getElementById('reminderStatus').value,
                created: new Date().toISOString(),
                alertWhatsApp: document.getElementById('reminderAlert').checked
            };
            
            state.reminders.push(reminder);
            saveRemindersToStorage();
            
            // Atualizar calend√°rio
            if (state.calendar) {
                state.calendar.addEvent({
                    id: reminder.id,
                    title: reminder.title,
                    start: reminder.date,
                    backgroundColor: getReminderColor(reminder.status),
                    borderColor: getReminderColor(reminder.status)
                });
            }
            
            // Atualizar Kanban
            addTaskToKanban(reminder);
            
            // Enviar alerta por WhatsApp se solicitado
            if (reminder.alertWhatsApp) {
                sendWhatsAppReminder(reminder);
            }
            
            closeReminderModal();
            showNotification('üìÖ Lembrete salvo com sucesso!', 'success');
            
            // Se estiver na aba de lembretes, atualizar a exibi√ß√£o
            if (state.currentTab === 'lembretes') {
                updateRemindersDisplay();
            }
        }

        function checkOverdueReminders() {
            const today = new Date().toISOString().split('T')[0];
            const overdue = state.reminders.filter(reminder => 
                reminder.date < today && reminder.status !== 'concluido'
            );
            
            if (overdue.length > 0) {
                showNotification(`‚ö†Ô∏è ${overdue.length} lembretes atrasados!`, 'warning');
                
                // Adicionar classe de atraso
                overdue.forEach(reminder => {
                    reminder.overdue = true;
                });
                
                saveRemindersToStorage();
            }
        }

        function getReminderColor(status) {
            switch(status) {
                case 'pendente': return '#e74c3c';
                case 'andamento': return '#f4cf08';
                case 'concluido': return '#2ecc71';
                default: return '#95a5a6';
            }
        }

        function sendWhatsAppReminder(reminder) {
            const message = encodeURIComponent(
                `üìÖ Lembrete: ${reminder.title}\n` +
                `üì¶ Produto: ${reminder.productName || 'N√£o especificado'}\n` +
                `üìÖ Data: ${formatDate(reminder.date)}\n` +
                `üìù ${reminder.description || ''}\n\n` +
                `Link: ${window.location.href}`
            );
            
            const whatsappUrl = `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        // üé® M√ìDULO: KANBAN
        function initKanban() {
            loadKanbanTasks();
            
            // Inicializar colunas com SortableJS
            ['pendente', 'andamento', 'concluido'].forEach(columnId => {
                const column = document.getElementById(`kanban-${columnId}`);
                if (column) {
                    new Sortable(column, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'kanban-ghost',
                        onEnd: function(evt) {
                            updateTaskStatus(evt.item.dataset.taskId, columnId);
                        }
                    });
                }
            });
        }

        function loadKanbanTasks() {
            try {
                const saved = localStorage.getItem(CONFIG.KANBAN_KEY);
                if (saved) {
                    state.kanbanTasks = JSON.parse(saved);
                    console.log(`üé® Kanban carregado: ${Object.values(state.kanbanTasks).flat().length} tarefas`);
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar Kanban:', error);
            }
            
            // Se n√£o houver dados, criar a partir dos lembretes
            state.kanbanTasks = {
                pendente: state.reminders.filter(r => r.status === 'pendente'),
                andamento: state.reminders.filter(r => r.status === 'andamento'),
                concluido: state.reminders.filter(r => r.status === 'concluido')
            };
            
            return false;
        }

        function addTaskToKanban(task) {
            if (!state.kanbanTasks[task.status]) {
                state.kanbanTasks[task.status] = [];
            }
            state.kanbanTasks[task.status].push(task);
            saveKanbanToStorage();
            
            // Atualizar visualiza√ß√£o se estiver na aba Kanban
            if (state.currentTab === 'kanban') {
                updateKanbanDisplay();
            }
        }

        function updateTaskStatus(taskId, newStatus) {
            // Atualizar no array de lembretes
            const reminderIndex = state.reminders.findIndex(r => r.id === taskId);
            if (reminderIndex !== -1) {
                state.reminders[reminderIndex].status = newStatus;
                saveRemindersToStorage();
            }
            
            // Mover entre colunas do Kanban
            Object.keys(state.kanbanTasks).forEach(status => {
                state.kanbanTasks[status] = state.kanbanTasks[status].filter(task => task.id !== taskId);
            });
            
            const task = state.reminders.find(r => r.id === taskId);
            if (task) {
                state.kanbanTasks[newStatus].push(task);
                saveKanbanToStorage();
            }
            
            // Atualizar calend√°rio
            if (state.calendar) {
                const event = state.calendar.getEventById(taskId);
                if (event) {
                    event.setProp('backgroundColor', getReminderColor(newStatus));
                    event.setProp('borderColor', getReminderColor(newStatus));
                }
            }
            
            showNotification('üé® Tarefa movida no Kanban', 'info');
        }

        // üî≤ M√ìDULO: QR CODES
        function generateQRCode(product) {
            const data = {
                codigo: product.codigo,
                nome: product.nome,
                quantidade: product.quantidade,
                plataforma: product.plataforma,
                timestamp: new Date().toISOString(),
                url: window.location.href
            };
            
            const qrData = JSON.stringify(data);
            
            QRCode.toCanvas(document.getElementById('qrCodeContainer'), qrData, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#a00b08',
                    light: '#ffffff'
                }
            }, function(error) {
                if (error) {
                    console.error('‚ùå Erro ao gerar QR Code:', error);
                    showNotification('‚ùå Erro ao gerar QR Code', 'error');
                }
            });
            
            // Atualizar informa√ß√µes do produto
            document.getElementById('qrProductInfo').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="font-bold text-lg">${product.nome}</div>
                    <div class="text-gray-600">C√≥digo: <span class="font-mono">${product.codigo}</span></div>
                    <div class="text-gray-600">Estoque: ${product.quantidade} unidades</div>
                    <div class="text-gray-600">Local: ${product.plataforma}</div>
                </div>
            `;
            
            // Salvar no hist√≥rico de QR Codes
            addToScanHistory({
                type: 'generated',
                product: product.codigo,
                name: product.nome,
                timestamp: new Date().toISOString()
            });
            
            // Abrir modal
            document.getElementById('qrModal').style.display = 'block';
            
            // Salvar produto atual para refer√™ncia
            state.currentQRProduct = product;
        }

        function printQRCode() {
            const printWindow = window.open('', '_blank');
            const product = state.currentQRProduct;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>QR Code - ${product.nome}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .print-container { text-align: center; }
                        .qr-code { margin: 20px auto; }
                        .product-info { margin: 20px 0; }
                        .footer { margin-top: 30px; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="print-container">
                        <h1>SUPER BRUNO ATACADO</h1>
                        <h2>QR Code do Produto</h2>
                        
                        <div class="product-info">
                            <h3>${product.nome}</h3>
                            <p><strong>C√≥digo:</strong> ${product.codigo}</p>
                            <p><strong>Estoque:</strong> ${product.quantidade} unidades</p>
                            <p><strong>Plataforma:</strong> ${product.plataforma}</p>
                            <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                        </div>
                        
                        <div class="qr-code" id="qrPrint"></div>
                        
                        <div class="footer">
                            <p>Sistema de Estoque - Super Bruno Atacado</p>
                            <p>${window.location.href}</p>
                        </div>
                    </div>
                    
                    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
                    <script>
                        const data = ${JSON.stringify({
                            codigo: product.codigo,
                            nome: product.nome,
                            quantidade: product.quantidade,
                            timestamp: new Date().toISOString()
                        })};
                        
                        QRCode.toCanvas(document.getElementById('qrPrint'), JSON.stringify(data), {
                            width: 300,
                            margin: 2,
                            color: { dark: '#a00b08', light: '#ffffff' }
                        }, function() {
                            window.print();
                            setTimeout(() => window.close(), 1000);
                        });
                    </script>
                </body>
                </html>
            `);
        }

        // üîç M√ìDULO: SCANNER DE QR CODES
        function openScanner() {
            document.getElementById('scannerModal').style.display = 'block';
            
            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
                
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                };
                
                html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    onScanSuccess,
                    onScanError
                ).catch(err => {
                    console.error('‚ùå Erro ao iniciar scanner:', err);
                    showNotification('‚ùå Erro ao acessar c√¢mera', 'error');
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Tocar som de confirma√ß√£o
            playScanSound();
            
            try {
                const data = JSON.parse(decodedText);
                
                // Mostrar resultado
                const resultDiv = document.getElementById('scannerResult');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="flex items-center gap-2 text-green-700 mb-2">
                            <span class="text-2xl">‚úÖ</span>
                            <span class="font-bold">QR Code escaneado!</span>
                        </div>
                        <div class="text-gray-800">
                            <p><strong>Produto:</strong> ${data.nome}</p>
                            <p><strong>C√≥digo:</strong> ${data.codigo}</p>
                            <p><strong>Estoque:</strong> ${data.quantidade}</p>
                        </div>
                    </div>
                `;
                
                // Salvar no hist√≥rico de scans
                addToScanHistory({
                    type: 'scanned',
                    product: data.codigo,
                    name: data.nome,
                    data: data,
                    timestamp: new Date().toISOString()
                });
                
                // Buscar produto correspondente
                const product = state.items.find(item => item.codigo === data.codigo);
                if (product) {
                    // Focar no produto na tabela
                    highlightProductInTable(data.codigo);
                }
                
                // Parar scanner ap√≥s 3 segundos
                setTimeout(() => {
                    closeScanner();
                    // Focar no produto escaneado
                    if (product) {
                        state.searchTerm = product.codigo;
                        applySortingAndFiltering();
                        updateDynamicComponents();
                    }
                }, 3000);
                
            } catch (error) {
                document.getElementById('scannerResult').innerHTML = `
                    <div class="bg-red-50 p-4 rounded-lg">
                        <div class="text-red-700">
                            ‚ùå QR Code inv√°lido ou n√£o reconhecido
                        </div>
                    </div>
                `;
            }
        }

        function onScanError(error) {
            console.warn('‚ö†Ô∏è Erro no scanner:', error);
        }

        function playScanSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQ=');
            audio.play().catch(() => {});
        }

        function addToScanHistory(entry) {
            state.scanHistory.unshift(entry);
            
            // Manter apenas os √∫ltimos 100 scans
            if (state.scanHistory.length > 100) {
                state.scanHistory = state.scanHistory.slice(0, 100);
            }
            
            // Salvar no localStorage
            try {
                localStorage.setItem(CONFIG.SCAN_HISTORY_KEY, JSON.stringify(state.scanHistory));
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao salvar hist√≥rico de scans:', e);
            }
            
            // Atualizar dashboard se estiver vis√≠vel
            updateDashboardCharts();
        }

        function highlightProductInTable(productCode) {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const codeCell = row.querySelector('.font-mono');
                if (codeCell && codeCell.textContent.trim() === productCode) {
                    row.classList.add('bg-yellow-100');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    setTimeout(() => {
                        row.classList.remove('bg-yellow-100');
                    }, 3000);
                }
            });
        }

        // üì± M√ìDULO: INTEGRA√á√ÉO WHATSAPP
        function shareProductViaWhatsApp(product) {
            const message = encodeURIComponent(
                `üì¶ *${product.nome}*\n` +
                `üìã C√≥digo: ${product.codigo}\n` +
                `üìä Estoque: ${product.quantidade} unidades\n` +
                `üìç Local: ${product.plataforma}\n` +
                `üìù Obs: ${product.observacoes || 'Nenhuma'}\n\n` +
                `_Enviado via Sistema de Estoque - Super Bruno_`
            );
            
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        function shareStockAlert() {
            const lowStockProducts = state.items.filter(item => item.quantidade > 0 && item.quantidade <= 3);
            
            if (lowStockProducts.length === 0) {
                showNotification('‚úÖ Nenhum produto com estoque baixo', 'info');
                return;
            }
            
            let message = `‚ö†Ô∏è *ALERTA DE ESTOQUE BAIXO*\n\n`;
            message += `*${lowStockProducts.length} produtos com estoque baixo:*\n\n`;
            
            lowStockProducts.forEach((product, index) => {
                message += `${index + 1}. ${product.nome}\n`;
                message += `   C√≥digo: ${product.codigo}\n`;
                message += `   Estoque: ${product.quantidade} unidades\n`;
                message += `   Local: ${product.plataforma}\n\n`;
            });
            
            message += `_Enviado via Sistema de Estoque - Super Bruno_`;
            
            const whatsappUrl = `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // üíæ FUN√á√ïES DE ARMAZENAMENTO
        function saveRemindersToStorage() {
            try {
                localStorage.setItem(CONFIG.REMINDERS_KEY, JSON.stringify(state.reminders));
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao salvar lembretes:', e);
            }
        }

        function saveKanbanToStorage() {
            try {
                localStorage.setItem(CONFIG.KANBAN_KEY, JSON.stringify(state.kanbanTasks));
            } catch (e) {
                console.warn('‚ö†Ô∏è Erro ao salvar Kanban:', e);
            }
        }

        // üéØ FUN√á√ïES DE INTERFACE
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            state.currentQRProduct = null;
        }

        function closeScanner() {
            document.getElementById('scannerModal').style.display = 'none';
            
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop();
            }
        }

        function openReminderModal(prefillDate = '') {
            // Popular select de produtos
            const productSelect = document.getElementById('reminderProduct');
            productSelect.innerHTML = '<option value="">Selecionar produto...</option>';
            
            state.items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.dataset.code = item.codigo;
                option.dataset.name = item.nome;
                option.textContent = `${item.codigo} - ${item.nome}`;
                productSelect.appendChild(option);
            });
            
            // Preencher data se fornecida
            if (prefillDate) {
                document.getElementById('reminderDate').value = prefillDate;
            } else {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('reminderDate').value = tomorrow.toISOString().split('T')[0];
            }
            
            document.getElementById('reminderModal').style.display = 'block';
        }

        function closeReminderModal() {
            document.getElementById('reminderModal').style.display = 'none';
            document.getElementById('reminderForm').reset();
        }

        // üìÖ FUN√á√ïES DE FORMATA√á√ÉO DE DATA
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateShort(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
        }

        // üîÑ FUN√á√ïES DE ATUALIZA√á√ÉO DIN√ÇMICA (mantidas do c√≥digo original)
        function updateDynamicComponents() {
            saveCurrentFocus();
            
            updateStatsDisplay();
            updateProductCount();
            updateProductTable();
            updateLastUpdateTime();
            updateSystemStatus();
            updateDashboardCharts();
            
            if (state.currentTab === 'historico') updateHistoryDisplay();
            if (state.currentTab === 'lembretes') updateRemindersDisplay();
            if (state.currentTab === 'kanban') updateKanbanDisplay();
            if (state.currentTab === 'dashboard') updateDashboardDisplay();
            
            restoreFocus();
        }

        function updateRemindersDisplay() {
            const container = document.getElementById('remindersContent');
            if (!container) return;
            
            const today = new Date().toISOString().split('T')[0];
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Calend√°rio -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div id="calendar"></div>
                    </div>
                    
                    <!-- Lista de Lembretes -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg">üìÖ Lembretes</h3>
                            <button onclick="openReminderModal()" 
                                    class="btn-primary px-4 py-2 rounded-lg">
                                + Novo Lembrete
                            </button>
                        </div>
                        
                        ${state.reminders.length === 0 ? `
                            <div class="text-center py-12">
                                <div class="text-gray-400 text-4xl mb-3">üìÖ</div>
                                <div class="text-gray-600 font-medium">Nenhum lembrete agendado</div>
                                <div class="text-gray-400 text-sm mt-2">Clique em "Novo Lembrete" para criar um</div>
                            </div>
                        ` : `
                            <div class="space-y-3 max-h-[500px] overflow-y-auto">
                                ${state.reminders.sort((a,b) => new Date(a.date) - new Date(b.date)).map(reminder => `
                                    <div class="bg-gray-50 p-4 rounded-lg ${reminder.overdue ? 'border-l-4 border-red-500' : ''}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="font-bold flex items-center gap-2">
                                                    ${reminder.overdue ? '‚ö†Ô∏è ' : ''}${reminder.title}
                                                    <span class="text-xs px-2 py-1 rounded ${reminder.status === 'pendente' ? 'bg-red-100 text-red-700' : 
                                                                               reminder.status === 'andamento' ? 'bg-yellow-100 text-yellow-700' : 
                                                                               'bg-green-100 text-green-700'}">
                                                        ${reminder.status}
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-600 mt-1">${reminder.description}</div>
                                                ${reminder.productName ? `
                                                    <div class="text-sm text-gray-500 mt-2">
                                                        üì¶ Produto: ${reminder.productName} (${reminder.productCode})
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div class="text-right">
                                                <div class="text-sm font-medium ${reminder.date < today ? 'text-red-600' : 'text-gray-600'}">
                                                    ${formatDate(reminder.date)}
                                                </div>
                                                <div class="text-xs text-gray-400 mt-1">
                                                    ${new Date(reminder.created).toLocaleDateString('pt-BR')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            // Inicializar calend√°rio se necess√°rio
            if (document.getElementById('calendar') && !state.calendar) {
                initCalendar();
            }
        }

        function updateKanbanDisplay() {
            const container = document.getElementById('kanbanContent');
            if (!container) return;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Coluna Pendente -->
                    <div>
                        <div class="kanban-column-header bg-red-100 text-red-700">
                            üìù Pendente (${state.kanbanTasks.pendente.length})
                        </div>
                        <div id="kanban-pendente" class="kanban-column">
                            ${state.kanbanTasks.pendente.map(task => `
                                <div class="kanban-item" data-task-id="${task.id}">
                                    <div class="font-bold">${task.title}</div>
                                    <div class="text-sm text-gray-600 mt-1">${task.description}</div>
                                    ${task.productName ? `
                                        <div class="text-xs text-gray-500 mt-2">
                                            üì¶ ${task.productName}
                                        </div>
                                    ` : ''}
                                    <div class="text-xs text-gray-400 mt-2">
                                        üìÖ ${formatDate(task.date)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Coluna Em Andamento -->
                    <div>
                        <div class="kanban-column-header bg-yellow-100 text-yellow-700">
                            üîÑ Em Andamento (${state.kanbanTasks.andamento.length})
                        </div>
                        <div id="kanban-andamento" class="kanban-column">
                            ${state.kanbanTasks.andamento.map(task => `
                                <div class="kanban-item" data-task-id="${task.id}">
                                    <div class="font-bold">${task.title}</div>
                                    <div class="text-sm text-gray-600 mt-1">${task.description}</div>
                                    ${task.productName ? `
                                        <div class="text-xs text-gray-500 mt-2">
                                            üì¶ ${task.productName}
                                        </div>
                                    ` : ''}
                                    <div class="text-xs text-gray-400 mt-2">
                                        üìÖ ${formatDate(task.date)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Coluna Conclu√≠do -->
                    <div>
                        <div class="kanban-column-header bg-green-100 text-green-700">
                            ‚úÖ Conclu√≠do (${state.kanbanTasks.concluido.length})
                        </div>
                        <div id="kanban-concluido" class="kanban-column">
                            ${state.kanbanTasks.concluido.map(task => `
                                <div class="kanban-item" data-task-id="${task.id}">
                                    <div class="font-bold">${task.title}</div>
                                    <div class="text-sm text-gray-600 mt-1">${task.description}</div>
                                    ${task.productName ? `
                                        <div class="text-xs text-gray-500 mt-2">
                                            üì¶ ${task.productName}
                                        </div>
                                    ` : ''}
                                    <div class="text-xs text-gray-400 mt-2">
                                        üìÖ ${formatDate(task.date)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="openReminderModal()" class="btn-primary px-6 py-3 rounded-lg">
                        üìù Adicionar Nova Tarefa
                    </button>
                </div>
            `;
            
            // Re-inicializar SortableJS
            initKanban();
        }

        function updateDashboardDisplay() {
            const container = document.getElementById('dashboardContent');
            if (!container) return;
            
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gr√°fico de Localiza√ß√£o -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-4">üìç Distribui√ß√£o por Localiza√ß√£o</h3>
                        <div class="chart-container">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico de Estoque -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="font-bold text-lg mb-4">üìä N√≠veis de Estoque</h3>
                        <div class="chart-container">
                            <canvas id="stockChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gr√°fico de Movimenta√ß√µes -->
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4">üìà Movimenta√ß√µes (√öltimos 7 dias)</h3>
                        <div class="chart-container">
                            <canvas id="movementChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Estat√≠sticas R√°pidas -->
                    <div class="bg-white p-6 rounded-lg shadow lg:col-span-2">
                        <h3 class="font-bold text-lg mb-4">üìä Estat√≠sticas do Sistema</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">${state.stats.total}</div>
                                <div class="text-sm text-gray-600">Produtos</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600">${state.historyStats.today}</div>
                                <div class="text-sm text-gray-600">Mudan√ßas Hoje</div>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600">${state.reminders.length}</div>
                                <div class="text-sm text-gray-600">Lembretes</div>
                            </div>
                            <div class="text-center p-4 bg-yellow-50 rounded-lg">
                                <div class="text-2xl font-bold text-yellow-600">${state.scanHistory.length}</div>
                                <div class="text-sm text-gray-600">QR Scans</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Inicializar gr√°ficos
            initDashboard();
        }

        // üöÄ INICIALIZA√á√ÉO COMPLETA
        async function initApp() {
            console.log('üöÄ Iniciando sistema completo...');
            
            // Carregar todos os dados
            await loadBackup();
            loadHistory();
            loadReminders();
            loadScanHistory();
            
            // Sincronizar com a planilha
            await syncWithSheet();
            
            // Inicializar m√≥dulos
            initKanban();
            initDashboard();
            
            // Iniciar auto-refresh se ativado
            if (state.autoRefresh) {
                state.syncInterval = setInterval(() => {
                    syncWithSheet(true);
                }, CONFIG.AUTO_REFRESH_INTERVAL);
            }
            
            console.log('‚úÖ Sistema inicializado com sucesso!');
            showNotification('‚úÖ Sistema completo carregado!', 'success');
        }

        // üì± FUN√á√ÉO PARA ALTERNAR ENTRE ABAS (ATUALIZADA)
        function switchTab(tabName) {
            state.currentTab = tabName;
            render();
            
            // Inicializar m√≥dulos espec√≠ficos da aba
            setTimeout(() => {
                if (tabName === 'dashboard') {
                    updateDashboardDisplay();
                } else if (tabName === 'lembretes') {
                    updateRemindersDisplay();
                } else if (tabName === 'kanban') {
                    updateKanbanDisplay();
                } else if (tabName === 'estoque') {
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) searchInput.focus();
                }
            }, 100);
        }

        // üé® RENDERIZA√á√ÉO PRINCIPAL (ATUALIZADA COM NOVAS ABAS)
        function render() {
            // Salvar o foco atual
            saveCurrentFocus();
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- HEADER (mantido) -->
                <header class="brand-gradient shadow-lg no-print">
                    <div class="container mx-auto px-4 py-4">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <!-- Logo e t√≠tulo -->
                            <div class="flex items-center gap-4">
                                <div class="brand-gradient rounded-xl p-3 text-white font-bold text-xl shadow-md">
                                    <span class="text-white">SUPER</span>
                                    <span class="text-yellow-300 ml-1">BRUNO</span>
                                </div>
                                <div>
                                    <h1 class="text-white text-xl md:text-2xl font-bold">Mapa de Estoque Inteligente</h1>
                                    <p class="text-yellow-200 text-sm flex items-center gap-2">
                                        ${state.connectionError ? 
                                            '<span class="pulse">‚ö†Ô∏è Modo Offline</span>' : 
                                            '<span>‚úÖ Sistema Online</span>'}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Bot√µes principais -->
                            <div class="flex flex-wrap gap-2">
                                <button onclick="openScanner()" 
                                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium">
                                    üîç Scanner
                                </button>
                                <button onclick="shareStockAlert()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                    üì± Alertas
                                </button>
                                <button onclick="toggleAutoRefresh()" 
                                        class="${state.autoRefresh ? 'btn-secondary' : 'bg-gray-500 text-white'} px-4 py-2 rounded-lg font-medium">
                                    ${state.autoRefresh ? 'üîÑ Auto' : '‚è∏Ô∏è Manual'}
                                </button>
                                <button onclick="syncWithSheet()" 
                                        class="btn-primary px-4 py-2 rounded-lg font-medium">
                                    üîÑ Sincronizar
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- ABAS PRINCIPAIS -->
                <div class="container mx-auto px-4">
                    <div class="flex overflow-x-auto border-b border-gray-200 mt-4 no-print">
                        <button class="tab-button ${state.currentTab === 'estoque' ? 'active' : ''}" 
                                onclick="switchTab('estoque')">
                            üì¶ Estoque (${state.stats.total})
                        </button>
                        <button class="tab-button ${state.currentTab === 'dashboard' ? 'active' : ''}" 
                                onclick="switchTab('dashboard')">
                            üìä Dashboard
                        </button>
                        <button class="tab-button ${state.currentTab === 'lembretes' ? 'active' : ''}" 
                                onclick="switchTab('lembretes')">
                            üìÖ Lembretes ${state.reminders.length > 0 ? `(${state.reminders.length})` : ''}
                        </button>
                        <button class="tab-button ${state.currentTab === 'kanban' ? 'active' : ''}" 
                                onclick="switchTab('kanban')">
                            üé® Kanban
                        </button>
                        <button class="tab-button ${state.currentTab === 'historico' ? 'active' : ''}" 
                                onclick="switchTab('historico')">
                            üìù Hist√≥rico ${state.historyStats.today > 0 ? `(${state.historyStats.today})` : ''}
                        </button>
                    </div>
                </div>

                <!-- CONTE√öDO DAS ABAS -->
                <main class="container mx-auto px-2 md:px-4 py-4 md:py-6">
                    <!-- Conte√∫do ser√° carregado dinamicamente -->
                    <div id="tabContent">
                        ${getTabContent()}
                    </div>
                </main>

                <!-- FOOTER -->
                <footer class="mt-8 pb-6 text-center text-gray-500 text-sm no-print">
                    <div class="container mx-auto px-4">
                        <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                            <div class="flex items-center gap-2">
                                ${state.connectionError ? 
                                    '<span class="text-orange-600">‚ö†Ô∏è Modo Offline</span>' :
                                    '<span class="text-green-600">‚úÖ Sistema Online</span>'}
                            </div>
                            <div class="hidden md:block text-gray-300">|</div>
                            <div>
                                üîÑ ${state.autoRefresh ? 'Atualiza√ß√£o: Autom√°tica (30s)' : 'Atualiza√ß√£o: Manual'}
                            </div>
                            ${state.lastUpdate ? `
                                <div class="hidden md:block text-gray-300">|</div>
                                <div class="text-gray-600">
                                    üïí √öltima sinc: ${getTimeSinceUpdate()}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </footer>
            `;
            
            // Restaurar foco
            restoreFocus();
        }

        function getTabContent() {
            switch(state.currentTab) {
                case 'dashboard':
                    return '<div id="dashboardContent"></div>';
                case 'lembretes':
                    return '<div id="remindersContent"></div>';
                case 'kanban':
                    return '<div id="kanbanContent"></div>';
                case 'historico':
                    // Conte√∫do do hist√≥rico (mantido do original)
                    return `
                        <div class="tab-content active" id="historicoContent">
                            <!-- Conte√∫do do hist√≥rico mantido -->
                        </div>
                    `;
                case 'estoque':
                default:
                    // Conte√∫do do estoque (mantido do original)
                    return `
                        <div class="tab-content active" id="estoqueContent">
                            <!-- Conte√∫do do estoque mantido -->
                        </div>
                    `;
            }
        }

        // ‚öôÔ∏è INICIALIZAR APLICA√á√ÉO
        document.addEventListener('DOMContentLoaded', initApp);

        // üéØ MANTER FUN√á√ïES ORIGINAIS DO SEU C√ìDIGO
        // (As fun√ß√µes originais como fetchLiveData, parseCSVData, etc. permanecem as mesmas)
        // ... [resto das fun√ß√µes originais que n√£o foram modificadas] ...

    </script>
</body>
</html>
