<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Estoque - SUPER BRUNO ATACADO</title>
    <meta name="theme-color" content="#a00b08">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.min.js"></script>
    
    <style>
        :root {
            --primary-red: #a00b08;
            --primary-yellow: #f4cf08;
            --primary-beige: #d8cfc4;
            --primary-dark-red: #4d0505;
            --primary-purple: #9c7c84;
        }
        
        .brand-gradient {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-dark-red) 100%);
        }
        
        .btn-primary {
            background-color: var(--primary-red);
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark-red);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-secondary {
            background-color: var(--primary-yellow);
            color: var(--primary-dark-red);
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #e0c000;
            transform: translateY(-1px);
        }
        
        /* Status Tags */
        .status-tag {
            display: inline-block !important;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 2px;
            line-height: 1.2;
            white-space: nowrap;
            border: 1px solid;
            transition: all 0.2s;
        }
        .status-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-mostruario { background-color: #fef9e7 !important; color: #7d6608 !important; border-color: #f4cf08 !important; }
        .status-embalado { background-color: #e8f8ef !important; color: #186a3b !important; border-color: #2ecc71 !important; }
        .status-frentedeloja { background-color: #e8f4fd !important; color: #1a5276 !important; border-color: #3498db !important; }
        .status-separadocd { background-color: #f4ecf7 !important; color: #6c3483 !important; border-color: #9b59b6 !important; }
        .status-montagem { background-color: #ebedef !important; color: #2c3e50 !important; border-color: #34495e !important; }
        .status-assistencia { background-color: #fdedec !important; color: #943126 !important; border-color: #e74c3c !important; }
        .status-default { background-color: #f8f9fa !important; color: #495057 !important; border-color: #dee2e6 !important; }

        /* Hist√≥rico */
        .history-added { background-color: #e8f6f3 !important; color: #0d6251 !important; border-left: 4px solid #2ecc71 !important; }
        .history-removed { background-color: #fde8e8 !important; color: #9b2c2c !important; border-left: 4px solid #e53e3e !important; }
        .history-modified { background-color: #fef3e2 !important; color: #b45309 !important; border-left: 4px solid #ed8936 !important; }
        .history-stock-up { background-color: #e6fffa !important; color: #234e52 !important; border-left: 4px solid #38b2ac !important; }
        .history-stock-down { background-color: #fff5f5 !important; color: #9b2c2c !important; border-left: 4px solid #fc8181 !important; }

        /* Lembretes */
        .reminder-pending { background-color: #fff3cd !important; border-left: 4px solid #ffc107 !important; }
        .reminder-in-progress { background-color: #cce5ff !important; border-left: 4px solid #007bff !important; }
        .reminder-completed { background-color: #d4edda !important; border-left: 4px solid #28a745 !important; }
        .reminder-overdue { background-color: #f8d7da !important; border-left: 4px solid #dc3545 !important; }
        
        .reminder-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-in-progress { background: #cce5ff; color: #004085; }
        .badge-completed { background: #d4edda; color: #155724; }
        .badge-overdue { background: #f8d7da; color: #721c24; }

        /* Kanban */
        .kanban-column {
            min-height: 500px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .kanban-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .kanban-card.dragging {
            opacity: 0.5;
        }

        /* Scanner */
        #qr-reader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        #qr-reader__dashboard_section {
            padding: 20px;
        }
        #qr-reader__scan_region {
            border-radius: 8px;
            overflow: hidden;
        }

        /* Anima√ß√µes */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Outros */
        .search-input { font-size: 16px !important; }
        .sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable:hover { background-color: rgba(255,255,255,0.1); }
        .stat-card { transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-text-sm { font-size: 0.875rem; }
            .search-input { height: 52px; padding: 14px 16px; }
            .kanban-column { min-height: 300px; margin-bottom: 20px; }
        }

        @media print {
            .no-print { display: none !important; }
            .print-full-width { width: 100% !important; }
        }

        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background-color: #e0e0e0;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-badge:hover {
            background-color: #d0d0d0;
        }
        .filter-badge.active {
            background-color: var(--primary-red);
            color: white;
        }

        /* Tabs */
        .tab-button {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-button.active {
            background: white;
            color: var(--primary-red);
            font-weight: 600;
            border-color: #dee2e6;
            position: relative;
            z-index: 10;
        }
        .tab-button:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 0 8px 8px 8px;
            background: white;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* History badges */
        .history-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }
        .badge-added { background: #d1f7c4; color: #0d6251; }
        .badge-removed { background: #ffe0e0; color: #9b2c2c; }
        .badge-modified { background: #fff4d9; color: #b45309; }
        .badge-stock-up { background: #d1f7f7; color: #234e52; }
        .badge-stock-down { background: #ffe0e0; color: #9b2c2c; }

        /* Calendar */
        .fc { font-size: 0.9rem !important; }
        .fc-toolbar-title { font-size: 1.2rem !important; }
        
        /* QR Code Display */
        .qrcode-container {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: inline-block;
        }

        /* WhatsApp */
        .whatsapp-floating {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading-spinner w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Iniciando sistema de estoque...</p>
                <p class="text-gray-400 text-sm mt-2">Carregando todas as funcionalidades</p>
            </div>
        </div>
    </div>

    <!-- Bot√£o Flutuante do WhatsApp -->
    <div class="whatsapp-floating no-print">
        <button onclick="openWhatsAppQuickMenu()"
                class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-full shadow-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-5.46-4.45-9.91-9.91-9.91zm5.26 13.83c-.25.71-1.52 1.3-2.12 1.39-.57.08-1.27.1-1.96-.1-.87-.24-1.66-.61-2.3-1.14-2.14-1.86-3.51-4.85-3.61-7.84-.02-.63.15-1.24.46-1.77.33-.56.96-.86 1.6-.86.2 0 .39.03.57.08.45.13.96.56 1.06 1.03.13.59.43 1.71.47 1.83.04.13.08.28.03.44-.05.15-.08.26-.16.39-.08.13-.17.29-.25.39-.08.13-.17.26-.07.5.1.26.45 1.07.97 1.73.68.86 1.34 1.41 2.06 1.77.26.13.47.21.64.27.26.1.5.09.69.05.2-.04.39-.17.54-.33.18-.2.4-.5.63-.82.23-.32.51-.35.81-.29.3.07 1.92.91 2.25 1.08.33.17.55.25.63.37.08.13.08.75-.17 1.45z"/>
            </svg>
        </button>
    </div>

    <script>
        // üîß CONFIGURA√á√ÉO PRINCIPAL
        const GOOGLE_SHEET_ID = '1zN6WXg-7mkb0mYOV8Hf3stQLD9wAdnyDKSPF5PfYK_M';
        const PUBLISHED_ID = '2PACX-1vTXIBXGqrCkz3-Fg07OBUq5Xv4jrXhpAvIXWrk9GiNoeD_so8qTHaxdPXBRTTOvkN1EUujUtVOPDU8f';
        const SHEET_NAME = 'P√°gina1';
        const AUTO_REFRESH_INTERVAL = 30000;
        const BACKUP_KEY = 'estoque_live_backup';
        const HISTORY_KEY = 'estoque_history';
        const REMINDERS_KEY = 'estoque_reminders';
        
        // üì± CONFIGURA√á√ÉO DO WHATSAPP (SEU N√öMERO)
        const WHATSAPP_NUMBER = '55022988575740'; // Seu n√∫mero formatado
        const WHATSAPP_GROUP_ID = ''; // Opcional: ID do grupo para alertas
        
        const DEBUG_MODE = true;
        const USE_PUBLISHED_VERSION = true;
        
        // üìä ESTADO GLOBAL
        let state = {
            items: [],
            previousItems: [],
            loading: true,
            searchTerm: '',
            filteredItems: [],
            lastUpdate: null,
            connectionError: false,
            sortField: 'codigo',
            sortDirection: 'asc',
            autoRefresh: true,
            syncInterval: null,
            locationFilter: 'all',
            stockFilter: 'all',
            currentTab: 'estoque',
            historyFilter: 'all',
            stats: {
                total: 0,
                inStock: 0,
                outOfStock: 0,
                lowStock: 0
            },
            history: [],
            historyStats: {
                today: 0,
                added: 0,
                removed: 0,
                modified: 0
            },
            reminders: [],
            charts: null,
            calendar: null,
            qrScanner: null
        };

        let searchDebounceTimer = null;
        let lastFocusedElementId = null;
        let draggedCard = null;

        // ==================== üì± WHATSAPP INTEGRATION ====================

        // üì± ABRIR MENU R√ÅPIDO DO WHATSAPP
        function openWhatsAppQuickMenu() {
            const menu = document.createElement('div');
            menu.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            menu.innerHTML = `
                <div class="bg-white rounded-lg max-w-sm w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">üì± WhatsApp</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="sendStockReport()"
                                    class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 flex items-center gap-3">
                                <span class="text-green-600 text-xl">üìä</span>
                                <div>
                                    <div class="font-medium">Relat√≥rio de Estoque</div>
                                    <div class="text-sm text-gray-500">Enviar resumo atual</div>
                                </div>
                            </button>
                            
                            <button onclick="sendLowStockAlert()"
                                    class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 flex items-center gap-3">
                                <span class="text-red-600 text-xl">‚ö†Ô∏è</span>
                                <div>
                                    <div class="font-medium">Alertas de Estoque Baixo</div>
                                    <div class="text-sm text-gray-500">Produtos com menos de 3 unidades</div>
                                </div>
                            </button>
                            
                            <button onclick="sendTodayReminders()"
                                    class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 flex items-center gap-3">
                                <span class="text-blue-600 text-xl">üìÖ</span>
                                <div>
                                    <div class="font-medium">Lembretes de Hoje</div>
                                    <div class="text-sm text-gray-500">Entregas e compromissos</div>
                                </div>
                            </button>
                            
                            <button onclick="showWhatsAppQR()"
                                    class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 flex items-center gap-3">
                                <span class="text-purple-600 text-xl">üî≤</span>
                                <div>
                                    <div class="font-medium">QR Code do Grupo</div>
                                    <div class="text-sm text-gray-500">Entrar no grupo de alertas</div>
                                </div>
                            </button>
                            
                            <button onclick="openWhatsAppContact()"
                                    class="w-full text-left p-3 rounded-lg border border-gray-200 hover:bg-gray-50 flex items-center gap-3">
                                <span class="text-green-600 text-xl">üí¨</span>
                                <div>
                                    <div class="font-medium">Conversar Diretamente</div>
                                    <div class="text-sm text-gray-500">Abrir conversa no WhatsApp</div>
                                </div>
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <div class="text-sm text-gray-500 mb-2">N√∫mero configurado:</div>
                            <div class="font-mono bg-gray-100 p-2 rounded">+${WHATSAPP_NUMBER}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(menu);
        }

        // üìä ENVIAR RELAT√ìRIO DE ESTOQUE
        function sendStockReport() {
            const stats = state.stats;
            const reminderStats = updateReminderStats();
            
            const message = `üìä *RELAT√ìRIO DE ESTOQUE - SUPER BRUNO*\n\n` +
                          `üì¶ *Produtos:* ${stats.total}\n` +
                          `‚úÖ *Em estoque:* ${stats.inStock}\n` +
                          `‚ö†Ô∏è *Estoque baixo:* ${stats.lowStock}\n` +
                          `‚ùå *Esgotados:* ${stats.outOfStock}\n\n` +
                          `üìÖ *Lembretes hoje:* ${reminderStats.today}\n` +
                          `‚è∞ *Atrasados:* ${reminderStats.overdue}\n\n` +
                          `üîÑ *√öltima atualiza√ß√£o:* ${state.lastUpdate ? state.lastUpdate.toLocaleTimeString('pt-BR') : 'N/A'}\n\n` +
                          `_Enviado automaticamente pelo Sistema de Estoque_`;
            
            sendWhatsAppMessage(message);
            document.querySelector('.fixed').remove();
        }

        // ‚ö†Ô∏è ENVIAR ALERTA DE ESTOQUE BAIXO
        function sendLowStockAlert() {
            const lowStockItems = state.items.filter(item => item.quantidade > 0 && item.quantidade <= 3);
            
            if (lowStockItems.length === 0) {
                showNotification('‚úÖ Nenhum produto com estoque baixo', 'success');
                return;
            }
            
            let message = `‚ö†Ô∏è *ALERTA: ESTOQUE BAIXO*\n\n`;
            
            lowStockItems.slice(0, 10).forEach((item, index) => {
                message += `${index + 1}. *${item.codigo}* - ${item.nome}\n`;
                message += `   üì¶ Quantidade: ${item.quantidade}\n`;
                message += `   üìç ${item.observacoes || 'Localiza√ß√£o n√£o informada'}\n\n`;
            });
            
            if (lowStockItems.length > 10) {
                message += `... e mais ${lowStockItems.length - 10} produtos\n\n`;
            }
            
            message += `üì± *Total de produtos:* ${lowStockItems.length}\n`;
            message += `‚è∞ *Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            message += `_Sistema de alertas autom√°ticos_`;
            
            sendWhatsAppMessage(message);
            document.querySelector('.fixed').remove();
        }

        // üìÖ ENVIAR LEMBRETES DE HOJE
        function sendTodayReminders() {
            const today = new Date().toDateString();
            const todayReminders = state.reminders.filter(r => 
                new Date(r.dueDate).toDateString() === today && r.status !== 'completed'
            );
            
            if (todayReminders.length === 0) {
                showNotification('‚úÖ Nenhum lembrete para hoje', 'success');
                return;
            }
            
            let message = `üìÖ *LEMBRETES PARA HOJE* (${new Date().toLocaleDateString('pt-BR')})\n\n`;
            
            todayReminders.forEach((reminder, index) => {
                const statusEmoji = reminder.status === 'overdue' ? 'üî¥' : 
                                  reminder.status === 'in-progress' ? 'üü°' : 'üü¢';
                
                message += `${statusEmoji} *${reminder.title}*\n`;
                if (reminder.client) message += `   üë§ Cliente: ${reminder.client}\n`;
                if (reminder.productCode) message += `   üì¶ Produto: ${reminder.productCode}\n`;
                if (reminder.description) message += `   üìù ${reminder.description}\n`;
                message += `   ‚è∞ Status: ${getReminderStatusLabel(reminder.status)}\n\n`;
            });
            
            message += `üìã *Total:* ${todayReminders.length} lembretes\n`;
            message += `_Sistema de gerenciamento de entregas_`;
            
            sendWhatsAppMessage(message);
            document.querySelector('.fixed').remove();
        }

        // üî≤ MOSTRAR QR CODE DO GRUPO
        function showWhatsAppQR() {
            if (!WHATSAPP_GROUP_ID) {
                showNotification('‚ÑπÔ∏è Configure o ID do grupo do WhatsApp', 'info');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-sm w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">üî≤ QR Code do Grupo</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <div class="text-center mb-4">
                            <p class="text-gray-600 mb-4">Escaneie para entrar no grupo de alertas</p>
                            <div id="whatsapp-group-qr" class="inline-block p-4 bg-white rounded-lg border"></div>
                        </div>
                        
                        <div class="text-center">
                            <a href="https://chat.whatsapp.com/${WHATSAPP_GROUP_ID}"
                               target="_blank"
                               class="inline-block bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                üì± Entrar no Grupo
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Gerar QR Code
            setTimeout(() => {
                const qrContainer = document.getElementById('whatsapp-group-qr');
                if (qrContainer) {
                    const groupUrl = `https://chat.whatsapp.com/${WHATSAPP_GROUP_ID}`;
                    QRCode.toCanvas(qrContainer, groupUrl, {
                        width: 200,
                        margin: 1,
                        color: {
                            dark: '#25D366',
                            light: '#ffffff'
                        }
                    });
                }
            }, 100);
        }

        // üí¨ ABRIR CONTATO DO WHATSAPP
        function openWhatsAppContact() {
            const message = `Ol√°! Gostaria de falar sobre o sistema de estoque.`;
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
            document.querySelector('.fixed').remove();
        }

        // üì§ ENVIAR MENSAGEM NO WHATSAPP
        function sendWhatsAppMessage(message) {
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // üì± COMPARTILHAR PRODUTO VIA WHATSAPP
        function shareProductViaWhatsApp(product, messageType = 'info') {
            let message = '';
            
            switch(messageType) {
                case 'low_stock':
                    message = `‚ö†Ô∏è *ESTOQUE BAIXO*\n\n` +
                             `*Produto:* ${product.nome}\n` +
                             `*C√≥digo:* ${product.codigo}\n` +
                             `*Quantidade:* ${product.quantidade} unidades\n` +
                             `*Localiza√ß√£o:* ${product.observacoes || 'N√£o informada'}\n\n` +
                             `üì± _Sistema de alertas autom√°ticos_`;
                    break;
                    
                case 'reminder':
                    message = `üìÖ *LEMBRETE DE ENTREGA*\n\n` +
                             `*Produto:* ${product.nome}\n` +
                             `*C√≥digo:* ${product.codigo}\n` +
                             `*Quantidade:* ${product.quantidade} unidades\n` +
                             `*Preparar para entrega*\n\n` +
                             `üì± _Sistema de gerenciamento_`;
                    break;
                    
                case 'info':
                default:
                    message = `üì¶ *INFORMA√á√ÉO DO PRODUTO*\n\n` +
                             `*Produto:* ${product.nome}\n` +
                             `*C√≥digo:* ${product.codigo}\n` +
                             `*Quantidade:* ${product.quantidade} unidades\n` +
                             `*Localiza√ß√£o:* ${product.observacoes || 'N√£o informada'}\n` +
                             `*Plataforma:* ${product.plataforma}\n\n` +
                             `üì± _Sistema de estoque - SUPER BRUNO_`;
            }
            
            sendWhatsAppMessage(message);
        }

        // üîî COMPARTILHAR RELAT√ìRIO DE LEMBRETES
        function shareRemindersReport() {
            const reminderStats = updateReminderStats();
            const overdueReminders = state.reminders.filter(r => {
                if (!r.dueDate || r.status === 'completed') return false;
                return new Date(r.dueDate) < new Date();
            });
            
            let message = `üìã *RELAT√ìRIO DE LEMBRETES*\n\n` +
                         `üìÖ *Total:* ${reminderStats.total} lembretes\n` +
                         `‚è≥ *Pendentes:* ${reminderStats.pending}\n` +
                         `üöÄ *Em andamento:* ${reminderStats.inProgress}\n` +
                         `‚úÖ *Conclu√≠dos:* ${reminderStats.completed}\n` +
                         `‚ö†Ô∏è *Atrasados:* ${reminderStats.overdue}\n\n`;
            
            if (overdueReminders.length > 0) {
                message += `üî¥ *ATEN√á√ÉO - ATRASADOS:*\n`;
                overdueReminders.slice(0, 5).forEach(reminder => {
                    message += `‚Ä¢ ${reminder.title} - ${reminder.client || 'Sem cliente'}\n`;
                });
                if (overdueReminders.length > 5) {
                    message += `... e mais ${overdueReminders.length - 5}\n`;
                }
                message += `\n`;
            }
            
            message += `üìä *Lembretes para hoje:* ${reminderStats.today}\n`;
            message += `‚è∞ *Data:* ${new Date().toLocaleDateString('pt-BR')}\n\n`;
            message += `_Sistema de gerenciamento de entregas_`;
            
            sendWhatsAppMessage(message);
        }

        // ==================== üìÖ SISTEMA DE LEMBRETES ====================
        
        // üìù INICIALIZAR LEMBRETES
        function initReminders() {
            loadReminders();
            initCalendar();
        }

        // üíæ CARREGAR LEMBRETES
        function loadReminders() {
            try {
                const savedReminders = localStorage.getItem(REMINDERS_KEY);
                if (savedReminders) {
                    state.reminders = JSON.parse(savedReminders);
                    console.log(`üìÖ Lembretes carregados: ${state.reminders.length}`);
                    updateReminderStats();
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar lembretes:', error);
            }
            return false;
        }

        // üíæ SALVAR LEMBRETES
        function saveReminders() {
            try {
                localStorage.setItem(REMINDERS_KEY, JSON.stringify(state.reminders));
                updateReminderStats();
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar lembretes:', error);
                return false;
            }
        }

        // ‚ûï ADICIONAR LEMBRETE
        function addReminder(reminder) {
            reminder.id = `reminder_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            reminder.createdAt = new Date();
            reminder.status = 'pending';
            
            state.reminders.push(reminder);
            saveReminders();
            
            // Adicionar ao calend√°rio
            if (state.calendar && reminder.dueDate) {
                addReminderToCalendar(reminder);
            }
            
            showNotification('üìÖ Lembrete adicionado!', 'success');
            return reminder;
        }

        // ‚úèÔ∏è EDITAR LEMBRETE
        function updateReminder(id, updates) {
            const index = state.reminders.findIndex(r => r.id === id);
            if (index !== -1) {
                state.reminders[index] = { ...state.reminders[index], ...updates };
                saveReminders();
                
                // Atualizar no calend√°rio
                if (state.calendar && updates.dueDate) {
                    updateReminderInCalendar(state.reminders[index]);
                }
                
                return true;
            }
            return false;
        }

        // üóëÔ∏è REMOVER LEMBRETE
        function deleteReminder(id) {
            const index = state.reminders.findIndex(r => r.id === id);
            if (index !== -1) {
                const reminder = state.reminders[index];
                state.reminders.splice(index, 1);
                saveReminders();
                
                // Remover do calend√°rio
                if (state.calendar) {
                    removeReminderFromCalendar(reminder);
                }
                
                return true;
            }
            return false;
        }

        // üîÑ MUDAR STATUS DO LEMBRETE
        function changeReminderStatus(id, newStatus) {
            return updateReminder(id, { status: newStatus });
        }

        // üìä ATUALIZAR ESTAT√çSTICAS DOS LEMBRETES
        function updateReminderStats() {
            const today = new Date().toDateString();
            const todayReminders = state.reminders.filter(r => 
                new Date(r.dueDate).toDateString() === today
            );
            
            const overdueReminders = state.reminders.filter(r => {
                if (!r.dueDate || r.status === 'completed') return false;
                return new Date(r.dueDate) < new Date();
            });

            return {
                total: state.reminders.length,
                pending: state.reminders.filter(r => r.status === 'pending').length,
                inProgress: state.reminders.filter(r => r.status === 'in-progress').length,
                completed: state.reminders.filter(r => r.status === 'completed').length,
                overdue: overdueReminders.length,
                today: todayReminders.length
            };
        }

        // üóìÔ∏è INICIALIZAR CALEND√ÅRIO
        function initCalendar() {
            const calendarEl = document.getElementById('reminderCalendar');
            if (!calendarEl) return;

            state.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: getCalendarEvents(),
                eventClick: function(info) {
                    showReminderDetails(info.event.id);
                },
                dateClick: function(info) {
                    openNewReminderModal(info.dateStr);
                },
                eventColor: '#a00b08',
                eventTextColor: 'white'
            });

            state.calendar.render();
        }

        // üìÖ OBTER EVENTOS PARA O CALEND√ÅRIO
        function getCalendarEvents() {
            return state.reminders
                .filter(r => r.dueDate)
                .map(reminder => ({
                    id: reminder.id,
                    title: reminder.title,
                    start: reminder.dueDate,
                    color: getReminderColor(reminder.status),
                    extendedProps: {
                        product: reminder.productCode,
                        client: reminder.client,
                        description: reminder.description
                    }
                }));
        }

        // üé® OBTER COR DO LEMBRETE
        function getReminderColor(status) {
            switch(status) {
                case 'pending': return '#ffc107';
                case 'in-progress': return '#007bff';
                case 'completed': return '#28a745';
                case 'overdue': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // üè∑Ô∏è OBTER LABEL DO STATUS
        function getReminderStatusLabel(status) {
            switch(status) {
                case 'pending': return 'PENDENTE';
                case 'in-progress': return 'EM ANDAMENTO';
                case 'completed': return 'CONCLU√çDO';
                case 'overdue': return 'ATRASADO';
                default: return status.toUpperCase();
            }
        }

        // üìÖ FORMATAR DATA
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // üÜï ABRIR MODAL DE NOVO LEMBRETE
        function openNewReminderModal(prefilledDate = null) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Novo Lembrete</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <form id="new-reminder-form" onsubmit="return submitNewReminder(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        T√≠tulo *
                                    </label>
                                    <input type="text" 
                                           name="title"
                                           required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="Ex: Entregar produto para cliente">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Descri√ß√£o
                                    </label>
                                    <textarea name="description"
                                              rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                              placeholder="Detalhes adicionais..."></textarea>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Cliente
                                        </label>
                                        <input type="text" 
                                               name="client"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                               placeholder="Nome do cliente">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            C√≥digo do Produto
                                        </label>
                                        <input type="text" 
                                               name="productCode"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                               placeholder="C√≥digo do produto">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Data de Vencimento *
                                        </label>
                                        <input type="date" 
                                               name="dueDate"
                                               required
                                               value="${prefilledDate || ''}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Prioridade
                                        </label>
                                        <select name="priority"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="normal">Normal</option>
                                            <option value="high">Alta</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button"
                                        onclick="this.parentElement.parentElement.parentElement.parentElement.remove()"
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    Cancelar
                                </button>
                                <button type="submit"
                                        class="btn-primary px-6 py-2 rounded-lg">
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-focus no primeiro campo
            setTimeout(() => {
                const firstInput = modal.querySelector('input');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        // üìù SUBMIT DO NOVO LEMBRETE
        function submitNewReminder(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const reminder = {
                title: formData.get('title'),
                description: formData.get('description'),
                client: formData.get('client'),
                productCode: formData.get('productCode'),
                dueDate: formData.get('dueDate'),
                priority: formData.get('priority'),
                status: 'pending'
            };
            
            addReminder(reminder);
            form.closest('.fixed').remove();
            
            // Atualizar display
            if (state.currentTab === 'lembretes') {
                updateRemindersDisplay();
            }
            
            return false;
        }

        // ==================== üî≤ SISTEMA DE QR CODES ====================

        // üî≤ GERAR QR CODE
        function generateQRCode(productId, productName) {
            return new Promise((resolve, reject) => {
                const text = `SUPER BRUNO ATACADO\nProduto: ${productName}\nC√≥digo: ${productId}\nData: ${new Date().toLocaleDateString('pt-BR')}\n\nEscaneie para ver detalhes`;
                const container = document.createElement('div');
                
                QRCode.toCanvas(container, text, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#a00b08',
                        light: '#ffffff'
                    }
                }, function(error, canvas) {
                    if (error) {
                        reject(error);
                    } else {
                        resolve(canvas.toDataURL('image/png'));
                    }
                });
            });
        }

        // üñ®Ô∏è IMPRIMIR QR CODE
        function printQRCode(product) {
            generateQRCode(product.codigo, product.nome).then(qrDataURL => {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>QR Code - ${product.codigo}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .container { text-align: center; }
                            .product-info { margin-bottom: 20px; }
                            .qrcode { margin: 20px auto; }
                            @media print {
                                body { padding: 0; }
                                .no-print { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="product-info">
                                <h2 style="color: #a00b08; margin-bottom: 5px;">SUPER BRUNO ATACADO</h2>
                                <h3 style="margin: 10px 0;">${product.codigo}</h3>
                                <p style="margin: 5px 0;"><strong>${product.nome}</strong></p>
                                <p style="margin: 5px 0;">Quantidade: ${product.quantidade}</p>
                                <p style="margin: 5px 0;">${product.plataforma}</p>
                            </div>
                            <div class="qrcode">
                                <img src="${qrDataURL}" alt="QR Code" style="width: 250px; height: 250px;">
                            </div>
                            <p style="margin-top: 20px; font-size: 12px; color: #666;">
                                Escaneie o c√≥digo para ver detalhes do produto
                            </p>
                            <button class="no-print" onclick="window.print()" 
                                    style="margin-top: 20px; padding: 10px 20px; background: #a00b08; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                üñ®Ô∏è Imprimir
                            </button>
                        </div>
                        <script>
                            setTimeout(() => window.print(), 500);
                            window.onafterprint = () => window.close();
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }).catch(error => {
                console.error('Erro ao gerar QR Code:', error);
                showNotification('‚ùå Erro ao gerar QR Code', 'error');
            });
        }

        // ==================== üé® FUN√á√ïES AUXILIARES ====================

        // üéØ MOSTRAR DETALHES DO PRODUTO
        function showProductDetails(productCode) {
            const product = state.items.find(p => p.codigo === productCode);
            if (!product) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-bold text-gray-900">${product.nome}</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-500">C√≥digo</label>
                                <p class="font-mono font-bold text-red-700">${product.codigo}</p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Quantidade</label>
                                <p class="text-2xl font-bold ${product.quantidade === 0 ? 'text-red-600' : 
                                  product.quantidade <= 3 ? 'text-yellow-600' : 'text-green-600'}">
                                    ${product.quantidade}
                                </p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Plataforma</label>
                                <p>${product.plataforma}</p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Localiza√ß√£o</label>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${formatObservacoes(product.observacoes)}
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">√öltima atualiza√ß√£o</label>
                                <p>${state.lastUpdate ? state.lastUpdate.toLocaleString('pt-BR') : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <button onclick="printQRCode(${JSON.stringify(product).replace(/"/g, '&quot;')})"
                                    class="btn-primary py-2 rounded-lg">
                                üî≤ Imprimir QR Code
                            </button>
                            <button onclick="shareProductViaWhatsApp(${JSON.stringify(product).replace(/"/g, '&quot;')})"
                                    class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                                üì± WhatsApp
                            </button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button onclick="openNewReminderModalWithProduct('${product.codigo}')"
                                    class="text-blue-600 hover:text-blue-800">
                                üìÖ Criar lembrete para este produto
                            </button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <div id="product-qr-code" class="inline-block"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Gerar QR Code do produto
            setTimeout(() => {
                generateQRCode(product.codigo, product.nome).then(qrDataURL => {
                    const qrContainer = document.getElementById('product-qr-code');
                    if (qrContainer) {
                        qrContainer.innerHTML = `<img src="${qrDataURL}" alt="QR Code" class="mx-auto">`;
                    }
                });
            }, 100);
        }

        // üÜï ABRIR LEMBRETE COM PRODUTO PR√â-SELECIONADO
        function openNewReminderModalWithProduct(productCode) {
            const product = state.items.find(p => p.codigo === productCode);
            if (!product) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Novo Lembrete</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800">Produto selecionado:</p>
                            <p class="font-bold">${product.nome}</p>
                            <p class="text-sm">C√≥digo: ${product.codigo}</p>
                        </div>
                        
                        <form id="new-reminder-form" onsubmit="return submitNewReminderWithProduct(event, '${productCode}')">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        T√≠tulo *
                                    </label>
                                    <input type="text" 
                                           name="title"
                                           required
                                           value="Entregar ${product.nome}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Cliente
                                    </label>
                                    <input type="text" 
                                           name="client"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="Nome do cliente">
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Data de Entrega *
                                        </label>
                                        <input type="date" 
                                               name="dueDate"
                                               required
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Prioridade
                                        </label>
                                        <select name="priority"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="normal">Normal</option>
                                            <option value="high">Alta</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Observa√ß√µes
                                    </label>
                                    <textarea name="description"
                                              rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                              placeholder="Detalhes da entrega..."></textarea>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button"
                                        onclick="this.parentElement.parentElement.parentElement.parentElement.remove()"
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    Cancelar
                                </button>
                                <button type="submit"
                                        class="btn-primary px-6 py-2 rounded-lg">
                                    Salvar Lembrete
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-focus no primeiro campo
            setTimeout(() => {
                const firstInput = modal.querySelector('input');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        // üìù SUBMIT LEMBRETE COM PRODUTO
        function submitNewReminderWithProduct(event, productCode) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const product = state.items.find(p => p.codigo === productCode);
            
            const reminder = {
                title: formData.get('title'),
                description: formData.get('description'),
                client: formData.get('client'),
                productCode: productCode,
                productName: product ? product.nome : '',
                dueDate: formData.get('dueDate'),
                priority: formData.get('priority'),
                status: 'pending'
            };
            
            addReminder(reminder);
            form.closest('.fixed').remove();
            
            // Atualizar display
            if (state.currentTab === 'lembretes') {
                updateRemindersDisplay();
            }
            
            // Opcional: Compartilhar no WhatsApp
            setTimeout(() => {
                if (confirm('Deseja compartilhar este lembrete no WhatsApp?')) {
                    const message = `üìÖ *NOVO LEMBRETE CRIADO*\n\n` +
                                  `*Produto:* ${product.nome}\n` +
                                  `*C√≥digo:* ${product.codigo}\n` +
                                  `*Cliente:* ${reminder.client || 'N√£o especificado'}\n` +
                                  `*Data de entrega:* ${formatDate(reminder.dueDate)}\n` +
                                  `*Prioridade:* ${reminder.priority === 'high' ? 'ALTA' : 'Normal'}\n\n` +
                                  `_Sistema de gerenciamento de entregas_`;
                    
                    sendWhatsAppMessage(message);
                }
            }, 500);
            
            return false;
        }

        // üéØ MOSTRAR DETALHES DO LEMBRETE
        function showReminderDetails(reminderId) {
            const reminder = state.reminders.find(r => r.id === reminderId);
            if (!reminder) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="reminder-badge badge-${reminder.status} mb-2">
                                    ${getReminderStatusLabel(reminder.status)}
                                </span>
                                <h3 class="text-xl font-bold text-gray-900">${reminder.title}</h3>
                            </div>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        ${reminder.description ? `
                            <div class="mb-4">
                                <label class="text-sm text-gray-500">Descri√ß√£o</label>
                                <p class="text-gray-700">${reminder.description}</p>
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            ${reminder.client ? `
                                <div>
                                    <label class="text-sm text-gray-500">Cliente</label>
                                    <p class="font-medium">${reminder.client}</p>
                                </div>
                            ` : ''}
                            
                            ${reminder.productCode ? `
                                <div>
                                    <label class="text-sm text-gray-500">Produto</label>
                                    <p class="font-mono">${reminder.productCode}</p>
                                    ${reminder.productName ? `<p class="text-sm">${reminder.productName}</p>` : ''}
                                </div>
                            ` : ''}
                            
                            <div>
                                <label class="text-sm text-gray-500">Data</label>
                                <p>${reminder.dueDate ? formatDate(reminder.dueDate) : 'N√£o definida'}</p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Prioridade</label>
                                <p>${reminder.priority === 'high' ? '‚ö†Ô∏è Alta' : 'Normal'}</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-3 gap-2">
                            <button onclick="changeReminderStatus('${reminder.id}', 'pending'); this.parentElement.parentElement.parentElement.remove()"
                                    class="py-2 rounded-lg ${reminder.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100'}">
                                Pendente
                            </button>
                            <button onclick="changeReminderStatus('${reminder.id}', 'in-progress'); this.parentElement.parentElement.parentElement.remove()"
                                    class="py-2 rounded-lg ${reminder.status === 'in-progress' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">
                                Andamento
                            </button>
                            <button onclick="changeReminderStatus('${reminder.id}', 'completed'); this.parentElement.parentElement.parentElement.remove()"
                                    class="py-2 rounded-lg ${reminder.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-gray-100'}">
                                Conclu√≠do
                            </button>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="shareReminderViaWhatsApp('${reminder.id}')"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                                üì± Compartilhar
                            </button>
                            <button onclick="deleteReminder('${reminder.id}'); this.parentElement.parentElement.parentElement.remove()"
                                    class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // üì± COMPARTILHAR LEMBRETE VIA WHATSAPP
        function shareReminderViaWhatsApp(reminderId) {
            const reminder = state.reminders.find(r => r.id === reminderId);
            if (!reminder) return;
            
            const product = reminder.productCode ? state.items.find(p => p.codigo === reminder.productCode) : null;
            
            const message = `üìÖ *LEMBRETE: ${reminder.title}*\n\n` +
                          `${reminder.client ? `üë§ *Cliente:* ${reminder.client}\n` : ''}` +
                          `${product ? `üì¶ *Produto:* ${product.nome} (${product.codigo})\n` : ''}` +
                          `${reminder.productCode && !product ? `üì¶ *C√≥digo:* ${reminder.productCode}\n` : ''}` +
                          `üìÖ *Data:* ${reminder.dueDate ? formatDate(reminder.dueDate) : 'N√£o definida'}\n` +
                          `‚ö° *Status:* ${getReminderStatusLabel(reminder.status)}\n` +
                          `${reminder.priority === 'high' ? `‚ö†Ô∏è *PRIORIDADE ALTA*\n` : ''}` +
                          `${reminder.description ? `\nüìù *Observa√ß√µes:*\n${reminder.description}\n` : ''}\n` +
                          `_Sistema de gerenciamento de entregas_`;
            
            sendWhatsAppMessage(message);
        }

        // ==================== üîß FUN√á√ïES DO SISTEMA ORIGINAL ====================

        // üìä BUSCAR DADOS DA PLANILHA
        async function fetchLiveData() {
            try {
                state.previousItems = [...state.items];
                let url = USE_PUBLISHED_VERSION 
                    ? `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?output=csv&gid=0&t=${Date.now()}`
                    : `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
                
                const response = await fetch(url, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                
                const csvData = await response.text();
                const items = parseCSVData(csvData);
                
                if (items.length > 0) {
                    state.items = items;
                    state.connectionError = false;
                    state.lastUpdate = new Date();
                    
                    // Salvar backup
                    localStorage.setItem(BACKUP_KEY, JSON.stringify({
                        items: items,
                        timestamp: Date.now()
                    }));
                    
                    updateStats();
                    loadHistory();
                    return true;
                }
                throw new Error('Nenhum produto encontrado');
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados:', error);
                return loadBackup() || false;
            }
        }

        // üìù ANALISAR CSV
        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const items = [];
            
            for (let i = 1; i < lines.length; i++) {
                try {
                    const cells = lines[i].split(',').map(cell => 
                        cell.replace(/^["']|["']$/g, '').trim()
                    );
                    
                    if (cells.length < 3) continue;
                    
                    const codigo = cells[0] || '';
                    const nome = cells[1] || '';
                    const quantidade = parseInt(cells[2]) || 0;
                    const plataforma = cells[3] || 'N√£o informado';
                    const observacoes = cells[4] || '';
                    
                    if (codigo && nome) {
                        items.push({
                            id: `item_${i}_${Date.now()}`,
                            codigo,
                            nome,
                            quantidade,
                            plataforma,
                            observacoes,
                            data_entrada: new Date().toISOString().split('T')[0],
                            updated_at: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro na linha ${i}:`, error);
                }
            }
            
            return items;
        }

        // üìä ATUALIZAR ESTAT√çSTICAS
        function updateStats() {
            const total = state.items.length;
            const inStock = state.items.filter(i => i.quantidade > 0).length;
            const outOfStock = state.items.filter(i => i.quantidade === 0).length;
            const lowStock = state.items.filter(i => i.quantidade > 0 && i.quantidade <= 3).length;
            
            state.stats = { total, inStock, outOfStock, lowStock };
        }

        // üì¢ NOTIFICA√á√ÉO
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-orange-500',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification-enter fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="text-white hover:text-gray-200 font-bold text-xl leading-none">√ó</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }

        // üïí TEMPO DESDE ATUALIZA√á√ÉO
        function getTimeSinceUpdate() {
            if (!state.lastUpdate) return 'Nunca';
            const diff = Date.now() - state.lastUpdate.getTime();
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            if (minutes < 60) return `${minutes}min atr√°s`;
            if (hours < 24) return `${hours}h atr√°s`;
            return state.lastUpdate.toLocaleDateString('pt-BR');
        }

        // üé® FORMATAR OBSERVA√á√ïES
        function formatObservacoes(observacoes) {
            if (!observacoes || observacoes.trim() === '') {
                return '<span class="status-tag status-default">Sem informa√ß√µes</span>';
            }
            
            return observacoes.split(/[,\.]| e |\//)
                .filter(p => p.trim())
                .map(parte => {
                    const texto = parte.trim().toLowerCase();
                    let statusClass = 'status-default';
                    const statusMap = {
                        'status-mostruario': ['mostruario', 'mostru√°rio', 'amostra', 'vitrine'],
                        'status-embalado': ['embalado', 'caixa', 'box', 'lacrado'],
                        'status-frentedeloja': ['frente', 'loja', 'vitrine', 'exposi', 'prateleira'],
                        'status-separadocd': ['separado', 'cd', 'centro', 'distribui', 'deposito', 'dep√≥sito'],
                        'status-montagem': ['montar', 'montagem', 'montado', 'armar', 'desmontado'],
                        'status-assistencia': ['assistencia', 'assist√™ncia', 'conserto', 'reparo', 'manuten', 'defeito']
                    };
                    for (const [className, keywords] of Object.entries(statusMap)) {
                        if (keywords.some(keyword => texto.includes(keyword))) {
                            statusClass = className;
                            break;
                        }
                    }
                    return `<span class="status-tag ${statusClass}">${parte.trim()}</span>`;
                }).join(' ');
        }

        // ==================== üöÄ INICIALIZA√á√ÉO ====================

        async function initApp() {
            console.log('üöÄ Iniciando sistema completo...');
            
            // Carregar dados iniciais
            await syncWithSheet();
            
            // Inicializar sistemas
            initReminders();
            
            // Configurar auto-refresh
            if (state.autoRefresh) {
                state.syncInterval = setInterval(() => {
                    syncWithSheet(true);
                }, AUTO_REFRESH_INTERVAL);
            }
            
            if (!state.connectionError) {
                showNotification('‚úÖ Sistema completo carregado!', 'success');
            }
        }

        // üîÑ SINCRONIZAR
        async function syncWithSheet(silent = false) {
            const wasLoading = state.loading;
            if (!silent) {
                state.loading = true;
                render();
            }
            
            const success = await fetchLiveData();
            state.loading = false;
            
            if (!success && !silent) {
                showNotification('‚ùå Erro ao conectar. Usando dados salvos.', 'error');
            } else if (!wasLoading && !silent) {
                showNotification('‚úÖ Dados atualizados!', 'success');
            }
            
            applySortingAndFiltering();
            render();
        }

        // ==================== üéØ RENDERIZA√á√ÉO (SIMPLIFICADA) ====================

        function render() {
            // Renderiza√ß√£o simplificada para exemplo
            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- HEADER -->
                <header class="brand-gradient shadow-lg no-print">
                    <div class="container mx-auto px-4 py-4">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                                <div class="brand-gradient rounded-xl p-3 text-white font-bold text-xl shadow-md">
                                    <span class="text-white">SUPER</span>
                                    <span class="text-yellow-300 ml-1">BRUNO</span>
                                </div>
                                <div>
                                    <h1 class="text-white text-xl md:text-2xl font-bold">Mapa de Estoque</h1>
                                    <p class="text-yellow-200 text-sm flex items-center gap-2">
                                        ${state.connectionError ? 
                                            '<span class="pulse">‚ö†Ô∏è Modo Offline</span>' : 
                                            '<span>‚úÖ Ao Vivo</span>'}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <button onclick="toggleAutoRefresh()" 
                                        class="${state.autoRefresh ? 'btn-secondary' : 'bg-gray-500 text-white'} px-4 py-2 rounded-lg font-medium">
                                    ${state.autoRefresh ? 'üîÑ Auto' : '‚è∏Ô∏è Manual'}
                                </button>
                                <button onclick="syncWithSheet()" 
                                        class="btn-primary px-4 py-2 rounded-lg font-medium"
                                        ${state.loading ? 'disabled' : ''}>
                                    ${state.loading ? '‚è≥' : 'üîÑ'} Atualizar
                                </button>
                                <button onclick="openWhatsAppQuickMenu()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                    üì± WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- CONTE√öDO PRINCIPAL -->
                <main class="container mx-auto px-2 md:px-4 py-4 md:py-6">
                    <div class="bg-white rounded-lg p-6 shadow">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">üöÄ Sistema Completo de Estoque</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="p-4 border border-gray-200 rounded-lg">
                                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    üìÖ Lembretes & Calend√°rio
                                </h3>
                                <p class="text-gray-600 mb-3">
                                    Gerencie entregas e compromissos com calend√°rio interativo.
                                </p>
                                <button onclick="openNewReminderModal()"
                                        class="btn-primary px-4 py-2 rounded-lg">
                                    Criar Lembrete
                                </button>
                            </div>
                            
                            <div class="p-4 border border-gray-200 rounded-lg">
                                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    üî≤ QR Codes
                                </h3>
                                <p class="text-gray-600 mb-3">
                                    Gere e imprima QR Codes para todos os produtos.
                                </p>
                                <button onclick="showQRCodeDemo()"
                                        class="btn-primary px-4 py-2 rounded-lg">
                                    Ver Demo
                                </button>
                            </div>
                            
                            <div class="p-4 border border-gray-200 rounded-lg">
                                <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                    üì± WhatsApp
                                </h3>
                                <p class="text-gray-600 mb-3">
                                    Envie alertas e relat√≥rios para: +${WHATSAPP_NUMBER}
                                </p>
                                <button onclick="openWhatsAppQuickMenu()"
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                    Abrir Menu
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <h3 class="font-bold text-gray-700 mb-4">üìä Estat√≠sticas R√°pidas</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="stat-card bg-white rounded-lg p-4 shadow">
                                    <div class="text-gray-500 text-sm font-medium">Produtos</div>
                                    <div class="text-2xl font-bold text-red-600">${state.stats.total}</div>
                                </div>
                                <div class="stat-card bg-white rounded-lg p-4 shadow">
                                    <div class="text-gray-500 text-sm font-medium">Lembretes</div>
                                    <div class="text-2xl font-bold text-blue-600">${updateReminderStats().total}</div>
                                </div>
                                <div class="stat-card bg-white rounded-lg p-4 shadow">
                                    <div class="text-gray-500 text-sm font-medium">WhatsApp</div>
                                    <div class="text-2xl font-bold text-green-600">+${WHATSAPP_NUMBER}</div>
                                </div>
                                <div class="stat-card bg-white rounded-lg p-4 shadow">
                                    <div class="text-gray-500 text-sm font-medium">Status</div>
                                    <div class="text-2xl font-bold ${state.connectionError ? 'text-orange-600' : 'text-green-600'}">
                                        ${state.connectionError ? 'Offline' : 'Online'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        }

        // üöÄ INICIAR APLICA√á√ÉO
        initApp();

        // üîß FUN√á√ïES AUXILIARES
        function toggleAutoRefresh() {
            state.autoRefresh = !state.autoRefresh;
            showNotification(state.autoRefresh ? 'üîÑ Auto-refresh ativado' : '‚è∏Ô∏è Auto-refresh pausado', 'info');
        }

        function showQRCodeDemo() {
            if (state.items.length > 0) {
                printQRCode(state.items[0]);
            } else {
                showNotification('Carregue produtos primeiro', 'warning');
            }
        }

        // Fun√ß√µes para manter compatibilidade
        function applySortingAndFiltering() {}
        function loadBackup() { return false; }
        function loadHistory() { return false; }
    </script>
</body>
</html>
