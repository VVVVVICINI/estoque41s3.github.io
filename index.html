<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Estoque - SUPER BRUNO ATACADO</title>
    <meta name="theme-color" content="#a00b08">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.min.js"></script>
    
    <style>
        :root {
            --primary-red: #a00b08;
            --primary-yellow: #f4cf08;
            --primary-beige: #d8cfc4;
            --primary-dark-red: #4d0505;
            --primary-purple: #9c7c84;
        }
        
        .brand-gradient {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-dark-red) 100%);
        }
        
        .btn-primary {
            background-color: var(--primary-red);
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-dark-red);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn-secondary {
            background-color: var(--primary-yellow);
            color: var(--primary-dark-red);
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: #e0c000;
            transform: translateY(-1px);
        }
        
        /* Status Tags */
        .status-tag {
            display: inline-block !important;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 2px;
            line-height: 1.2;
            white-space: nowrap;
            border: 1px solid;
            transition: all 0.2s;
        }
        .status-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-mostruario { background-color: #fef9e7 !important; color: #7d6608 !important; border-color: #f4cf08 !important; }
        .status-embalado { background-color: #e8f8ef !important; color: #186a3b !important; border-color: #2ecc71 !important; }
        .status-frentedeloja { background-color: #e8f4fd !important; color: #1a5276 !important; border-color: #3498db !important; }
        .status-separadocd { background-color: #f4ecf7 !important; color: #6c3483 !important; border-color: #9b59b6 !important; }
        .status-montagem { background-color: #ebedef !important; color: #2c3e50 !important; border-color: #34495e !important; }
        .status-assistencia { background-color: #fdedec !important; color: #943126 !important; border-color: #e74c3c !important; }
        .status-default { background-color: #f8f9fa !important; color: #495057 !important; border-color: #dee2e6 !important; }

        /* Hist√≥rico */
        .history-added { background-color: #e8f6f3 !important; color: #0d6251 !important; border-left: 4px solid #2ecc71 !important; }
        .history-removed { background-color: #fde8e8 !important; color: #9b2c2c !important; border-left: 4px solid #e53e3e !important; }
        .history-modified { background-color: #fef3e2 !important; color: #b45309 !important; border-left: 4px solid #ed8936 !important; }
        .history-stock-up { background-color: #e6fffa !important; color: #234e52 !important; border-left: 4px solid #38b2ac !important; }
        .history-stock-down { background-color: #fff5f5 !important; color: #9b2c2c !important; border-left: 4px solid #fc8181 !important; }

        /* Lembretes */
        .reminder-pending { background-color: #fff3cd !important; border-left: 4px solid #ffc107 !important; }
        .reminder-in-progress { background-color: #cce5ff !important; border-left: 4px solid #007bff !important; }
        .reminder-completed { background-color: #d4edda !important; border-left: 4px solid #28a745 !important; }
        .reminder-overdue { background-color: #f8d7da !important; border-left: 4px solid #dc3545 !important; }
        
        .reminder-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-in-progress { background: #cce5ff; color: #004085; }
        .badge-completed { background: #d4edda; color: #155724; }
        .badge-overdue { background: #f8d7da; color: #721c24; }

        /* Kanban */
        .kanban-column {
            min-height: 500px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .kanban-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: move;
            transition: all 0.3s;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .kanban-card.dragging {
            opacity: 0.5;
        }

        /* Scanner */
        #qr-reader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        #qr-reader__dashboard_section {
            padding: 20px;
        }
        #qr-reader__scan_region {
            border-radius: 8px;
            overflow: hidden;
        }

        /* Anima√ß√µes */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Outros */
        .search-input { font-size: 16px !important; }
        .sortable { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable:hover { background-color: rgba(255,255,255,0.1); }
        .stat-card { transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-text-sm { font-size: 0.875rem; }
            .search-input { height: 52px; padding: 14px 16px; }
            .kanban-column { min-height: 300px; margin-bottom: 20px; }
        }

        @media print {
            .no-print { display: none !important; }
            .print-full-width { width: 100% !important; }
        }

        .notification-enter {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background-color: #e0e0e0;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-badge:hover {
            background-color: #d0d0d0;
        }
        .filter-badge.active {
            background-color: var(--primary-red);
            color: white;
        }

        /* Tabs */
        .tab-button {
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .tab-button.active {
            background: white;
            color: var(--primary-red);
            font-weight: 600;
            border-color: #dee2e6;
            position: relative;
            z-index: 10;
        }
        .tab-button:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 0 8px 8px 8px;
            background: white;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* History badges */
        .history-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
        }
        .badge-added { background: #d1f7c4; color: #0d6251; }
        .badge-removed { background: #ffe0e0; color: #9b2c2c; }
        .badge-modified { background: #fff4d9; color: #b45309; }
        .badge-stock-up { background: #d1f7f7; color: #234e52; }
        .badge-stock-down { background: #ffe0e0; color: #9b2c2c; }

        /* Calendar */
        .fc { font-size: 0.9rem !important; }
        .fc-toolbar-title { font-size: 1.2rem !important; }
        
        /* QR Code Display */
        .qrcode-container {
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loading-spinner w-12 h-12 border-4 border-red-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Iniciando sistema de estoque...</p>
                <p class="text-gray-400 text-sm mt-2">Carregando todas as funcionalidades</p>
            </div>
        </div>
    </div>

    <script>
        // üîß CONFIGURA√á√ÉO PRINCIPAL
        const GOOGLE_SHEET_ID = '1zN6WXg-7mkb0mYOV8Hf3stQLD9wAdnyDKSPF5PfYK_M';
        const PUBLISHED_ID = '2PACX-1vTXIBXGqrCkz3-Fg07OBUq5Xv4jrXhpAvIXWrk9GiNoeD_so8qTHaxdPXBRTTOvkN1EUujUtVOPDU8f';
        const SHEET_NAME = 'P√°gina1';
        const AUTO_REFRESH_INTERVAL = 30000;
        const BACKUP_KEY = 'estoque_live_backup';
        const HISTORY_KEY = 'estoque_history';
        const REMINDERS_KEY = 'estoque_reminders';
        const DEBUG_MODE = true;
        const USE_PUBLISHED_VERSION = true;
        
        // üìä ESTADO GLOBAL
        let state = {
            items: [],
            previousItems: [],
            loading: true,
            searchTerm: '',
            filteredItems: [],
            lastUpdate: null,
            connectionError: false,
            sortField: 'codigo',
            sortDirection: 'asc',
            autoRefresh: true,
            syncInterval: null,
            locationFilter: 'all',
            stockFilter: 'all',
            currentTab: 'estoque',
            historyFilter: 'all',
            stats: {
                total: 0,
                inStock: 0,
                outOfStock: 0,
                lowStock: 0
            },
            history: [],
            historyStats: {
                today: 0,
                added: 0,
                removed: 0,
                modified: 0
            },
            reminders: [],
            charts: null,
            calendar: null,
            qrScanner: null
        };

        let searchDebounceTimer = null;
        let lastFocusedElementId = null;
        let draggedCard = null;

        // ==================== üìÖ SISTEMA DE LEMBRETES ====================
        
        // üìù INICIALIZAR LEMBRETES
        function initReminders() {
            loadReminders();
            initCalendar();
        }

        // üíæ CARREGAR LEMBRETES
        function loadReminders() {
            try {
                const savedReminders = localStorage.getItem(REMINDERS_KEY);
                if (savedReminders) {
                    state.reminders = JSON.parse(savedReminders);
                    console.log(`üìÖ Lembretes carregados: ${state.reminders.length}`);
                    updateReminderStats();
                    return true;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar lembretes:', error);
            }
            return false;
        }

        // üíæ SALVAR LEMBRETES
        function saveReminders() {
            try {
                localStorage.setItem(REMINDERS_KEY, JSON.stringify(state.reminders));
                updateReminderStats();
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar lembretes:', error);
                return false;
            }
        }

        // ‚ûï ADICIONAR LEMBRETE
        function addReminder(reminder) {
            reminder.id = `reminder_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            reminder.createdAt = new Date();
            reminder.status = 'pending';
            
            state.reminders.push(reminder);
            saveReminders();
            
            // Adicionar ao calend√°rio
            if (state.calendar && reminder.dueDate) {
                addReminderToCalendar(reminder);
            }
            
            showNotification('üìÖ Lembrete adicionado!', 'success');
            return reminder;
        }

        // ‚úèÔ∏è EDITAR LEMBRETE
        function updateReminder(id, updates) {
            const index = state.reminders.findIndex(r => r.id === id);
            if (index !== -1) {
                state.reminders[index] = { ...state.reminders[index], ...updates };
                saveReminders();
                
                // Atualizar no calend√°rio
                if (state.calendar && updates.dueDate) {
                    updateReminderInCalendar(state.reminders[index]);
                }
                
                return true;
            }
            return false;
        }

        // üóëÔ∏è REMOVER LEMBRETE
        function deleteReminder(id) {
            const index = state.reminders.findIndex(r => r.id === id);
            if (index !== -1) {
                const reminder = state.reminders[index];
                state.reminders.splice(index, 1);
                saveReminders();
                
                // Remover do calend√°rio
                if (state.calendar) {
                    removeReminderFromCalendar(reminder);
                }
                
                return true;
            }
            return false;
        }

        // üîÑ MUDAR STATUS DO LEMBRETE
        function changeReminderStatus(id, newStatus) {
            return updateReminder(id, { status: newStatus });
        }

        // üìä ATUALIZAR ESTAT√çSTICAS DOS LEMBRETES
        function updateReminderStats() {
            const today = new Date().toDateString();
            const todayReminders = state.reminders.filter(r => 
                new Date(r.dueDate).toDateString() === today
            );
            
            const overdueReminders = state.reminders.filter(r => {
                if (!r.dueDate || r.status === 'completed') return false;
                return new Date(r.dueDate) < new Date();
            });

            return {
                total: state.reminders.length,
                pending: state.reminders.filter(r => r.status === 'pending').length,
                inProgress: state.reminders.filter(r => r.status === 'in-progress').length,
                completed: state.reminders.filter(r => r.status === 'completed').length,
                overdue: overdueReminders.length,
                today: todayReminders.length
            };
        }

        // üóìÔ∏è INICIALIZAR CALEND√ÅRIO
        function initCalendar() {
            const calendarEl = document.getElementById('reminderCalendar');
            if (!calendarEl) return;

            state.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: getCalendarEvents(),
                eventClick: function(info) {
                    showReminderDetails(info.event.id);
                },
                dateClick: function(info) {
                    openNewReminderModal(info.dateStr);
                },
                eventColor: '#a00b08',
                eventTextColor: 'white'
            });

            state.calendar.render();
        }

        // üìÖ OBTER EVENTOS PARA O CALEND√ÅRIO
        function getCalendarEvents() {
            return state.reminders
                .filter(r => r.dueDate)
                .map(reminder => ({
                    id: reminder.id,
                    title: reminder.title,
                    start: reminder.dueDate,
                    color: getReminderColor(reminder.status),
                    extendedProps: {
                        product: reminder.productCode,
                        client: reminder.client,
                        description: reminder.description
                    }
                }));
        }

        // üé® OBTER COR DO LEMBRETE
        function getReminderColor(status) {
            switch(status) {
                case 'pending': return '#ffc107';
                case 'in-progress': return '#007bff';
                case 'completed': return '#28a745';
                case 'overdue': return '#dc3545';
                default: return '#6c757d';
            }
        }

        // ‚ûï ADICIONAR LEMBRETE AO CALEND√ÅRIO
        function addReminderToCalendar(reminder) {
            if (!state.calendar || !reminder.dueDate) return;
            
            state.calendar.addEvent({
                id: reminder.id,
                title: reminder.title,
                start: reminder.dueDate,
                color: getReminderColor(reminder.status),
                extendedProps: {
                    product: reminder.productCode,
                    client: reminder.client,
                    description: reminder.description
                }
            });
        }

        // üîÑ ATUALIZAR LEMBRETE NO CALEND√ÅRIO
        function updateReminderInCalendar(reminder) {
            if (!state.calendar) return;
            
            const event = state.calendar.getEventById(reminder.id);
            if (event) {
                event.setProp('title', reminder.title);
                event.setProp('start', reminder.dueDate);
                event.setProp('color', getReminderColor(reminder.status));
            } else if (reminder.dueDate) {
                addReminderToCalendar(reminder);
            }
        }

        // üóëÔ∏è REMOVER LEMBRETE DO CALEND√ÅRIO
        function removeReminderFromCalendar(reminder) {
            if (!state.calendar) return;
            
            const event = state.calendar.getEventById(reminder.id);
            if (event) {
                event.remove();
            }
        }

        // üîÑ ATUALIZAR DISPLAY DOS LEMBRETES
        function updateRemindersDisplay() {
            updateKanbanReminders();
            if (state.calendar) {
                state.calendar.removeAllEvents();
                state.calendar.addEventSource(getCalendarEvents());
            }
        }

        // üè∑Ô∏è ATUALIZAR KANBAN DOS LEMBRETES
        function updateKanbanReminders() {
            const columns = {
                'pending': document.getElementById('kanban-pending'),
                'in-progress': document.getElementById('kanban-in-progress'),
                'completed': document.getElementById('kanban-completed')
            };

            for (const [status, column] of Object.entries(columns)) {
                if (!column) continue;
                
                const reminders = state.reminders.filter(r => r.status === status);
                column.innerHTML = reminders.map(reminder => `
                    <div class="kanban-card reminder-${status}" 
                         data-id="${reminder.id}"
                         draggable="true"
                         ondragstart="dragReminder(event)">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="reminder-badge badge-${status}">
                                        ${getReminderStatusLabel(reminder.status)}
                                    </span>
                                    ${reminder.priority === 'high' ? '<span class="text-red-500">‚ö†Ô∏è ALTA</span>' : ''}
                                </div>
                                <h4 class="font-bold text-gray-800">${reminder.title}</h4>
                            </div>
                            <button onclick="deleteReminder('${reminder.id}')" 
                                    class="text-gray-400 hover:text-red-500">
                                √ó
                            </button>
                        </div>
                        
                        ${reminder.description ? `
                            <p class="text-sm text-gray-600 mb-2">${reminder.description}</p>
                        ` : ''}
                        
                        <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-2">
                            ${reminder.productCode ? `
                                <span class="bg-gray-100 px-2 py-1 rounded">
                                    üì¶ ${reminder.productCode}
                                </span>
                            ` : ''}
                            ${reminder.client ? `
                                <span class="bg-gray-100 px-2 py-1 rounded">
                                    üë§ ${reminder.client}
                                </span>
                            ` : ''}
                        </div>
                        
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-500">
                                ${reminder.dueDate ? `üìÖ ${formatDate(reminder.dueDate)}` : 'Sem data'}
                            </span>
                            <div class="flex gap-1">
                                <button onclick="changeReminderStatus('${reminder.id}', '${status === 'pending' ? 'in-progress' : 'completed'}')"
                                        class="text-blue-600 hover:text-blue-800">
                                    ${status === 'pending' ? '‚ñ∂Ô∏è Iniciar' : 
                                      status === 'in-progress' ? '‚úÖ Concluir' : '‚Ü©Ô∏è Reabrir'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-400 text-center py-4">Nenhum lembrete</p>';
            }
        }

        // üè∑Ô∏è OBTER LABEL DO STATUS
        function getReminderStatusLabel(status) {
            switch(status) {
                case 'pending': return 'PENDENTE';
                case 'in-progress': return 'EM ANDAMENTO';
                case 'completed': return 'CONCLU√çDO';
                case 'overdue': return 'ATRASADO';
                default: return status.toUpperCase();
            }
        }

        // üìÖ FORMATAR DATA
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        // üéØ DRAG & DROP LEMBRETES
        function dragReminder(event) {
            draggedCard = event.target;
            event.dataTransfer.setData('text/plain', event.target.dataset.id);
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function dropReminder(event) {
            event.preventDefault();
            const reminderId = event.dataTransfer.getData('text/plain');
            const newStatus = event.target.closest('.kanban-column').dataset.status;
            
            if (reminderId && newStatus) {
                changeReminderStatus(reminderId, newStatus);
                updateRemindersDisplay();
            }
        }

        // ==================== üî≤ SISTEMA DE QR CODES ====================

        // üî≤ GERAR QR CODE
        function generateQRCode(productId, productName) {
            return new Promise((resolve, reject) => {
                const text = `PRODUTO: ${productName}\nID: ${productId}\nDATA: ${new Date().toLocaleDateString('pt-BR')}`;
                const container = document.createElement('div');
                
                QRCode.toCanvas(container, text, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#a00b08',
                        light: '#ffffff'
                    }
                }, function(error, canvas) {
                    if (error) {
                        reject(error);
                    } else {
                        resolve(canvas.toDataURL('image/png'));
                    }
                });
            });
        }

        // üñ®Ô∏è IMPRIMIR QR CODE
        function printQRCode(product) {
            generateQRCode(product.codigo, product.nome).then(qrDataURL => {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>QR Code - ${product.codigo}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            .container { text-align: center; }
                            .product-info { margin-bottom: 20px; }
                            .qrcode { margin: 20px auto; }
                            .print-button { 
                                display: none; 
                                @media print { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="product-info">
                                <h2>${product.codigo}</h2>
                                <h3>${product.nome}</h3>
                                <p>Quantidade: ${product.quantidade}</p>
                                <p>Plataforma: ${product.plataforma}</p>
                            </div>
                            <div class="qrcode">
                                <img src="${qrDataURL}" alt="QR Code">
                            </div>
                            <p><small>Escaneie para ver detalhes do produto</small></p>
                            <button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                        </div>
                        <script>
                            setTimeout(() => window.print(), 500);
                            window.onafterprint = () => window.close();
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }).catch(error => {
                console.error('Erro ao gerar QR Code:', error);
                showNotification('‚ùå Erro ao gerar QR Code', 'error');
            });
        }

        // ==================== üìä DASHBOARD INTERATIVO ====================

        // üìà INICIALIZAR GR√ÅFICOS
        function initCharts() {
            if (!state.charts) {
                state.charts = {};
            }
            
            // Gr√°fico 1: Distribui√ß√£o por Localiza√ß√£o
            initLocationChart();
            
            // Gr√°fico 2: Estoque por Quantidade
            initStockChart();
            
            // Gr√°fico 3: Produtos Mais Movimentados
            initMovementChart();
        }

        // üìä GR√ÅFICO DE LOCALIZA√á√ÉO
        function initLocationChart() {
            const ctx = document.getElementById('locationChart');
            if (!ctx) return;
            
            const locationData = analyzeLocations();
            
            if (state.charts.location) {
                state.charts.location.destroy();
            }
            
            state.charts.location = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: locationData.labels,
                    datasets: [{
                        data: locationData.data,
                        backgroundColor: [
                            '#a00b08', '#f4cf08', '#3498db', '#2ecc71', 
                            '#9b59b6', '#e74c3c', '#1abc9c', '#34495e'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o por Localiza√ß√£o'
                        }
                    }
                }
            });
        }

        // üìä GR√ÅFICO DE ESTOQUE
        function initStockChart() {
            const ctx = document.getElementById('stockChart');
            if (!ctx) return;
            
            const stockData = analyzeStockLevels();
            
            if (state.charts.stock) {
                state.charts.stock.destroy();
            }
            
            state.charts.stock = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Em Estoque', 'Estoque Baixo', 'Esgotados'],
                    datasets: [{
                        label: 'Quantidade de Produtos',
                        data: [stockData.inStock, stockData.lowStock, stockData.outOfStock],
                        backgroundColor: ['#2ecc71', '#f4cf08', '#e74c3c'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'N√≠veis de Estoque'
                        }
                    }
                }
            });
        }

        // üìä GR√ÅFICO DE MOVIMENTA√á√ÉO
        function initMovementChart() {
            const ctx = document.getElementById('movementChart');
            if (!ctx) return;
            
            const movementData = analyzeMovements();
            
            if (state.charts.movement) {
                state.charts.movement.destroy();
            }
            
            state.charts.movement = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: movementData.labels,
                    datasets: [{
                        label: 'Movimenta√ß√µes por Dia',
                        data: movementData.data,
                        borderColor: '#a00b08',
                        backgroundColor: 'rgba(160, 11, 8, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Hist√≥rico de Movimenta√ß√µes'
                        }
                    }
                }
            });
        }

        // üîç ANALISAR LOCALIZA√á√ïES
        function analyzeLocations() {
            const locationCount = {
                'Mostru√°rio': 0,
                'Embalado': 0,
                'Frente de Loja': 0,
                'CD': 0,
                'Montagem': 0,
                'Assist√™ncia': 0,
                'Outros': 0
            };
            
            state.items.forEach(item => {
                const obs = item.observacoes?.toLowerCase() || '';
                let found = false;
                
                if (obs.includes('mostruario') || obs.includes('mostru√°rio')) {
                    locationCount['Mostru√°rio']++;
                    found = true;
                }
                if (obs.includes('embalado') || obs.includes('caixa')) {
                    locationCount['Embalado']++;
                    found = true;
                }
                if (obs.includes('frente') || obs.includes('loja')) {
                    locationCount['Frente de Loja']++;
                    found = true;
                }
                if (obs.includes('separado') || obs.includes('cd')) {
                    locationCount['CD']++;
                    found = true;
                }
                if (obs.includes('montagem') || obs.includes('montar')) {
                    locationCount['Montagem']++;
                    found = true;
                }
                if (obs.includes('assistencia') || obs.includes('assist√™ncia')) {
                    locationCount['Assist√™ncia']++;
                    found = true;
                }
                
                if (!found && obs.trim()) {
                    locationCount['Outros']++;
                }
            });
            
            // Filtrar categorias com zero
            const labels = [];
            const data = [];
            
            Object.entries(locationCount).forEach(([label, count]) => {
                if (count > 0) {
                    labels.push(label);
                    data.push(count);
                }
            });
            
            return { labels, data };
        }

        // üîç ANALISAR N√çVEIS DE ESTOQUE
        function analyzeStockLevels() {
            return {
                inStock: state.items.filter(i => i.quantidade > 3).length,
                lowStock: state.items.filter(i => i.quantidade > 0 && i.quantidade <= 3).length,
                outOfStock: state.items.filter(i => i.quantidade === 0).length
            };
        }

        // üîç ANALISAR MOVIMENTA√á√ïES
        function analyzeMovements() {
            // Agrupar hist√≥rico por dia (√∫ltimos 7 dias)
            const last7Days = Array.from({length: 7}, (_, i) => {
                const date = new Date();
                date.setDate(date.getDate() - i);
                return date.toISOString().split('T')[0];
            }).reverse();
            
            const dailyCount = {};
            last7Days.forEach(date => {
                dailyCount[date] = 0;
            });
            
            // Contar movimenta√ß√µes por dia
            state.history.forEach(entry => {
                const date = new Date(entry.timestamp).toISOString().split('T')[0];
                if (dailyCount[date] !== undefined) {
                    dailyCount[date]++;
                }
            });
            
            // Formatar para gr√°fico
            const labels = last7Days.map(date => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });
            
            const data = last7Days.map(date => dailyCount[date]);
            
            return { labels, data };
        }

        // ==================== üè∑Ô∏è KANBAN VISUAL ====================

        // üè∑Ô∏è INICIALIZAR KANBAN
        function initKanban() {
            updateKanbanDisplay();
            setupKanbanDragAndDrop();
        }

        // üîÑ ATUALIZAR DISPLAY DO KANBAN
        function updateKanbanDisplay() {
            const columns = {
                'mostruario': document.getElementById('kanban-mostruario'),
                'embalado': document.getElementById('kanban-embalado'),
                'frentedeloja': document.getElementById('kanban-frentedeloja'),
                'separadocd': document.getElementById('kanban-separadocd'),
                'montagem': document.getElementById('kanban-montagem'),
                'assistencia': document.getElementById('kanban-assistencia'),
                'outros': document.getElementById('kanban-outros')
            };

            // Agrupar produtos por localiza√ß√£o
            const groupedItems = groupItemsByLocation();
            
            // Preencher cada coluna
            for (const [location, column] of Object.entries(columns)) {
                if (!column) continue;
                
                const items = groupedItems[location] || [];
                column.innerHTML = items.map(item => `
                    <div class="kanban-card" 
                         data-id="${item.codigo}"
                         draggable="true"
                         ondragstart="dragProduct(event)">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-mono font-bold text-red-700 text-sm">
                                ${item.codigo}
                            </div>
                            <span class="inline-flex items-center justify-center px-2 py-1 rounded-full text-xs font-bold
                                ${item.quantidade === 0 ? 'bg-red-100 text-red-700' : 
                                  item.quantidade <= 3 ? 'bg-yellow-100 text-yellow-700' : 
                                  'bg-green-100 text-green-700'}">
                                ${item.quantidade}
                            </span>
                        </div>
                        
                        <h4 class="font-medium text-gray-900 text-sm mb-2">
                            ${item.nome}
                        </h4>
                        
                        <div class="text-xs text-gray-500 mb-2">
                            ${item.plataforma}
                        </div>
                        
                        <div class="flex justify-between items-center text-xs">
                            <button onclick="printQRCode(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                                    class="text-blue-600 hover:text-blue-800">
                                üî≤ QR Code
                            </button>
                            <button onclick="showProductDetails('${item.codigo}')"
                                    class="text-gray-600 hover:text-gray-800">
                                üëÅÔ∏è Detalhes
                            </button>
                        </div>
                    </div>
                `).join('') || '<p class="text-gray-400 text-center py-4">Nenhum produto</p>';
            }
        }

        // üóÇÔ∏è AGRUPAR ITENS POR LOCALIZA√á√ÉO
        function groupItemsByLocation() {
            const groups = {
                'mostruario': [],
                'embalado': [],
                'frentedeloja': [],
                'separadocd': [],
                'montagem': [],
                'assistencia': [],
                'outros': []
            };
            
            const itemsToShow = state.searchTerm ? state.filteredItems : state.items;
            
            itemsToShow.forEach(item => {
                const obs = item.observacoes?.toLowerCase() || '';
                let placed = false;
                
                if (obs.includes('mostruario') || obs.includes('mostru√°rio')) {
                    groups.mostruario.push(item);
                    placed = true;
                }
                if (!placed && (obs.includes('embalado') || obs.includes('caixa'))) {
                    groups.embalado.push(item);
                    placed = true;
                }
                if (!placed && (obs.includes('frente') || obs.includes('loja'))) {
                    groups.frentedeloja.push(item);
                    placed = true;
                }
                if (!placed && (obs.includes('separado') || obs.includes('cd'))) {
                    groups.separadocd.push(item);
                    placed = true;
                }
                if (!placed && (obs.includes('montagem') || obs.includes('montar'))) {
                    groups.montagem.push(item);
                    placed = true;
                }
                if (!placed && (obs.includes('assistencia') || obs.includes('assist√™ncia'))) {
                    groups.assistencia.push(item);
                    placed = true;
                }
                
                if (!placed) {
                    groups.outros.push(item);
                }
            });
            
            return groups;
        }

        // üéØ DRAG & DROP PRODUTOS
        function dragProduct(event) {
            draggedCard = event.target;
            const productCode = event.target.dataset.id;
            event.dataTransfer.setData('text/plain', productCode);
        }

        function dropProduct(event) {
            event.preventDefault();
            const productCode = event.dataTransfer.getData('text/plain');
            const newLocation = event.target.closest('.kanban-column').dataset.location;
            
            if (productCode && newLocation) {
                updateProductLocation(productCode, newLocation);
            }
        }

        // üîÑ ATUALIZAR LOCALIZA√á√ÉO DO PRODUTO
        async function updateProductLocation(productCode, newLocation) {
            // Em um sistema real, aqui voc√™ atualizaria a planilha
            // Por enquanto, vamos apenas mostrar uma notifica√ß√£o
            
            const product = state.items.find(p => p.codigo === productCode);
            if (product) {
                const locationNames = {
                    'mostruario': 'Mostru√°rio',
                    'embalado': 'Embalado',
                    'frentedeloja': 'Frente de Loja',
                    'separadocd': 'Separado CD',
                    'montagem': 'Montagem',
                    'assistencia': 'Assist√™ncia',
                    'outros': 'Outros'
                };
                
                showNotification(`üìç ${product.codigo} movido para ${locationNames[newLocation]}`, 'success');
                
                // Atualizar visualiza√ß√£o
                setTimeout(() => {
                    updateKanbanDisplay();
                }, 300);
            }
        }

        // üõ†Ô∏è CONFIGURAR DRAG & DROP
        function setupKanbanDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column');
            columns.forEach(column => {
                column.addEventListener('dragover', allowDrop);
                column.addEventListener('drop', dropProduct);
            });
        }

        // ==================== üîç MODO SCANNER ====================

        // üîç INICIALIZAR SCANNER
        function initScanner() {
            const scannerContainer = document.getElementById('qr-scanner-container');
            if (!scannerContainer || !window.Html5Qrcode) return;
            
            state.qrScanner = new Html5Qrcode("qr-scanner-container");
            
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            };
            
            // Bot√£o para iniciar scanner
            const startBtn = document.getElementById('start-scanner');
            if (startBtn) {
                startBtn.onclick = () => {
                    Html5Qrcode.getCameras().then(devices => {
                        if (devices && devices.length) {
                            const cameraId = devices[0].id;
                            state.qrScanner.start(
                                cameraId,
                                config,
                                onScanSuccess,
                                onScanError
                            ).then(() => {
                                startBtn.style.display = 'none';
                                document.getElementById('stop-scanner').style.display = 'inline-block';
                            });
                        } else {
                            showNotification('‚ùå Nenhuma c√¢mera encontrada', 'error');
                        }
                    });
                };
            }
            
            // Bot√£o para parar scanner
            const stopBtn = document.getElementById('stop-scanner');
            if (stopBtn) {
                stopBtn.onclick = () => {
                    state.qrScanner.stop().then(() => {
                        startBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                    });
                };
            }
        }

        // ‚úÖ SCAN BEM-SUCEDIDO
        function onScanSuccess(decodedText) {
            console.log('QR Code detectado:', decodedText);
            
            // Extrair c√≥digo do produto do QR Code
            const match = decodedText.match(/ID:\s*(\S+)/);
            const productCode = match ? match[1] : decodedText;
            
            // Buscar produto
            const product = state.items.find(p => p.codigo === productCode);
            if (product) {
                showProductDetails(productCode);
                playScanSound();
                
                // Registrar no hist√≥rico de scans
                addScanHistory(productCode);
            } else {
                showNotification('‚ùå Produto n√£o encontrado', 'error');
            }
        }

        // ‚ùå ERRO NO SCAN
        function onScanError(error) {
            console.warn('Erro no scanner:', error);
        }

        // üîà TOCAR SOM DE SCAN
        function playScanSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ');
            audio.play().catch(e => console.log('Erro ao tocar som:', e));
        }

        // üìù ADICIONAR AO HIST√ìRICO DE SCANS
        function addScanHistory(productCode) {
            const scan = {
                productCode,
                timestamp: new Date().toISOString(),
                type: 'scan'
            };
            
            // Salvar no localStorage
            const scanHistory = JSON.parse(localStorage.getItem('scan_history') || '[]');
            scanHistory.unshift(scan);
            if (scanHistory.length > 50) scanHistory.pop();
            localStorage.setItem('scan_history', JSON.stringify(scanHistory));
        }

        // ==================== üì± INTEGRA√á√ÉO WHATSAPP ====================

        // üì± COMPARTILHAR VIA WHATSAPP
        function shareViaWhatsApp(product, messageType = 'stock_low') {
            const phoneNumber = ''; // Adicione o n√∫mero aqui
            let message = '';
            
            switch(messageType) {
                case 'stock_low':
                    message = `‚ö†Ô∏è ALERTA DE ESTOQUE BAIXO\n\n` +
                             `Produto: ${product.nome}\n` +
                             `C√≥digo: ${product.codigo}\n` +
                             `Quantidade: ${product.quantidade}\n` +
                             `Localiza√ß√£o: ${product.observacoes || 'N√£o informada'}\n\n` +
                             `Por favor, verificar reposi√ß√£o.`;
                    break;
                    
                case 'reminder':
                    message = `üìÖ LEMBRETE DE ENTREGA\n\n` +
                             `Produto: ${product.nome}\n` +
                             `C√≥digo: ${product.codigo}\n` +
                             `Cliente: ${product.client || 'N√£o especificado'}\n` +
                             `Data: ${product.dueDate ? formatDate(product.dueDate) : 'Hoje'}\n\n` +
                             `Preparar para entrega.`;
                    break;
                    
                default:
                    message = `üì¶ INFORMA√á√ÉO DO PRODUTO\n\n` +
                             `Produto: ${product.nome}\n` +
                             `C√≥digo: ${product.codigo}\n` +
                             `Quantidade: ${product.quantidade}\n` +
                             `Localiza√ß√£o: ${product.observacoes || 'N√£o informada'}`;
            }
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            if (phoneNumber) {
                window.open(whatsappUrl, '_blank');
            } else {
                // Copiar mensagem para √°rea de transfer√™ncia
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('üìã Mensagem copiada! Cole no WhatsApp.', 'success');
                });
            }
        }

        // üî≤ GERAR QR CODE DO WHATSAPP
        function generateWhatsAppQR(groupId) {
            const whatsappUrl = `https://chat.whatsapp.com/${groupId}`;
            const container = document.getElementById('whatsapp-qr-code');
            
            if (container) {
                QRCode.toCanvas(container, whatsappUrl, {
                    width: 200,
                    margin: 1,
                    color: {
                        dark: '#25D366',
                        light: '#ffffff'
                    }
                }, function(error) {
                    if (error) console.error(error);
                });
            }
        }

        // ==================== üéØ FUN√á√ïES AUXILIARES ====================

        // üì± MOSTRAR DETALHES DO PRODUTO
        function showProductDetails(productCode) {
            const product = state.items.find(p => p.codigo === productCode);
            if (!product) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-bold text-gray-900">${product.nome}</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="text-sm text-gray-500">C√≥digo</label>
                                <p class="font-mono font-bold text-red-700">${product.codigo}</p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Quantidade</label>
                                <p class="text-2xl font-bold ${product.quantidade === 0 ? 'text-red-600' : 
                                  product.quantidade <= 3 ? 'text-yellow-600' : 'text-green-600'}">
                                    ${product.quantidade}
                                </p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Plataforma</label>
                                <p>${product.plataforma}</p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Localiza√ß√£o</label>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${formatObservacoes(product.observacoes)}
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">√öltima atualiza√ß√£o</label>
                                <p>${state.lastUpdate ? state.lastUpdate.toLocaleString('pt-BR') : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-2 gap-3">
                            <button onclick="printQRCode(${JSON.stringify(product).replace(/"/g, '&quot;')})"
                                    class="btn-primary py-2 rounded-lg">
                                üî≤ Imprimir QR Code
                            </button>
                            <button onclick="shareViaWhatsApp(${JSON.stringify(product).replace(/"/g, '&quot;')})"
                                    class="bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                                üì± Compartilhar
                            </button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <div id="product-qr-code" class="inline-block"></div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Gerar QR Code do produto
            setTimeout(() => {
                generateQRCode(product.codigo, product.nome).then(qrDataURL => {
                    const qrContainer = document.getElementById('product-qr-code');
                    if (qrContainer) {
                        qrContainer.innerHTML = `<img src="${qrDataURL}" alt="QR Code" class="mx-auto">`;
                    }
                });
            }, 100);
        }

        // üéØ MOSTRAR DETALHES DO LEMBRETE
        function showReminderDetails(reminderId) {
            const reminder = state.reminders.find(r => r.id === reminderId);
            if (!reminder) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="reminder-badge badge-${reminder.status} mb-2">
                                    ${getReminderStatusLabel(reminder.status)}
                                </span>
                                <h3 class="text-xl font-bold text-gray-900">${reminder.title}</h3>
                            </div>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        ${reminder.description ? `
                            <div class="mb-4">
                                <label class="text-sm text-gray-500">Descri√ß√£o</label>
                                <p class="text-gray-700">${reminder.description}</p>
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            ${reminder.client ? `
                                <div>
                                    <label class="text-sm text-gray-500">Cliente</label>
                                    <p class="font-medium">${reminder.client}</p>
                                </div>
                            ` : ''}
                            
                            ${reminder.productCode ? `
                                <div>
                                    <label class="text-sm text-gray-500">Produto</label>
                                    <p class="font-mono">${reminder.productCode}</p>
                                </div>
                            ` : ''}
                            
                            <div>
                                <label class="text-sm text-gray-500">Data</label>
                                <p>${reminder.dueDate ? formatDate(reminder.dueDate) : 'N√£o definida'}</p>
                            </div>
                            
                            <div>
                                <label class="text-sm text-gray-500">Prioridade</label>
                                <p>${reminder.priority === 'high' ? '‚ö†Ô∏è Alta' : 'Normal'}</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 grid grid-cols-3 gap-2">
                            <button onclick="changeReminderStatus('${reminder.id}', 'pending')"
                                    class="py-2 rounded-lg ${reminder.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100'}">
                                Pendente
                            </button>
                            <button onclick="changeReminderStatus('${reminder.id}', 'in-progress')"
                                    class="py-2 rounded-lg ${reminder.status === 'in-progress' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100'}">
                                Andamento
                            </button>
                            <button onclick="changeReminderStatus('${reminder.id}', 'completed')"
                                    class="py-2 rounded-lg ${reminder.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-gray-100'}">
                                Conclu√≠do
                            </button>
                        </div>
                        
                        <div class="mt-4 flex gap-2">
                            <button onclick="shareViaWhatsApp(${JSON.stringify(reminder).replace(/"/g, '&quot;')}, 'reminder')"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
                                üì± Compartilhar
                            </button>
                            <button onclick="deleteReminder('${reminder.id}'); this.parentElement.parentElement.parentElement.remove()"
                                    class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // üÜï ABRIR MODAL DE NOVO LEMBRETE
        function openNewReminderModal(prefilledDate = null) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Novo Lembrete</h3>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="text-gray-500 hover:text-gray-700">
                                √ó
                            </button>
                        </div>
                        
                        <form id="new-reminder-form" onsubmit="return submitNewReminder(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        T√≠tulo *
                                    </label>
                                    <input type="text" 
                                           name="title"
                                           required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                           placeholder="Ex: Entregar produto para cliente">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        Descri√ß√£o
                                    </label>
                                    <textarea name="description"
                                              rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                              placeholder="Detalhes adicionais..."></textarea>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Cliente
                                        </label>
                                        <input type="text" 
                                               name="client"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                               placeholder="Nome do cliente">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            C√≥digo do Produto
                                        </label>
                                        <input type="text" 
                                               name="productCode"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                               placeholder="C√≥digo do produto">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Data de Vencimento *
                                        </label>
                                        <input type="date" 
                                               name="dueDate"
                                               required
                                               value="${prefilledDate || ''}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            Prioridade
                                        </label>
                                        <select name="priority"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                            <option value="normal">Normal</option>
                                            <option value="high">Alta</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button"
                                        onclick="this.parentElement.parentElement.parentElement.parentElement.remove()"
                                        class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                    Cancelar
                                </button>
                                <button type="submit"
                                        class="btn-primary px-6 py-2 rounded-lg">
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-focus no primeiro campo
            setTimeout(() => {
                const firstInput = modal.querySelector('input');
                if (firstInput) firstInput.focus();
            }, 100);
        }

        // üìù SUBMIT DO NOVO LEMBRETE
        function submitNewReminder(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const reminder = {
                title: formData.get('title'),
                description: formData.get('description'),
                client: formData.get('client'),
                productCode: formData.get('productCode'),
                dueDate: formData.get('dueDate'),
                priority: formData.get('priority'),
                status: 'pending'
            };
            
            addReminder(reminder);
            form.closest('.fixed').remove();
            
            // Atualizar display
            if (state.currentTab === 'lembretes') {
                updateRemindersDisplay();
            }
            
            return false;
        }

        // ==================== üìã FUN√á√ïES EXISTENTES (resumidas) ====================

        // üîß Fun√ß√µes existentes do sistema anterior...
        // (fetchLiveData, parseCSVData, updateStats, showNotification, etc.)
        // Mantenho todas as fun√ß√µes originais aqui, mas resumo para espa√ßo

        async function fetchLiveData() {
            // Implementa√ß√£o original mantida
            try {
                state.previousItems = [...state.items];
                let url = USE_PUBLISHED_VERSION 
                    ? `https://docs.google.com/spreadsheets/d/e/${PUBLISHED_ID}/pub?output=csv&gid=0&t=${Date.now()}`
                    : `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;
                
                const response = await fetch(url, { cache: 'no-cache' });
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                
                const csvData = await response.text();
                const items = parseCSVData(csvData);
                
                if (items.length > 0) {
                    state.items = items;
                    state.connectionError = false;
                    state.lastUpdate = new Date();
                    
                    // Salvar backup
                    localStorage.setItem(BACKUP_KEY, JSON.stringify({
                        items: items,
                        timestamp: Date.now()
                    }));
                    
                    // Analisar mudan√ßas
                    if (state.previousItems.length > 0) {
                        analyzeChanges(state.previousItems, items);
                    }
                    
                    updateStats();
                    loadHistory();
                    return true;
                }
                throw new Error('Nenhum produto encontrado');
                
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados:', error);
                return loadBackup() || false;
            }
        }

        function parseCSVData(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const items = [];
            
            for (let i = 1; i < lines.length; i++) {
                try {
                    const cells = lines[i].split(',').map(cell => 
                        cell.replace(/^["']|["']$/g, '').trim()
                    );
                    
                    if (cells.length < 3) continue;
                    
                    const codigo = cells[0] || '';
                    const nome = cells[1] || '';
                    const quantidade = parseInt(cells[2]) || 0;
                    const plataforma = cells[3] || 'N√£o informado';
                    const observacoes = cells[4] || '';
                    
                    if (codigo && nome) {
                        items.push({
                            id: `item_${i}_${Date.now()}`,
                            codigo,
                            nome,
                            quantidade,
                            plataforma,
                            observacoes,
                            data_entrada: new Date().toISOString().split('T')[0],
                            updated_at: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro na linha ${i}:`, error);
                }
            }
            
            return items;
        }

        function updateStats() {
            const total = state.items.length;
            const inStock = state.items.filter(i => i.quantidade > 0).length;
            const outOfStock = state.items.filter(i => i.quantidade === 0).length;
            const lowStock = state.items.filter(i => i.quantidade > 0 && i.quantidade <= 3).length;
            
            state.stats = { total, inStock, outOfStock, lowStock };
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-orange-500',
                info: 'bg-blue-600'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification-enter fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 max-w-md`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="text-white hover:text-gray-200 font-bold text-xl leading-none">√ó</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }

        // ==================== üé® RENDERIZA√á√ÉO PRINCIPAL ====================

        function render() {
            if (state.loading && state.items.length === 0) return;
            
            saveCurrentFocus();
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <!-- HEADER -->
                <header class="brand-gradient shadow-lg no-print">
                    <div class="container mx-auto px-4 py-4">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-4">
                                <div class="brand-gradient rounded-xl p-3 text-white font-bold text-xl shadow-md">
                                    <span class="text-white">SUPER</span>
                                    <span class="text-yellow-300 ml-1">BRUNO</span>
                                </div>
                                <div>
                                    <h1 class="text-white text-xl md:text-2xl font-bold">Mapa de Estoque</h1>
                                    <p class="text-yellow-200 text-sm flex items-center gap-2">
                                        ${state.connectionError ? 
                                            '<span class="pulse">‚ö†Ô∏è Modo Offline</span>' : 
                                            '<span>‚úÖ Ao Vivo</span>'}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <button onclick="toggleAutoRefresh()" 
                                        class="${state.autoRefresh ? 'btn-secondary' : 'bg-gray-500 text-white'} px-4 py-2 rounded-lg font-medium">
                                    ${state.autoRefresh ? 'üîÑ Auto' : '‚è∏Ô∏è Manual'}
                                </button>
                                <button onclick="syncWithSheet()" 
                                        class="btn-primary px-4 py-2 rounded-lg font-medium"
                                        ${state.loading ? 'disabled' : ''}>
                                    ${state.loading ? '‚è≥' : 'üîÑ'} Atualizar
                                </button>
                                <button onclick="exportToCSV()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium">
                                    üì• Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <!-- MAIN CONTENT -->
                <main class="container mx-auto px-2 md:px-4 py-4 md:py-6">
                    <!-- ABAS PRINCIPAIS -->
                    <div class="flex overflow-x-auto mb-6 border-b border-gray-200 no-print" style="scrollbar-width: thin;">
                        <button class="tab-button ${state.currentTab === 'estoque' ? 'active' : ''}" 
                                onclick="switchTab('estoque')">
                            üì¶ Estoque (${state.stats.total})
                        </button>
                        <button class="tab-button ${state.currentTab === 'dashboard' ? 'active' : ''}" 
                                onclick="switchTab('dashboard')">
                            üìä Dashboard
                        </button>
                        <button class="tab-button ${state.currentTab === 'kanban' ? 'active' : ''}" 
                                onclick="switchTab('kanban')">
                            üè∑Ô∏è Kanban
                        </button>
                        <button class="tab-button ${state.currentTab === 'lembretes' ? 'active' : ''}" 
                                onclick="switchTab('lembretes')">
                            üìÖ Lembretes ${updateReminderStats().today > 0 ? `(${updateReminderStats().today})` : ''}
                        </button>
                        <button class="tab-button ${state.currentTab === 'scanner' ? 'active' : ''}" 
                                onclick="switchTab('scanner')">
                            üîç Scanner
                        </button>
                        <button class="tab-button ${state.currentTab === 'historico' ? 'active' : ''}" 
                                onclick="switchTab('historico')">
                            üìù Hist√≥rico ${state.historyStats.today > 0 ? `(${state.historyStats.today})` : ''}
                        </button>
                    </div>

                    <!-- CONTE√öDO DAS ABAS -->
                    ${renderCurrentTab()}
                </main>

                <!-- FOOTER -->
                <footer class="mt-8 pb-6 text-center text-gray-500 text-sm no-print">
                    <div class="container mx-auto px-4">
                        <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                            <div class="flex items-center gap-2">
                                ${state.connectionError ? 
                                    '<span class="text-orange-600">‚ö†Ô∏è Modo Offline</span>' :
                                    '<span class="text-green-600">‚úÖ Sistema Online</span>'}
                            </div>
                            <div class="hidden md:block text-gray-300">|</div>
                            <div>
                                üîÑ ${state.autoRefresh ? 'Auto (30s)' : 'Manual'}
                            </div>
                            <div class="hidden md:block text-gray-300">|</div>
                            <div>
                                üì¶ ${state.items.length} produtos
                            </div>
                            <div class="hidden md:block text-gray-300">|</div>
                            <div>
                                üìÖ ${updateReminderStats().total} lembretes
                            </div>
                        </div>
                        ${state.lastUpdate ? `
                            <div class="mt-2 text-xs text-gray-400">
                                √öltima sincroniza√ß√£o: ${state.lastUpdate.toLocaleString('pt-BR')}
                            </div>
                        ` : ''}
                    </div>
                </footer>
            `;
            
            renderTabContent();
            restoreFocus();
        }

        function renderCurrentTab() {
            switch(state.currentTab) {
                case 'dashboard':
                    return renderDashboardTab();
                case 'kanban':
                    return renderKanbanTab();
                case 'lembretes':
                    return renderRemindersTab();
                case 'scanner':
                    return renderScannerTab();
                case 'historico':
                    return renderHistoryTab();
                default:
                    return renderEstoqueTab();
            }
        }

        function renderEstoqueTab() {
            return `
                <div class="tab-content active" id="estoqueContent">
                    <!-- Conte√∫do original do estoque aqui -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Total</div>
                            <div class="text-2xl font-bold text-red-600">${state.stats.total}</div>
                            <div class="text-xs text-gray-400">produtos</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Em Estoque</div>
                            <div class="text-2xl font-bold text-green-600">${state.stats.inStock}</div>
                            <div class="text-xs text-gray-400">dispon√≠veis</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Esgotados</div>
                            <div class="text-2xl font-bold text-orange-600">${state.stats.outOfStock}</div>
                            <div class="text-xs text-gray-400">sem estoque</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Estoque Baixo</div>
                            <div class="text-2xl font-bold text-yellow-600">${state.stats.lowStock}</div>
                            <div class="text-xs text-gray-400">‚â§ 3 unidades</div>
                        </div>
                    </div>

                    <!-- Busca e Filtros -->
                    <div class="bg-white rounded-lg p-4 mb-6 shadow">
                        <div class="relative mb-4">
                            <input type="text" 
                                   id="searchInput"
                                   placeholder="üîç Buscar por c√≥digo, nome, plataforma ou localiza√ß√£o..."
                                   value="${state.searchTerm}"
                                   oninput="handleSearchInput(event)"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent search-input">
                            
                            ${state.searchTerm ? `
                                <button onclick="clearSearch()" 
                                        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center">
                                    √ó
                                </button>
                            ` : ''}
                        </div>

                        <!-- Filtros R√°pidos -->
                        <div class="space-y-3">
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">üìç Localiza√ß√£o:</div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setLocationFilter('all')" 
                                            class="filter-badge ${state.locationFilter === 'all' ? 'active' : ''}">
                                        Todas
                                    </button>
                                    <button onclick="setLocationFilter('mostruario')" 
                                            class="filter-badge ${state.locationFilter === 'mostruario' ? 'active' : ''}">
                                        üé® Mostru√°rio
                                    </button>
                                    <button onclick="setLocationFilter('embalado')" 
                                            class="filter-badge ${state.locationFilter === 'embalado' ? 'active' : ''}">
                                        üì¶ Embalado
                                    </button>
                                    <button onclick="setLocationFilter('frente')" 
                                            class="filter-badge ${state.locationFilter === 'frente' ? 'active' : ''}">
                                        üè™ Frente de Loja
                                    </button>
                                    <button onclick="setLocationFilter('cd')" 
                                            class="filter-badge ${state.locationFilter === 'cd' ? 'active' : ''}">
                                        üè≠ CD
                                    </button>
                                    <button onclick="setLocationFilter('montagem')" 
                                            class="filter-badge ${state.locationFilter === 'montagem' ? 'active' : ''}">
                                        üîß Montagem
                                    </button>
                                    <button onclick="setLocationFilter('assistencia')" 
                                            class="filter-badge ${state.locationFilter === 'assistencia' ? 'active' : ''}">
                                        üî® Assist√™ncia
                                    </button>
                                </div>
                            </div>

                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">üìä Estoque:</div>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setStockFilter('all')" 
                                            class="filter-badge ${state.stockFilter === 'all' ? 'active' : ''}">
                                        Todos
                                    </button>
                                    <button onclick="setStockFilter('in')" 
                                            class="filter-badge ${state.stockFilter === 'in' ? 'active' : ''}">
                                        ‚úÖ Dispon√≠vel
                                    </button>
                                    <button onclick="setStockFilter('low')" 
                                            class="filter-badge ${state.stockFilter === 'low' ? 'active' : ''}">
                                        ‚ö†Ô∏è Baixo (‚â§3)
                                    </button>
                                    <button onclick="setStockFilter('out')" 
                                            class="filter-badge ${state.stockFilter === 'out' ? 'active' : ''}">
                                        ‚ùå Esgotado
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between text-sm">
                            <div class="text-gray-600">
                                üìä Mostrando <span class="font-bold text-red-600">${state.filteredItems.length}</span> de <span class="font-bold">${state.items.length}</span> produtos
                            </div>
                            <div class="text-gray-500">
                                üïí ${getTimeSinceUpdate()}
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Produtos -->
                    <div class="bg-white rounded-lg shadow overflow-hidden fade-in">
                        <div class="overflow-x-auto">
                            <table class="w-full print-full-width">
                                <thead>
                                    <tr class="bg-gradient-to-r from-red-700 to-red-900 text-white">
                                        <th class="px-3 py-3 md:px-4 md:py-3 text-left sortable" onclick="sortBy('codigo')">
                                            <div class="flex items-center gap-1">
                                                <span>C√≥digo</span>
                                                <span class="text-xs">${getSortIcon('codigo')}</span>
                                            </div>
                                        </th>
                                        <th class="px-3 py-3 md:px-4 md:py-3 text-left sortable" onclick="sortBy('nome')">
                                            <div class="flex items-center gap-1">
                                                <span>Nome</span>
                                                <span class="text-xs">${getSortIcon('nome')}</span>
                                            </div>
                                        </th>
                                        <th class="px-3 py-3 md:px-4 md:py-3 text-center sortable" onclick="sortBy('quantidade')">
                                            <div class="flex items-center justify-center gap-1">
                                                <span>Qtd</span>
                                                <span class="text-xs">${getSortIcon('quantidade')}</span>
                                            </div>
                                        </th>
                                        <th class="px-3 py-3 md:px-4 md:py-3 text-left mobile-hidden" onclick="sortBy('plataforma')">
                                            <div class="flex items-center gap-1">
                                                <span>Plataforma</span>
                                                <span class="text-xs">${getSortIcon('plataforma')}</span>
                                            </div>
                                        </th>
                                        <th class="px-3 py-3 md:px-4 md:py-3 text-left">
                                            Localiza√ß√£o
                                        </th>
                                        <th class="px-3 py-3 md:px-4 md:py-3 text-left no-print">
                                            A√ß√µes
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${state.filteredItems.length === 0 ? `
                                        <tr>
                                            <td colspan="6" class="px-4 py-12 text-center">
                                                <div class="text-gray-400 text-4xl mb-3">üì¶</div>
                                                <div class="text-gray-600 font-medium mb-1">
                                                    ${state.searchTerm || state.locationFilter !== 'all' || state.stockFilter !== 'all' ? 
                                                        'Nenhum produto encontrado' : 
                                                        'Nenhum produto cadastrado'}
                                                </div>
                                            </td>
                                        </tr>
                                    ` : ''}
                                    
                                    ${state.filteredItems.slice(0, 50).map((item, index) => `
                                        <tr class="hover:bg-gray-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                            <td class="px-3 py-3 md:px-4 md:py-4">
                                                <div class="font-mono font-bold text-red-700 text-sm md:text-base">
                                                    ${item.codigo}
                                                </div>
                                            </td>
                                            <td class="px-3 py-3 md:px-4 md:py-4">
                                                <div class="font-medium text-gray-900 text-sm md:text-base">
                                                    ${item.nome}
                                                </div>
                                            </td>
                                            <td class="px-3 py-3 md:px-4 md:py-4 text-center">
                                                <span class="inline-flex items-center justify-center px-3 py-1 rounded-full text-sm font-bold
                                                    ${item.quantidade === 0 ? 'bg-red-100 text-red-700' : 
                                                      item.quantidade <= 3 ? 'bg-yellow-100 text-yellow-700' : 
                                                      'bg-green-100 text-green-700'}">
                                                    ${item.quantidade}
                                                </span>
                                            </td>
                                            <td class="px-3 py-3 md:px-4 md:py-4 mobile-hidden">
                                                <span class="inline-block bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-sm">
                                                    ${item.plataforma}
                                                </span>
                                            </td>
                                            <td class="px-3 py-3 md:px-4 md:py-4">
                                                <div class="flex flex-wrap gap-1">
                                                    ${formatObservacoes(item.observacoes)}
                                                </div>
                                            </td>
                                            <td class="px-3 py-3 md:px-4 md:py-4 no-print">
                                                <div class="flex gap-2">
                                                    <button onclick="printQRCode(${JSON.stringify(item).replace(/"/g, '&quot;')})"
                                                            class="text-blue-600 hover:text-blue-800 text-sm">
                                                        üî≤ QR
                                                    </button>
                                                    <button onclick="showProductDetails('${item.codigo}')"
                                                            class="text-gray-600 hover:text-gray-800 text-sm">
                                                        üëÅÔ∏è
                                                    </button>
                                                    <button onclick="openNewReminderModalWithProduct('${item.codigo}')"
                                                            class="text-green-600 hover:text-green-800 text-sm">
                                                        üìÖ
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDashboardTab() {
            const reminderStats = updateReminderStats();
            
            return `
                <div class="tab-content active" id="dashboardContent">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Dashboard de Estoque</h2>
                    
                    <!-- Cards de Estat√≠sticas -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Total Produtos</div>
                            <div class="text-2xl font-bold text-red-600">${state.stats.total}</div>
                            <div class="text-xs text-gray-400">itens no sistema</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Valor Estoque</div>
                            <div class="text-2xl font-bold text-green-600">${state.stats.inStock}</div>
                            <div class="text-xs text-gray-400">dispon√≠veis</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Lembretes</div>
                            <div class="text-2xl font-bold text-blue-600">${reminderStats.total}</div>
                            <div class="text-xs text-gray-400">${reminderStats.overdue > 0 ? `${reminderStats.overdue} atrasados` : 'em dia'}</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Movimenta√ß√µes</div>
                            <div class="text-2xl font-bold text-purple-600">${state.historyStats.today}</div>
                            <div class="text-xs text-gray-400">hoje</div>
                        </div>
                    </div>

                    <!-- Gr√°ficos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h3 class="font-bold text-gray-700 mb-4">üìç Distribui√ß√£o por Localiza√ß√£o</h3>
                            <div style="height: 300px;">
                                <canvas id="locationChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h3 class="font-bold text-gray-700 mb-4">üìä N√≠veis de Estoque</h3>
                            <div style="height: 300px;">
                                <canvas id="stockChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg p-4 shadow mb-6">
                        <h3 class="font-bold text-gray-700 mb-4">üìà Hist√≥rico de Movimenta√ß√µes</h3>
                        <div style="height: 300px;">
                            <canvas id="movementChart"></canvas>
                        </div>
                    </div>

                    <!-- Alertas e Insights -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                ‚ö†Ô∏è Alertas do Sistema
                            </h3>
                            <div class="space-y-3">
                                ${generateSystemAlerts()}
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                                üí° Insights
                            </h3>
                            <div class="space-y-3">
                                ${generateSystemInsights()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKanbanTab() {
            return `
                <div class="tab-content active" id="kanbanContent">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">üè∑Ô∏è Kanban Visual</h2>
                        <div class="text-sm text-gray-600">
                            Arraste os produtos entre colunas
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div class="kanban-column bg-red-50" data-location="mostruario" id="kanban-mostruario" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üé® Mostru√°rio</h3>
                            <!-- Cards ser√£o inseridos aqui -->
                        </div>
                        <div class="kanban-column bg-green-50" data-location="embalado" id="kanban-embalado" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üì¶ Embalado</h3>
                        </div>
                        <div class="kanban-column bg-blue-50" data-location="frentedeloja" id="kanban-frentedeloja" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üè™ Frente de Loja</h3>
                        </div>
                        <div class="kanban-column bg-purple-50" data-location="separadocd" id="kanban-separadocd" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üè≠ CD</h3>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="kanban-column bg-yellow-50" data-location="montagem" id="kanban-montagem" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üîß Montagem</h3>
                        </div>
                        <div class="kanban-column bg-pink-50" data-location="assistencia" id="kanban-assistencia" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üî® Assist√™ncia</h3>
                        </div>
                        <div class="kanban-column bg-gray-100" data-location="outros" id="kanban-outros" ondrop="dropProduct(event)" ondragover="allowDrop(event)">
                            <h3 class="font-bold text-gray-700 mb-3 text-center">üìÅ Outros</h3>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRemindersTab() {
            const reminderStats = updateReminderStats();
            
            return `
                <div class="tab-content active" id="remindersContent">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">üìÖ Sistema de Lembretes</h2>
                            <p class="text-gray-600">Gerencie entregas, compromissos e tarefas</p>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="openNewReminderModal()"
                                    class="btn-primary px-6 py-2 rounded-lg">
                                ‚ûï Novo Lembrete
                            </button>
                            <button onclick="shareRemindersReport()"
                                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                                üì± Compartilhar
                            </button>
                        </div>
                    </div>

                    <!-- Stats dos Lembretes -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Total</div>
                            <div class="text-2xl font-bold text-blue-600">${reminderStats.total}</div>
                            <div class="text-xs text-gray-400">lembretes</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Pendentes</div>
                            <div class="text-2xl font-bold text-yellow-600">${reminderStats.pending}</div>
                            <div class="text-xs text-gray-400">aguardando</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Hoje</div>
                            <div class="text-2xl font-bold text-green-600">${reminderStats.today}</div>
                            <div class="text-xs text-gray-400">para hoje</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Atrasados</div>
                            <div class="text-2xl font-bold text-red-600">${reminderStats.overdue}</div>
                            <div class="text-xs text-gray-400">aten√ß√£o!</div>
                        </div>
                    </div>

                    <!-- Calend√°rio -->
                    <div class="bg-white rounded-lg p-4 shadow mb-6">
                        <h3 class="font-bold text-gray-700 mb-4">üóìÔ∏è Calend√°rio de Entregas</h3>
                        <div id="reminderCalendar"></div>
                    </div>

                    <!-- Kanban dos Lembretes -->
                    <div class="bg-white rounded-lg p-4 shadow mb-6">
                        <h3 class="font-bold text-gray-700 mb-4">üìã Quadro Kanban</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="kanban-column" data-status="pending" id="kanban-pending" ondrop="dropReminder(event)" ondragover="allowDrop(event)">
                                <h4 class="font-bold text-gray-700 mb-3 text-center">‚è≥ Pendentes</h4>
                            </div>
                            <div class="kanban-column" data-status="in-progress" id="kanban-in-progress" ondrop="dropReminder(event)" ondragover="allowDrop(event)">
                                <h4 class="font-bold text-gray-700 mb-3 text-center">üöÄ Em Andamento</h4>
                            </div>
                            <div class="kanban-column" data-status="completed" id="kanban-completed" ondrop="dropReminder(event)" ondragover="allowDrop(event)">
                                <h4 class="font-bold text-gray-700 mb-3 text-center">‚úÖ Conclu√≠dos</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Lembretes Atrasados -->
                    ${reminderStats.overdue > 0 ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-red-700 mb-3 flex items-center gap-2">
                                ‚ö†Ô∏è Lembretes Atrasados
                            </h4>
                            <div class="space-y-2">
                                ${state.reminders
                                    .filter(r => {
                                        if (!r.dueDate || r.status === 'completed') return false;
                                        return new Date(r.dueDate) < new Date();
                                    })
                                    .map(reminder => `
                                        <div class="bg-white p-3 rounded border border-red-200">
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <span class="font-medium">${reminder.title}</span>
                                                    <span class="text-sm text-gray-600 ml-2">- ${reminder.client || 'Sem cliente'}</span>
                                                </div>
                                                <button onclick="changeReminderStatus('${reminder.id}', 'in-progress')"
                                                        class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded">
                                                    Iniciar
                                                </button>
                                            </div>
                                            <div class="text-sm text-gray-500 mt-1">
                                                Vencimento: ${formatDate(reminder.dueDate)}
                                            </div>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderScannerTab() {
            return `
                <div class="tab-content active" id="scannerContent">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">üîç Scanner de QR Codes</h2>
                            <p class="text-gray-600">Escaneie c√≥digos de produtos para ver detalhes</p>
                        </div>
                        <div class="flex gap-3">
                            <button id="start-scanner"
                                    class="btn-primary px-6 py-2 rounded-lg">
                                ‚ñ∂Ô∏è Iniciar Scanner
                            </button>
                            <button id="stop-scanner"
                                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg"
                                    style="display: none;">
                                    ‚èπÔ∏è Parar Scanner
                            </button>
                        </div>
                    </div>

                    <!-- √Årea do Scanner -->
                    <div class="bg-white rounded-lg p-4 shadow mb-6">
                        <div id="qr-scanner-container" class="text-center">
                            <p class="text-gray-500 py-12">Clique em "Iniciar Scanner" para come√ßar</p>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <p class="text-sm text-gray-600 mb-2">
                                üì± Use a c√¢mera do seu dispositivo para escanear QR Codes de produtos
                            </p>
                            <div class="inline-block bg-gray-100 px-4 py-2 rounded-lg">
                                <span class="text-gray-700">üéØ Aponte para o QR Code</span>
                            </div>
                        </div>
                    </div>

                    <!-- Como usar -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                üñ®Ô∏è Imprimir QR Codes
                            </h4>
                            <p class="text-gray-600 mb-3">
                                Para cada produto, voc√™ pode gerar e imprimir um QR Code.
                            </p>
                            <button onclick="showQRCodePrintGuide()"
                                    class="text-blue-600 hover:text-blue-800">
                                Ver guia de impress√£o ‚Üí
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 shadow">
                            <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                                üì± Compartilhar no WhatsApp
                            </h4>
                            <p class="text-gray-600 mb-3">
                                Envie alertas de estoque diretamente pelo WhatsApp.
                            </p>
                            <button onclick="showWhatsAppIntegrationGuide()"
                                    class="text-green-600 hover:text-green-800">
                                Configurar integra√ß√£o ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderHistoryTab() {
            // Conte√∫do original do hist√≥rico
            return `
                <div class="tab-content active" id="historicoContent">
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Hoje</div>
                            <div class="text-2xl font-bold text-blue-600">${state.historyStats.today}</div>
                            <div class="text-xs text-gray-400">mudan√ßas</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Adicionados</div>
                            <div class="text-2xl font-bold text-green-600">${state.historyStats.added}</div>
                            <div class="text-xs text-gray-400">produtos</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Removidos</div>
                            <div class="text-2xl font-bold text-red-600">${state.historyStats.removed}</div>
                            <div class="text-xs text-gray-400">produtos</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Modificados</div>
                            <div class="text-2xl font-bold text-orange-600">${state.historyStats.modified}</div>
                            <div class="text-xs text-gray-400">produtos</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Estoque +</div>
                            <div class="text-2xl font-bold text-teal-600">${state.historyStats.stockUp || 0}</div>
                            <div class="text-xs text-gray-400">aumentos</div>
                        </div>
                        <div class="stat-card bg-white rounded-lg p-4 shadow">
                            <div class="text-gray-500 text-sm font-medium">Estoque -</div>
                            <div class="text-2xl font-bold text-pink-600">${state.historyStats.stockDown || 0}</div>
                            <div class="text-xs text-gray-400">redu√ß√µes</div>
                        </div>
                    </div>

                    <!-- Conte√∫do original do hist√≥rico continua... -->
                </div>
            `;
        }

        function renderTabContent() {
            // Inicializar componentes espec√≠ficos de cada aba
            switch(state.currentTab) {
                case 'dashboard':
                    setTimeout(initCharts, 100);
                    break;
                case 'kanban':
                    setTimeout(initKanban, 100);
                    break;
                case 'lembretes':
                    setTimeout(() => {
                        if (!state.calendar) initCalendar();
                        updateRemindersDisplay();
                    }, 100);
                    break;
                case 'scanner':
                    setTimeout(initScanner, 100);
                    break;
            }
        }

        // ==================== üöÄ INICIALIZA√á√ÉO ====================

        async function initApp() {
            console.log('üöÄ Iniciando sistema completo...');
            
            // Carregar dados iniciais
            await syncWithSheet();
            
            // Inicializar sistemas
            initReminders();
            
            // Configurar auto-refresh
            if (state.autoRefresh) {
                state.syncInterval = setInterval(() => {
                    syncWithSheet(true);
                }, AUTO_REFRESH_INTERVAL);
            }
            
            if (!state.connectionError) {
                showNotification('‚úÖ Sistema completo carregado!', 'success');
            }
        }

        // ==================== üéØ FUN√á√ïES DE UTILIDADE ====================

        function saveCurrentFocus() {
            const activeElement = document.activeElement;
            if (activeElement && activeElement.id) {
                lastFocusedElementId = activeElement.id;
            }
        }

        function restoreFocus() {
            if (lastFocusedElementId) {
                setTimeout(() => {
                    const element = document.getElementById(lastFocusedElementId);
                    if (element) {
                        element.focus();
                        if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                            const length = element.value.length;
                            element.setSelectionRange(length, length);
                        }
                    }
                }, 10);
            }
        }

        function switchTab(tabName) {
            state.currentTab = tabName;
            render();
        }

        // Fun√ß√µes auxiliares existentes...
        function getTimeSinceUpdate() {
            if (!state.lastUpdate) return 'Nunca';
            const diff = Date.now() - state.lastUpdate.getTime();
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            if (minutes < 60) return `${minutes}min atr√°s`;
            if (hours < 24) return `${hours}h atr√°s`;
            return state.lastUpdate.toLocaleDateString('pt-BR');
        }

        function formatObservacoes(observacoes) {
            if (!observacoes || observacoes.trim() === '') {
                return '<span class="status-tag status-default">Sem informa√ß√µes</span>';
            }
            // Implementa√ß√£o original mantida
            return observacoes.split(/[,\.]| e |\//)
                .filter(p => p.trim())
                .map(parte => {
                    const texto = parte.trim().toLowerCase();
                    let statusClass = 'status-default';
                    const statusMap = {
                        'status-mostruario': ['mostruario', 'mostru√°rio', 'amostra', 'vitrine'],
                        'status-embalado': ['embalado', 'caixa', 'box', 'lacrado'],
                        'status-frentedeloja': ['frente', 'loja', 'vitrine', 'exposi', 'prateleira'],
                        'status-separadocd': ['separado', 'cd', 'centro', 'distribui', 'deposito', 'dep√≥sito'],
                        'status-montagem': ['montar', 'montagem', 'montado', 'armar', 'desmontado'],
                        'status-assistencia': ['assistencia', 'assist√™ncia', 'conserto', 'reparo', 'manuten', 'defeito']
                    };
                    for (const [className, keywords] of Object.entries(statusMap)) {
                        if (keywords.some(keyword => texto.includes(keyword))) {
                            statusClass = className;
                            break;
                        }
                    }
                    return `<span class="status-tag ${statusClass}">${parte.trim()}</span>`;
                }).join(' ');
        }

        // ==================== üöÄ INICIAR APLICA√á√ÉO ====================

        initApp();
    </script>
</body>
</html>
